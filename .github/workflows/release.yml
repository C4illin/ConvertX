name: Release (ä¸€èˆ¬ç‰ˆ)

on:
  push:
    tags:
      # åªåŒ¹é…ä¸€èˆ¬ç‰ˆ tagï¼ˆä¸å« -liteï¼‰
      - "v[0-9]*.[0-9]*.[0-9]*"
      - "!v*-lite"
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.1.15) - ä¸€èˆ¬ç‰ˆ"
        required: true
        type: string

env:
  DOCKER_IMAGE: convertx/convertx-cn

jobs:
  # ==============================================================================
  # ğŸ³ Build AMD64 Imageï¼ˆåˆ†é–‹æ§‹å»ºè§£æ±ºç©ºé–“ä¸è¶³å•é¡Œï¼‰
  # ==============================================================================
  build-amd64:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write

    steps:
      # ========================================
      # ğŸ”¥ æ¥µé™ç£ç¢Ÿæ¸…ç†ï¼ˆé‡‹æ”¾ 70GB+ ç©ºé–“ï¼‰
      # ========================================
      - name: Maximize disk space (before checkout)
        run: |
          echo "ğŸ§¹ æ¥µé™ç£ç¢Ÿæ¸…ç†..."
          echo "ğŸ“Š åˆå§‹ç£ç¢Ÿç©ºé–“ï¼š"
          df -h /

          # åœæ­¢æœå‹™
          sudo systemctl stop docker containerd || true

          # ç§»é™¤å¤§å‹é è£è»Ÿé«”ï¼ˆç´„ 50-60GBï¼‰
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache /usr/share/swift /opt/microsoft || true
          sudo rm -rf /usr/local/aws-* /usr/local/julia* /usr/share/az_* /opt/az || true
          sudo rm -rf /usr/lib/google-cloud-sdk /usr/local/share/powershell || true
          sudo rm -rf /usr/share/miniconda /usr/local/go ~/go || true
          sudo rm -rf /usr/share/rust ~/.rustup ~/.cargo /usr/share/R /usr/lib/R || true
          sudo rm -rf /usr/local/share/boost /usr/local/graalvm /usr/local/.ghcup || true
          sudo rm -rf /usr/local/share/chromium || true

          # ç§»é™¤è³‡æ–™åº«
          sudo rm -rf /var/lib/mysql /var/lib/postgresql /var/lib/mongodb || true

          # ç§»é™¤ snap/flatpak
          sudo rm -rf /snap /var/snap /var/lib/snapd || true

          # ç§»é™¤æ–‡æª”å’Œ locale
          sudo rm -rf /usr/share/doc /usr/share/man /usr/share/locale || true
          sudo rm -rf /usr/share/icons /usr/share/fonts /usr/share/help || true

          # ç§»é™¤ imagegenerationï¼ˆGitHub runner å°ˆç”¨ï¼‰
          sudo rm -rf /imagegeneration /opt/actionarchivecache || true

          # æ¸…ç† cache
          sudo apt-get clean && sudo apt-get autoremove -y || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/* /tmp/* || true

          # å®Œå…¨é‡ç½® Docker
          sudo rm -rf /var/lib/docker /var/lib/containerd || true
          sudo mkdir -p /var/lib/docker /var/lib/containerd
          sudo systemctl start containerd docker || true

          echo "ğŸ“Š æ¸…ç†å¾Œç£ç¢Ÿç©ºé–“ï¼š"
          df -h /

          # é©—è­‰ç©ºé–“
          AVAIL_GB=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
          echo "å¯ç”¨ç©ºé–“: ${AVAIL_GB}GB"
          [ "$AVAIL_GB" -ge 50 ] && echo "âœ… ç©ºé–“å……è¶³" || echo "âš ï¸ ç©ºé–“å¯èƒ½ä¸è¶³"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          # é™åˆ¶ BuildKit ä½¿ç”¨çš„ç£ç¢Ÿç©ºé–“
          buildkitd-config-inline: |
            [worker.oci]
              max-parallelism = 1
              gc = true
              gckeepstorage = 5000000000
            [worker.containerd]
              gc = true
              gckeepstorage = 5000000000

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: "ğŸ“¦ é–‹å§‹æ§‹å»º AMD64 Image"
        run: |
          echo "========================================"
          echo "ğŸ“¦ é–‹å§‹æ§‹å»º AMD64 Docker Image..."
          echo "========================================"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}-amd64"
          echo "Platform: linux/amd64"
          echo ""
          echo "âš ï¸  æ³¨æ„ï¼šImage å¤§å°ç´„ 10-14GB"
          echo "âš ï¸  æ§‹å»º + ä¸Šå‚³å¯èƒ½éœ€è¦ 1-3 å°æ™‚"
          echo "âš ï¸  'exporting layers' éšæ®µæ˜¯ä¸Šå‚³åˆ° Docker Hubï¼Œè«‹è€å¿ƒç­‰å¾…"
          echo "========================================"
          echo "é–‹å§‹æ™‚é–“: $(date)"
          echo "========================================"

      - name: "ğŸ³ Build and push AMD64 image"
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}-amd64
          platforms: linux/amd64
          # åªä½¿ç”¨ cache-fromï¼Œä¸ä½¿ç”¨ cache-toï¼ˆé¿å…é¡å¤–ä¸Šå‚³æ™‚é–“ï¼‰
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache-amd64
          provenance: false
          sbom: false
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: "âœ… AMD64 Image æ§‹å»ºå®Œæˆ"
        run: |
          echo "========================================"
          echo "ğŸš€ AMD64 Image å·²æˆåŠŸæ¨é€åˆ° Docker Hub"
          echo "========================================"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}-amd64"
          echo "Platform: linux/amd64"
          echo "Time: $(date)"
          echo "========================================"

  # ==============================================================================
  # ğŸ³ Build ARM64 Imageï¼ˆåˆ†é–‹æ§‹å»ºè§£æ±ºç©ºé–“ä¸è¶³å•é¡Œï¼‰
  # ==============================================================================
  build-arm64:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write

    steps:
      # ========================================
      # ğŸ”¥ æ¥µé™ç£ç¢Ÿæ¸…ç†ï¼ˆé‡‹æ”¾ 70GB+ ç©ºé–“ï¼‰
      # ========================================
      - name: Maximize disk space (before checkout)
        run: |
          echo "ğŸ§¹ æ¥µé™ç£ç¢Ÿæ¸…ç†..."
          echo "ğŸ“Š åˆå§‹ç£ç¢Ÿç©ºé–“ï¼š"
          df -h /

          # åœæ­¢æœå‹™
          sudo systemctl stop docker containerd || true

          # ç§»é™¤å¤§å‹é è£è»Ÿé«”ï¼ˆç´„ 50-60GBï¼‰
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache /usr/share/swift /opt/microsoft || true
          sudo rm -rf /usr/local/aws-* /usr/local/julia* /usr/share/az_* /opt/az || true
          sudo rm -rf /usr/lib/google-cloud-sdk /usr/local/share/powershell || true
          sudo rm -rf /usr/share/miniconda /usr/local/go ~/go || true
          sudo rm -rf /usr/share/rust ~/.rustup ~/.cargo /usr/share/R /usr/lib/R || true
          sudo rm -rf /usr/local/share/boost /usr/local/graalvm /usr/local/.ghcup || true
          sudo rm -rf /usr/local/share/chromium || true

          # ç§»é™¤è³‡æ–™åº«
          sudo rm -rf /var/lib/mysql /var/lib/postgresql /var/lib/mongodb || true

          # ç§»é™¤ snap/flatpak
          sudo rm -rf /snap /var/snap /var/lib/snapd || true

          # ç§»é™¤æ–‡æª”å’Œ locale
          sudo rm -rf /usr/share/doc /usr/share/man /usr/share/locale || true
          sudo rm -rf /usr/share/icons /usr/share/fonts /usr/share/help || true

          # ç§»é™¤ imagegenerationï¼ˆGitHub runner å°ˆç”¨ï¼‰
          sudo rm -rf /imagegeneration /opt/actionarchivecache || true

          # æ¸…ç† cache
          sudo apt-get clean && sudo apt-get autoremove -y || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/* /tmp/* || true

          # å®Œå…¨é‡ç½® Docker
          sudo rm -rf /var/lib/docker /var/lib/containerd || true
          sudo mkdir -p /var/lib/docker /var/lib/containerd
          sudo systemctl start containerd docker || true

          echo "ğŸ“Š æ¸…ç†å¾Œç£ç¢Ÿç©ºé–“ï¼š"
          df -h /

          # é©—è­‰ç©ºé–“
          AVAIL_GB=$(df / | tail -1 | awk '{print int($4/1024/1024)}')
          echo "å¯ç”¨ç©ºé–“: ${AVAIL_GB}GB"
          [ "$AVAIL_GB" -ge 50 ] && echo "âœ… ç©ºé–“å……è¶³" || echo "âš ï¸ ç©ºé–“å¯èƒ½ä¸è¶³"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          # é™åˆ¶ BuildKit ä½¿ç”¨çš„ç£ç¢Ÿç©ºé–“
          buildkitd-config-inline: |
            [worker.oci]
              max-parallelism = 1
              gc = true
              gckeepstorage = 5000000000
            [worker.containerd]
              gc = true
              gckeepstorage = 5000000000

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: "ğŸ“¦ é–‹å§‹æ§‹å»º ARM64 Image"
        run: |
          echo "========================================"
          echo "ğŸ“¦ é–‹å§‹æ§‹å»º ARM64 Docker Image..."
          echo "========================================"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}-arm64"
          echo "Platform: linux/arm64 (via QEMU emulation)"
          echo ""
          echo "âš ï¸  æ³¨æ„ï¼šImage å¤§å°ç´„ 10-14GB"
          echo "âš ï¸  ARM64 ä½¿ç”¨ QEMU æ¨¡æ“¬ï¼Œæ§‹å»ºæ™‚é–“æ›´é•·"
          echo "âš ï¸  æ§‹å»º + ä¸Šå‚³å¯èƒ½éœ€è¦ 2-4 å°æ™‚"
          echo "âš ï¸  'exporting layers' éšæ®µæ˜¯ä¸Šå‚³åˆ° Docker Hubï¼Œè«‹è€å¿ƒç­‰å¾…"
          echo "========================================"
          echo "é–‹å§‹æ™‚é–“: $(date)"
          echo "========================================"

      - name: "ğŸ³ Build and push ARM64 image"
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}-arm64
          platforms: linux/arm64
          # åªä½¿ç”¨ cache-fromï¼Œä¸ä½¿ç”¨ cache-toï¼ˆé¿å…é¡å¤–ä¸Šå‚³æ™‚é–“ï¼‰
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache-arm64
          provenance: false
          sbom: false
          build-args: |
            BUILDKIT_INLINE_CACHE=1
      - name: "âœ… ARM64 Image æ§‹å»ºå®Œæˆ"
        run: |
          echo "========================================"
          echo "ğŸš€ ARM64 Image å·²æˆåŠŸæ¨é€åˆ° Docker Hub"
          echo "========================================"
          echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}-arm64"
          echo "Platform: linux/arm64"
          echo "Time: $(date)"
          echo "========================================"

  # ==============================================================================
  # ğŸ³ Create Multi-Arch Manifestï¼ˆåˆä½µå…©å€‹æ¶æ§‹ï¼‰
  # ==============================================================================
  create-manifest:
    runs-on: ubuntu-latest
    needs: [build-amd64, build-arm64]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          VERSION="${{ steps.tag.outputs.version }}"
          IMAGE="${{ env.DOCKER_IMAGE }}"

          echo "ğŸ”„ å‰µå»º multi-arch manifest..."

          # å‰µå»ºç‰ˆæœ¬ tag çš„ manifest
          docker buildx imagetools create -t ${IMAGE}:${VERSION} \
            ${IMAGE}:${VERSION}-amd64 \
            ${IMAGE}:${VERSION}-arm64

          # å‰µå»º latest tag çš„ manifest
          docker buildx imagetools create -t ${IMAGE}:latest \
            ${IMAGE}:${VERSION}-amd64 \
            ${IMAGE}:${VERSION}-arm64

          echo "âœ… Multi-arch manifest å‰µå»ºå®Œæˆ"

          # é©—è­‰ manifest
          echo "ğŸ” é©—è­‰ manifest..."
          docker buildx imagetools inspect ${IMAGE}:${VERSION}
          docker buildx imagetools inspect ${IMAGE}:latest

      - name: Docker Build Summary
        run: |
          echo "## ğŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ env.DOCKER_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # ğŸ” Verify Docker Imageï¼ˆæ¨¡å‹é©—è­‰ + Headless é©—è­‰ï¼‰
  # ==============================================================================
  verify-image:
    name: Verify Docker Image
    runs-on: ubuntu-24.04
    needs: create-manifest
    timeout-minutes: 45

    steps:
      # ========================================
      # ğŸ”¥ ç£ç¢Ÿæ¸…ç†ï¼ˆæ‹‰å–å¤§å‹ image éœ€è¦ç©ºé–“ï¼‰
      # ========================================
      - name: Free disk space for image pull
        run: |
          echo "ğŸ§¹ æ¸…ç†ç£ç¢Ÿç©ºé–“ä»¥æ‹‰å–å¤§å‹ Docker image..."
          df -h /

          # ç§»é™¤å¤§å‹é è£è»Ÿé«”
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache /usr/share/swift /opt/microsoft || true
          sudo rm -rf /usr/local/aws-* /usr/local/julia* /usr/share/az_* || true
          sudo rm -rf /usr/lib/google-cloud-sdk /usr/local/share/powershell || true
          sudo rm -rf /usr/share/miniconda /usr/local/go ~/go || true
          sudo rm -rf /usr/share/rust ~/.rustup ~/.cargo || true

          # æ¸…ç† apt cache
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

          echo "ğŸ“Š æ¸…ç†å¾Œç£ç¢Ÿç©ºé–“ï¼š"
          df -h /

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Pull Docker image
        timeout-minutes: 25
        run: |
          echo "ğŸ“¥ Pulling Docker imageï¼ˆå¤§å‹ imageï¼Œå¯èƒ½éœ€è¦ 10-20 åˆ†é˜ï¼‰..."
          echo "Image size: ~8-12 GBï¼ˆå«é ä¸‹è¼‰æ¨¡å‹ï¼‰"
          docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}

      # ========================================
      # é©—è­‰ 1: å·¥å…·å­˜åœ¨æ€§ + ç‰ˆæœ¬æª¢æŸ¥ï¼ˆä½¿ç”¨ xvfb è§£æ±º GUI å•é¡Œï¼‰
      # ========================================
      - name: "ğŸ” Tools & Model Verification"
        timeout-minutes: 8
        continue-on-error: true # ğŸ”¥ ç‰ˆæœ¬æª¢æŸ¥å¤±æ•—ä¸æ‡‰é˜»æ“‹å¾ŒçºŒ E2E æ¸¬è©¦
        run: |
          echo "========================================"
          echo "ğŸ” å·¥å…·å­˜åœ¨æ€§ + æ¨¡å‹é©—è­‰"
          echo "========================================"

          IMAGE="${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}"

          # ğŸ”¥ é—œéµä¿®å¾©ï¼š
          #   1. ç‚ºæ¯å€‹ GUI å·¥å…·ç‰ˆæœ¬æª¢æŸ¥æ·»åŠ  timeout é˜²æ­¢ç„¡é™æ›èµ·
          #   2. ä½¿ç”¨ timeout å‘½ä»¤é™åˆ¶æ¯å€‹å·¥å…·çš„åŸ·è¡Œæ™‚é–“
          #   3. å¢åŠ æ•´é«” timeout-minutes å¾ 5 åˆ° 8 åˆ†é˜
          docker run --rm "${IMAGE}" sh -c '
            echo ""
            echo "========================================"
            echo "ğŸ”§ CLI å·¥å…·ç‰ˆæœ¬æª¢æŸ¥"
            echo "========================================"
            
            # ç´” CLI å·¥å…· - ç›´æ¥åŸ·è¡Œ
            echo "ConvertX $(cat /app/package.json 2>/dev/null | grep version | head -1 | cut -d\" -f4)"
            echo "Bun $(bun --version 2>/dev/null || echo "N/A")"
            pandoc --version 2>/dev/null | head -1 || echo "pandoc: N/A"
            ffmpeg -version 2>/dev/null | head -1 || echo "ffmpeg: N/A"
            tesseract --version 2>&1 | head -1 || echo "tesseract: N/A"
            vips --version 2>/dev/null || echo "vips: N/A"
            gm -version 2>/dev/null | head -1 || echo "GraphicsMagick: N/A"
            resvg --version 2>/dev/null || echo "resvg: N/A"
            potrace --version 2>/dev/null | head -1 || echo "potrace: N/A"
            dasel --version 2>/dev/null || echo "dasel: N/A"
            djxl --version 2>&1 | head -1 || echo "djxl: N/A"
            deark -version 2>/dev/null | head -1 || echo "deark: N/A"
            
            echo ""
            echo "========================================"
            echo "ğŸ–¥ï¸ GUI å·¥å…·ç‰ˆæœ¬æª¢æŸ¥ï¼ˆä½¿ç”¨ xvfb-run + timeoutï¼‰"
            echo "========================================"
            
            # GUI å·¥å…· - ä½¿ç”¨ timeout + xvfb-run é˜²æ­¢æ›èµ·
            # timeout 60 ç§’ï¼Œè¶…éå°±è·³éè©²å·¥å…·
            echo -n "Inkscape: "
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" inkscape --version 2>/dev/null || echo "N/A (timeout or error)"
            
            echo -n "Calibre: "
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" ebook-convert --version 2>/dev/null | head -1 || echo "N/A (timeout or error)"
            
            echo -n "LibreOffice: "
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" libreoffice --version 2>/dev/null || echo "N/A (timeout or error)"
            
            echo ""
            echo "========================================"
            echo "ğŸ¤– æ¨¡å‹ç›®éŒ„æª¢æŸ¥"
            echo "========================================"
            
            echo -n "  HuggingFace cache: "
            [ -d "/root/.cache/huggingface" ] && echo "âœ… å­˜åœ¨" || echo "âš ï¸ ä¸å­˜åœ¨"
            
            echo -n "  ModelScope cache:  "
            [ -d "/root/.cache/modelscope" ] && echo "âœ… å­˜åœ¨" || echo "âš ï¸ ä¸å­˜åœ¨"
            
            echo -n "  BabelDOC cache:    "
            [ -d "/root/.cache/babeldoc" ] && echo "âœ… å­˜åœ¨" || echo "âš ï¸ ä¸å­˜åœ¨"

            echo ""
            echo "========================================"
            echo "âœ… å·¥å…·é©—è­‰å®Œæˆï¼"
            echo "========================================"
          '

      # ========================================
      # é©—è­‰ 2: å•Ÿå‹•å®¹å™¨ä¸¦æª¢æŸ¥å¥åº·ç‹€æ…‹
      # ========================================
      - name: "âš™ï¸ Start Container & Health Check"
        timeout-minutes: 3
        run: |
          echo "========================================"
          echo "âš™ï¸ å•Ÿå‹•å®¹å™¨ä¸¦æª¢æŸ¥å¥åº·ç‹€æ…‹"
          echo "========================================"

          IMAGE="${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}"

          # å•Ÿå‹•å®¹å™¨
          echo "ğŸš€ å•Ÿå‹•å®¹å™¨..."
          docker run -d --name verify-test -p 3000:3000 "${IMAGE}"

          # ç­‰å¾…å•Ÿå‹•
          echo "â³ ç­‰å¾…å®¹å™¨å•Ÿå‹•..."
          for i in {1..90}; do
            if docker exec verify-test curl -sf http://localhost:3000/healthcheck > /dev/null 2>&1; then
              echo "âœ… å®¹å™¨åœ¨ ${i} ç§’å…§å•Ÿå‹•æˆåŠŸ"
              break
            fi
            if [ $i -eq 90 ]; then
              echo "âŒ å®¹å™¨å•Ÿå‹•è¶…æ™‚"
              docker logs verify-test
              docker rm -f verify-test
              exit 1
            fi
            sleep 1
          done

          # é¡¯ç¤ºå®¹å™¨æ—¥èªŒ
          echo ""
          echo "ğŸ“‹ å®¹å™¨å•Ÿå‹•æ—¥èªŒï¼š"
          docker logs verify-test 2>&1 | tail -20

          echo ""
          echo "========================================"
          echo "âœ… å®¹å™¨å¥åº·æª¢æŸ¥é€šéï¼"
          echo "========================================"

      # ========================================
      # é©—è­‰ 3: E2E è½‰æ›æ¸¬è©¦ï¼ˆæ¨¡æ“¬çœŸå¯¦ç”¨æˆ¶æ“ä½œï¼‰
      # ========================================
      - name: "ğŸ§ª E2E Tests in Container"
        timeout-minutes: 15
        run: |
          echo "========================================"
          echo "ğŸ§ª E2E è½‰æ›æ¸¬è©¦ï¼ˆæ¨¡æ“¬çœŸå¯¦ç”¨æˆ¶æ“ä½œï¼‰"
          echo "========================================"

          # é¦–å…ˆç¢ºèªå®¹å™¨å¥åº·
          echo "ğŸ” ç¢ºèªæœå‹™å¥åº·ç‹€æ…‹..."
          for i in {1..30}; do
            if curl -sf http://localhost:3000/healthcheck > /dev/null 2>&1; then
              echo "âœ… æœå‹™å¥åº·"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ æœå‹™ä¸å¥åº·"
              docker logs verify-test 2>&1 | tail -30
              exit 1
            fi
            sleep 1
          done

          # å®šç¾©æ¸¬è©¦çµæœè¿½è¹¤
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0

          run_test() {
            local name="$1"
            local cmd="$2"
            TOTAL_TESTS=$((TOTAL_TESTS + 1))
            echo ""
            echo "ğŸ”„ æ¸¬è©¦: $name"
            if docker exec verify-test bash -c "$cmd" 2>&1; then
              echo "âœ… $name æˆåŠŸ"
              PASSED_TESTS=$((PASSED_TESTS + 1))
              return 0
            else
              echo "âŒ $name å¤±æ•—"
              FAILED_TESTS=$((FAILED_TESTS + 1))
              return 1
            fi
          }

          echo ""
          echo "========================================"
          echo "ğŸ“‹ æ¸¬è©¦å·¥å…·è½‰æ›åŠŸèƒ½"
          echo "========================================"

          # 1. Pandoc: Markdown â†’ HTML (ç´” CLI)
          run_test "Pandoc: Markdown â†’ HTML" '
            echo "# Test Document" > /tmp/test.md
            echo "" >> /tmp/test.md
            echo "Hello **world**" >> /tmp/test.md
            pandoc /tmp/test.md -o /tmp/test.html
            [ -s /tmp/test.html ] && cat /tmp/test.html
          ' || true

          # 2. FFmpeg: éŸ³é »ç”Ÿæˆ (ç´” CLI)
          run_test "FFmpeg: éŸ³é »ç”Ÿæˆ" '
            ffmpeg -f lavfi -i "sine=frequency=440:duration=1" -y /tmp/test.wav 2>/dev/null
            [ -s /tmp/test.wav ] && ls -la /tmp/test.wav
          ' || true

          # 3. FFmpeg: å½±ç‰‡ç”Ÿæˆ (ç´” CLI)
          run_test "FFmpeg: å½±ç‰‡ç”Ÿæˆ" '
            ffmpeg -f lavfi -i color=c=blue:s=320x240:d=1 -y /tmp/test_video.mp4 2>/dev/null
            [ -s /tmp/test_video.mp4 ] && ls -la /tmp/test_video.mp4
          ' || true

          # 4. Resvg: SVG â†’ PNG (ç´” CLI)
          run_test "Resvg: SVG â†’ PNG" '
            echo "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"50\"><rect fill=\"green\" width=\"50\" height=\"50\"/></svg>" > /tmp/resvg.svg
            resvg /tmp/resvg.svg /tmp/resvg.png 2>/dev/null
            [ -s /tmp/resvg.png ] && ls -la /tmp/resvg.png
          ' || true

          # 5. Dasel: JSON â†’ YAML (ç´” CLI)
          run_test "Dasel: JSON â†’ YAML" '
            echo "{\"name\":\"test\",\"value\":123}" > /tmp/test.json
            dasel -f /tmp/test.json -w yaml > /tmp/test.yaml 2>/dev/null
            [ -s /tmp/test.yaml ] && cat /tmp/test.yaml
          ' || true

          # 6. Tesseract: OCR (éœ€è¦ ImageMagick ç”Ÿæˆæ¸¬è©¦åœ–ç‰‡)
          run_test "Tesseract: OCR" '
            convert -size 200x50 xc:white -font DejaVu-Sans -pointsize 20 -fill black -annotate +10+35 "Hello OCR" /tmp/ocr.png 2>/dev/null
            tesseract /tmp/ocr.png /tmp/ocr 2>/dev/null
            [ -s /tmp/ocr.txt ] && cat /tmp/ocr.txt
          ' || true

          # 7. Inkscape: SVG â†’ PNG (éœ€è¦ xvfb)
          run_test "Inkscape: SVG â†’ PNG" '
            echo "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"><circle cx=\"50\" cy=\"50\" r=\"40\" fill=\"red\"/></svg>" > /tmp/ink.svg
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" inkscape --export-type=png --export-filename=/tmp/ink.png /tmp/ink.svg 2>&1 || true
            [ -s /tmp/ink.png ] && ls -la /tmp/ink.png
          ' || true

          # 8. LibreOffice: TXT â†’ PDF (éœ€è¦ xvfb)
          run_test "LibreOffice: TXT â†’ PDF" '
            echo "Test document for LibreOffice conversion" > /tmp/libre.txt
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" libreoffice --headless --convert-to pdf --outdir /tmp /tmp/libre.txt 2>&1 || true
            [ -s /tmp/libre.pdf ] && ls -la /tmp/libre.pdf
          ' || true

          # 9. Calibre: HTML â†’ EPUB (éœ€è¦ xvfb)
          run_test "Calibre: HTML â†’ EPUB" '
            echo "<!DOCTYPE html><html><body><h1>Test Book</h1><p>Content here</p></body></html>" > /tmp/book.html
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" ebook-convert /tmp/book.html /tmp/book.epub 2>&1 || true
            [ -s /tmp/book.epub ] && ls -la /tmp/book.epub
          ' || true

          echo ""
          echo "========================================"
          echo "ğŸ“‹ æ¸¬è©¦ API ç«¯é»"
          echo "========================================"

          # 10. Healthcheck API
          run_test "API: Healthcheck" '
            response=$(curl -sf http://localhost:3000/healthcheck)
            echo "Response: $response"
            [ -n "$response" ]
          ' || true

          # 11. Converters API
          run_test "API: Converters åˆ—è¡¨" '
            response=$(curl -sf http://localhost:3000/converters 2>/dev/null | head -c 500)
            echo "Response (å‰500å­—ç¬¦): $response"
            [ -n "$response" ]
          ' || true

          # 12. ä¸»é é¢
          run_test "API: ä¸»é é¢è¼‰å…¥" '
            status=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:3000/)
            echo "HTTP Status: $status"
            [ "$status" = "200" ] || [ "$status" = "302" ]
          ' || true

          # æ¸¬è©¦æ‘˜è¦
          echo ""
          echo "========================================"
          echo "ğŸ“Š E2E æ¸¬è©¦æ‘˜è¦"
          echo "========================================"
          echo "ç¸½æ¸¬è©¦æ•¸: $TOTAL_TESTS"
          echo "é€šé: $PASSED_TESTS"
          echo "å¤±æ•—: $FAILED_TESTS"
          echo "========================================"

          # è¨ˆç®—é€šéç‡
          if [ $TOTAL_TESTS -gt 0 ]; then
            PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            echo "é€šéç‡: ${PASS_RATE}%"
            
            # è‡³å°‘ 70% é€šéæ‰ç®—æˆåŠŸ
            if [ $PASS_RATE -ge 70 ]; then
              echo "âœ… E2E æ¸¬è©¦é€šé (>= 70% é€šéç‡)"
            else
              echo "âŒ E2E æ¸¬è©¦å¤±æ•— (< 70% é€šéç‡)"
              exit 1
            fi
          else
            echo "âš ï¸ æ²’æœ‰åŸ·è¡Œä»»ä½•æ¸¬è©¦"
          fi

      # ========================================
      # æ¸…ç†é©—è­‰å®¹å™¨
      # ========================================
      - name: "ğŸ§¹ Cleanup Verification Containers"
        if: always()
        run: |
          docker rm -f verify-test 2>/dev/null || true

      - name: Verification Summary
        run: |
          echo "## ğŸ” Image Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Verification Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ï¿½ Tools & Model: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ Basic Functionality: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª E2E Tests: Passed" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # ğŸ“¦ Create GitHub Release
  # ==============================================================================
  create-release:
    runs-on: ubuntu-latest
    needs: [create-manifest, verify-image]
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # No previous tag, get all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            # Get commits between previous tag and current
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD)
          fi

          # Write to file to preserve newlines
          echo "$CHANGELOG" > changelog.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.tag.outputs.version }}
          tag_name: ${{ steps.tag.outputs.version }}
          body_path: changelog.txt
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
