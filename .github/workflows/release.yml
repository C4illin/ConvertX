name: Release

on:
  push:
    tags:
      - "v*.*.*"
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.1.13)"
        required: true
        type: string

env:
  DOCKER_IMAGE: convertx/convertx-cn

jobs:
  # ==============================================================================
  # ğŸ³ Build and Push Docker Imageï¼ˆé—œéµæµç¨‹ï¼‰
  # ==============================================================================
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # æ¸…ç†ç£ç¢Ÿç©ºé–“ï¼ˆè§£æ±º no space left on deviceï¼‰
      # ========================================
      # ğŸ”¥ GitHub Actions Runner åªæœ‰ç´„ 14GB å¯ç”¨ç©ºé–“
      #    å¤§å‹æ¨¡å‹ + Multi-Arch build éœ€è¦æ¸…ç†æ›´å¤šé è£è»Ÿé«”
      # ========================================
      - name: Free disk space (aggressive)
        run: |
          echo "ğŸ§¹ Aggressive disk cleanup for large model builds..."
          echo "========================================"
          echo "ğŸ“Š åˆå§‹ç£ç¢Ÿç©ºé–“ï¼š"
          df -h /
          echo "========================================"

          # ========================================
          # ç§»é™¤å¤§å‹é è£è»Ÿé«”ï¼ˆç´„å¯é‡‹æ”¾ 30-40GBï¼‰
          # ========================================
          echo "ğŸ—‘ï¸ ç§»é™¤é è£é–‹ç™¼å·¥å…·..."

          # .NET SDKï¼ˆç´„ 2-3GBï¼‰
          sudo rm -rf /usr/share/dotnet || true

          # Android SDKï¼ˆç´„ 10-15GBï¼‰- æœ€å¤§å®—ï¼
          sudo rm -rf /usr/local/lib/android || true

          # Haskell/GHCï¼ˆç´„ 1GBï¼‰
          sudo rm -rf /opt/ghc || true

          # CodeQLï¼ˆç´„ 1GBï¼‰
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true

          # Boostï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/local/share/boost || true

          # Swiftï¼ˆç´„ 1.5GBï¼‰
          sudo rm -rf /usr/share/swift || true

          # Hosted Tool Cacheï¼ˆç´„ 5-8GBï¼‰
          sudo rm -rf /opt/hostedtoolcache || true

          # Azure CLIï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/share/az_* || true
          sudo rm -rf /opt/az || true

          # Google Cloud SDKï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/lib/google-cloud-sdk || true

          # PowerShellï¼ˆç´„ 200MBï¼‰
          sudo rm -rf /usr/local/share/powershell || true

          # Minicondaï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/share/miniconda || true

          # ========================================
          # æ¸…ç†ç³»çµ± cache
          # ========================================
          echo "ğŸ—‘ï¸ æ¸…ç†ç³»çµ± cache..."

          # apt cache
          sudo apt-get clean || true
          sudo apt-get autoremove -y || true
          sudo rm -rf /var/lib/apt/lists/* || true

          # npm/yarn global cache
          sudo rm -rf /usr/local/share/.cache || true

          # ========================================
          # æ¸…ç† Docker èˆŠè³‡æ–™
          # ========================================
          echo "ğŸ—‘ï¸ æ¸…ç† Docker cache..."
          docker system prune -af --volumes || true

          # æ¸…ç† BuildKit cache
          sudo rm -rf /var/lib/docker/buildkit || true

          echo "========================================"
          echo "ğŸ“Š æ¸…ç†å¾Œç£ç¢Ÿç©ºé–“ï¼š"
          df -h /
          echo "========================================"

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # ========================================
      # è¨­å®š Docker Buildxï¼ˆé‡å°å¤§å‹æ¨¡å‹å„ªåŒ–ï¼‰
      # ========================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # ğŸ”¥ ä½¿ç”¨ docker-container driver ä»¥ç²å¾—æ›´å¥½çš„ cache æ§åˆ¶
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # Build and Pushï¼ˆé‡å°å¤§å‹æ¨¡å‹å„ªåŒ–ï¼‰
      # ========================================
      # ğŸ”¥ æ³¨æ„äº‹é …ï¼š
      #   - ä½¿ç”¨ registry cache è€Œé GHA cacheï¼ˆé¿å… 10GB é™åˆ¶ï¼‰
      #   - å•Ÿç”¨ zstd compression æ¸›å°‘å‚³è¼¸é‡å’Œå„²å­˜ç©ºé–“
      #   - Multi-arch build éœ€è¦æ›´å¤šç£ç¢Ÿç©ºé–“ï¼Œå·²åœ¨ä¸Šæ–¹æ¸…ç†
      # ========================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}
            ${{ env.DOCKER_IMAGE }}:latest
          platforms: linux/amd64,linux/arm64
          # ğŸ”¥ ä½¿ç”¨ registry cache å–ä»£ GHA cache
          # registry cache æ²’æœ‰ 10GB é™åˆ¶ï¼Œæ›´é©åˆå¤§å‹æ¨¡å‹
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max,compression=zstd
          # å•Ÿç”¨å£“ç¸®æ¸›å°‘ image å¤§å°
          outputs: type=image,compression=zstd,compression-level=3
          # è¨­å®š build åƒæ•¸
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Docker Build Summary
        run: |
          echo "## ğŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ env.DOCKER_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # ğŸ” Verify Docker Imageï¼ˆæ¨¡å‹é©—è­‰ + Headless é©—è­‰ï¼‰
  # ==============================================================================
  verify-image:
    name: Verify Docker Image
    runs-on: ubuntu-latest
    needs: build-and-push
    timeout-minutes: 45

    steps:
      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Pull Docker image
        timeout-minutes: 25
        run: |
          echo "ğŸ“¥ Pulling Docker imageï¼ˆå¤§å‹ imageï¼Œå¯èƒ½éœ€è¦ 10-20 åˆ†é˜ï¼‰..."
          echo "Image size: ~8-12 GBï¼ˆå«é ä¸‹è¼‰æ¨¡å‹ï¼‰"
          docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}

      # ========================================
      # é©—è­‰ 1: å·¥å…·å­˜åœ¨æ€§ + ç‰ˆæœ¬æª¢æŸ¥ï¼ˆä½¿ç”¨ xvfb è§£æ±º GUI å•é¡Œï¼‰
      # ========================================
      - name: "ğŸ” Tools & Model Verification"
        timeout-minutes: 8
        continue-on-error: true # ğŸ”¥ ç‰ˆæœ¬æª¢æŸ¥å¤±æ•—ä¸æ‡‰é˜»æ“‹å¾ŒçºŒ E2E æ¸¬è©¦
        run: |
          echo "========================================"
          echo "ğŸ” å·¥å…·å­˜åœ¨æ€§ + æ¨¡å‹é©—è­‰"
          echo "========================================"

          IMAGE="${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}"

          # ğŸ”¥ é—œéµä¿®å¾©ï¼š
          #   1. ç‚ºæ¯å€‹ GUI å·¥å…·ç‰ˆæœ¬æª¢æŸ¥æ·»åŠ  timeout é˜²æ­¢ç„¡é™æ›èµ·
          #   2. ä½¿ç”¨ timeout å‘½ä»¤é™åˆ¶æ¯å€‹å·¥å…·çš„åŸ·è¡Œæ™‚é–“
          #   3. å¢åŠ æ•´é«” timeout-minutes å¾ 5 åˆ° 8 åˆ†é˜
          docker run --rm "${IMAGE}" sh -c '
            echo ""
            echo "========================================"
            echo "ğŸ”§ CLI å·¥å…·ç‰ˆæœ¬æª¢æŸ¥"
            echo "========================================"
            
            # ç´” CLI å·¥å…· - ç›´æ¥åŸ·è¡Œ
            echo "ConvertX $(cat /app/package.json 2>/dev/null | grep version | head -1 | cut -d\" -f4)"
            echo "Bun $(bun --version 2>/dev/null || echo "N/A")"
            pandoc --version 2>/dev/null | head -1 || echo "pandoc: N/A"
            ffmpeg -version 2>/dev/null | head -1 || echo "ffmpeg: N/A"
            tesseract --version 2>&1 | head -1 || echo "tesseract: N/A"
            vips --version 2>/dev/null || echo "vips: N/A"
            gm -version 2>/dev/null | head -1 || echo "GraphicsMagick: N/A"
            resvg --version 2>/dev/null || echo "resvg: N/A"
            potrace --version 2>/dev/null | head -1 || echo "potrace: N/A"
            dasel --version 2>/dev/null || echo "dasel: N/A"
            djxl --version 2>&1 | head -1 || echo "djxl: N/A"
            deark -version 2>/dev/null | head -1 || echo "deark: N/A"
            
            echo ""
            echo "========================================"
            echo "ğŸ–¥ï¸ GUI å·¥å…·ç‰ˆæœ¬æª¢æŸ¥ï¼ˆä½¿ç”¨ xvfb-run + timeoutï¼‰"
            echo "========================================"
            
            # GUI å·¥å…· - ä½¿ç”¨ timeout + xvfb-run é˜²æ­¢æ›èµ·
            # timeout 60 ç§’ï¼Œè¶…éå°±è·³éè©²å·¥å…·
            echo -n "Inkscape: "
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" inkscape --version 2>/dev/null || echo "N/A (timeout or error)"
            
            echo -n "Calibre: "
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" ebook-convert --version 2>/dev/null | head -1 || echo "N/A (timeout or error)"
            
            echo -n "LibreOffice: "
            timeout 60 xvfb-run -a --server-args="-screen 0 1024x768x24" libreoffice --version 2>/dev/null || echo "N/A (timeout or error)"
            
            echo ""
            echo "========================================"
            echo "ğŸ¤– æ¨¡å‹ç›®éŒ„æª¢æŸ¥"
            echo "========================================"
            
            echo -n "  HuggingFace cache: "
            [ -d "/root/.cache/huggingface" ] && echo "âœ… å­˜åœ¨" || echo "âš ï¸ ä¸å­˜åœ¨"
            
            echo -n "  ModelScope cache:  "
            [ -d "/root/.cache/modelscope" ] && echo "âœ… å­˜åœ¨" || echo "âš ï¸ ä¸å­˜åœ¨"
            
            echo -n "  BabelDOC cache:    "
            [ -d "/root/.cache/babeldoc" ] && echo "âœ… å­˜åœ¨" || echo "âš ï¸ ä¸å­˜åœ¨"

            echo ""
            echo "========================================"
            echo "âœ… å·¥å…·é©—è­‰å®Œæˆï¼"
            echo "========================================"
          '

      # ========================================
      # é©—è­‰ 2: å•Ÿå‹•å®¹å™¨ä¸¦æª¢æŸ¥å¥åº·ç‹€æ…‹
      # ========================================
      - name: "âš™ï¸ Start Container & Health Check"
        timeout-minutes: 3
        run: |
          echo "========================================"
          echo "âš™ï¸ å•Ÿå‹•å®¹å™¨ä¸¦æª¢æŸ¥å¥åº·ç‹€æ…‹"
          echo "========================================"

          IMAGE="${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}"

          # å•Ÿå‹•å®¹å™¨
          echo "ğŸš€ å•Ÿå‹•å®¹å™¨..."
          docker run -d --name verify-test -p 3000:3000 "${IMAGE}"

          # ç­‰å¾…å•Ÿå‹•
          echo "â³ ç­‰å¾…å®¹å™¨å•Ÿå‹•..."
          for i in {1..90}; do
            if docker exec verify-test curl -sf http://localhost:3000/healthcheck > /dev/null 2>&1; then
              echo "âœ… å®¹å™¨åœ¨ ${i} ç§’å…§å•Ÿå‹•æˆåŠŸ"
              break
            fi
            if [ $i -eq 90 ]; then
              echo "âŒ å®¹å™¨å•Ÿå‹•è¶…æ™‚"
              docker logs verify-test
              docker rm -f verify-test
              exit 1
            fi
            sleep 1
          done

          # é¡¯ç¤ºå®¹å™¨æ—¥èªŒ
          echo ""
          echo "ğŸ“‹ å®¹å™¨å•Ÿå‹•æ—¥èªŒï¼š"
          docker logs verify-test 2>&1 | tail -20

          echo ""
          echo "========================================"
          echo "âœ… å®¹å™¨å¥åº·æª¢æŸ¥é€šéï¼"
          echo "========================================"

      # ========================================
      # é©—è­‰ 3: E2E è½‰æ›æ¸¬è©¦ï¼ˆä½¿ç”¨ xvfb-run è§£æ±º GUI å•é¡Œï¼‰
      # ========================================
      - name: "ğŸ§ª E2E Tests in Container"
        timeout-minutes: 10
        run: |
          echo "========================================"
          echo "ğŸ§ª E2E è½‰æ›æ¸¬è©¦"
          echo "========================================"

          # ä½¿ç”¨å·²å•Ÿå‹•çš„ verify-test å®¹å™¨
          # ğŸ”¥ é—œéµï¼šæ‰€æœ‰ GUI å·¥å…·éƒ½ä½¿ç”¨ xvfb-run åŒ…è£¹

          FAILED=0

          # æ¸¬è©¦ 1: Inkscape SVG â†’ PNGï¼ˆä½¿ç”¨ xvfb-runï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Inkscape: SVG â†’ PNG"
          docker exec verify-test sh -c '
            echo "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"><circle cx=\"50\" cy=\"50\" r=\"40\" fill=\"red\"/></svg>" > /tmp/test.svg
            xvfb-run -a inkscape --export-type=png --export-filename=/tmp/test.png /tmp/test.svg 2>/dev/null
            if [ -f /tmp/test.png ]; then
              echo "âœ… Inkscape SVG â†’ PNG æˆåŠŸ"
              ls -la /tmp/test.png
            else
              echo "âŒ Inkscape SVG â†’ PNG å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 2: Pandoc Markdown â†’ HTMLï¼ˆç´” CLIï¼Œä¸éœ€è¦ xvfbï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Pandoc: Markdown â†’ HTML"
          docker exec verify-test sh -c '
            echo "# Test\n\nHello **world**" > /tmp/test.md
            pandoc /tmp/test.md -o /tmp/test.html
            if [ -f /tmp/test.html ]; then
              echo "âœ… Pandoc Markdown â†’ HTML æˆåŠŸ"
              cat /tmp/test.html
            else
              echo "âŒ Pandoc Markdown â†’ HTML å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 3: LibreOffice TXT â†’ PDFï¼ˆä½¿ç”¨ xvfb-runï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ LibreOffice: TXT â†’ PDF"
          docker exec verify-test sh -c '
            echo "Test document content" > /tmp/test.txt
            xvfb-run -a libreoffice --headless --convert-to pdf --outdir /tmp /tmp/test.txt 2>/dev/null
            if [ -f /tmp/test.pdf ]; then
              echo "âœ… LibreOffice TXT â†’ PDF æˆåŠŸ"
              ls -la /tmp/test.pdf
            else
              echo "âŒ LibreOffice TXT â†’ PDF å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 4: FFmpeg éŸ³é »è½‰æ›ï¼ˆç´” CLIï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ FFmpeg: ç”Ÿæˆæ¸¬è©¦éŸ³é »"
          docker exec verify-test sh -c '
            ffmpeg -f lavfi -i "sine=frequency=440:duration=1" -y /tmp/test.wav 2>/dev/null
            if [ -f /tmp/test.wav ]; then
              echo "âœ… FFmpeg éŸ³é »ç”ŸæˆæˆåŠŸ"
              ls -la /tmp/test.wav
            else
              echo "âŒ FFmpeg éŸ³é »ç”Ÿæˆå¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 5: Calibre HTML â†’ EPUBï¼ˆä½¿ç”¨ xvfb-runï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Calibre: HTML â†’ EPUB"
          docker exec verify-test sh -c '
            echo "<!DOCTYPE html><html><body><h1>Test Book</h1><p>Content</p></body></html>" > /tmp/book.html
            xvfb-run -a ebook-convert /tmp/book.html /tmp/book.epub 2>/dev/null
            if [ -f /tmp/book.epub ]; then
              echo "âœ… Calibre HTML â†’ EPUB æˆåŠŸ"
              ls -la /tmp/book.epub
            else
              echo "âŒ Calibre HTML â†’ EPUB å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 6: Tesseract OCRï¼ˆç´” CLIï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Tesseract: OCR æ–‡å­—è­˜åˆ¥"
          docker exec verify-test sh -c '
            convert -size 200x50 xc:white -font DejaVu-Sans -pointsize 20 -fill black -annotate +10+35 "Hello OCR" /tmp/ocr_test.png 2>/dev/null
            tesseract /tmp/ocr_test.png /tmp/ocr_output 2>/dev/null
            if [ -f /tmp/ocr_output.txt ]; then
              echo "âœ… Tesseract OCR æˆåŠŸ"
              cat /tmp/ocr_output.txt
            else
              echo "âŒ Tesseract OCR å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 7: Resvg SVG â†’ PNGï¼ˆç´” CLIï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Resvg: SVG â†’ PNG"
          docker exec verify-test sh -c '
            echo "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"50\"><rect fill=\"purple\" width=\"50\" height=\"50\"/></svg>" > /tmp/resvg_test.svg
            resvg /tmp/resvg_test.svg /tmp/resvg_output.png 2>/dev/null
            if [ -f /tmp/resvg_output.png ]; then
              echo "âœ… Resvg SVG â†’ PNG æˆåŠŸ"
              ls -la /tmp/resvg_output.png
            else
              echo "âŒ Resvg SVG â†’ PNG å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 8: FFmpeg å½±ç‰‡è½‰æ›ï¼ˆç´” CLIï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ FFmpeg: å½±ç‰‡ç”Ÿæˆ"
          docker exec verify-test sh -c '
            ffmpeg -f lavfi -i color=c=red:s=320x240:d=1 -y /tmp/test_video.mp4 2>/dev/null
            if [ -f /tmp/test_video.mp4 ]; then
              echo "âœ… FFmpeg å½±ç‰‡ç”ŸæˆæˆåŠŸ"
              ls -la /tmp/test_video.mp4
            else
              echo "âŒ FFmpeg å½±ç‰‡ç”Ÿæˆå¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 9: API å¥åº·æª¢æŸ¥
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ API ç«¯é»"
          if docker exec verify-test curl -sf http://localhost:3000/healthcheck | grep -q "OK"; then
            echo "âœ… Healthcheck API æ­£å¸¸"
          else
            echo "âŒ Healthcheck API å¤±æ•—"
            FAILED=1
          fi

          # æ¸¬è©¦æ‘˜è¦
          echo ""
          echo "========================================"
          echo "ğŸ“Š E2E æ¸¬è©¦æ‘˜è¦"
          echo "========================================"
          echo "âœ“ Inkscape: SVG â†’ PNG (xvfb-run)"
          echo "âœ“ Pandoc: Markdown â†’ HTML"
          echo "âœ“ LibreOffice: TXT â†’ PDF (xvfb-run)"
          echo "âœ“ FFmpeg: éŸ³é » + å½±ç‰‡"
          echo "âœ“ Calibre: HTML â†’ EPUB (xvfb-run)"
          echo "âœ“ Tesseract: OCR"
          echo "âœ“ Resvg: SVG â†’ PNG"
          echo "âœ“ API: Healthcheck"
          echo "========================================"

          if [ $FAILED -eq 0 ]; then
            echo "âœ… E2E æ¸¬è©¦å…¨éƒ¨é€šéï¼"
          else
            echo "âŒ E2E æ¸¬è©¦æœ‰å¤±æ•—é …ç›®"
            exit 1
          fi

      # ========================================
      # æ¸…ç†é©—è­‰å®¹å™¨
      # ========================================
      - name: "ğŸ§¹ Cleanup Verification Containers"
        if: always()
        run: |
          docker rm -f verify-test 2>/dev/null || true

      - name: Verification Summary
        run: |
          echo "## ğŸ” Image Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Verification Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ï¿½ Tools & Model: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ Basic Functionality: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª E2E Tests: Passed" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # ğŸ“¦ Create GitHub Release
  # ==============================================================================
  create-release:
    runs-on: ubuntu-latest
    needs: [build-and-push, verify-image]
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # No previous tag, get all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            # Get commits between previous tag and current
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD)
          fi

          # Write to file to preserve newlines
          echo "$CHANGELOG" > changelog.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.tag.outputs.version }}
          tag_name: ${{ steps.tag.outputs.version }}
          body_path: changelog.txt
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
