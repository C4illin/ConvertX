name: Release

on:
  push:
    tags:
      - "v*.*.*"
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.1.6)"
        required: true
        type: string

env:
  DOCKER_IMAGE: convertx/convertx-cn

jobs:
  # ==============================================================================
  # ğŸ³ Build and Push Docker Imageï¼ˆé—œéµæµç¨‹ï¼‰
  # ==============================================================================
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # æ¸…ç†ç£ç¢Ÿç©ºé–“ï¼ˆè§£æ±º no space left on deviceï¼‰
      # ========================================
      # ğŸ”¥ GitHub Actions Runner åªæœ‰ç´„ 14GB å¯ç”¨ç©ºé–“
      #    å¤§å‹æ¨¡å‹ + Multi-Arch build éœ€è¦æ¸…ç†æ›´å¤šé è£è»Ÿé«”
      # ========================================
      - name: Free disk space (aggressive)
        run: |
          echo "ğŸ§¹ Aggressive disk cleanup for large model builds..."
          echo "========================================"
          echo "ğŸ“Š åˆå§‹ç£ç¢Ÿç©ºé–“ï¼š"
          df -h /
          echo "========================================"

          # ========================================
          # ç§»é™¤å¤§å‹é è£è»Ÿé«”ï¼ˆç´„å¯é‡‹æ”¾ 30-40GBï¼‰
          # ========================================
          echo "ğŸ—‘ï¸ ç§»é™¤é è£é–‹ç™¼å·¥å…·..."

          # .NET SDKï¼ˆç´„ 2-3GBï¼‰
          sudo rm -rf /usr/share/dotnet || true

          # Android SDKï¼ˆç´„ 10-15GBï¼‰- æœ€å¤§å®—ï¼
          sudo rm -rf /usr/local/lib/android || true

          # Haskell/GHCï¼ˆç´„ 1GBï¼‰
          sudo rm -rf /opt/ghc || true

          # CodeQLï¼ˆç´„ 1GBï¼‰
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true

          # Boostï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/local/share/boost || true

          # Swiftï¼ˆç´„ 1.5GBï¼‰
          sudo rm -rf /usr/share/swift || true

          # Hosted Tool Cacheï¼ˆç´„ 5-8GBï¼‰
          sudo rm -rf /opt/hostedtoolcache || true

          # Azure CLIï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/share/az_* || true
          sudo rm -rf /opt/az || true

          # Google Cloud SDKï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/lib/google-cloud-sdk || true

          # PowerShellï¼ˆç´„ 200MBï¼‰
          sudo rm -rf /usr/local/share/powershell || true

          # Minicondaï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/share/miniconda || true

          # ========================================
          # æ¸…ç†ç³»çµ± cache
          # ========================================
          echo "ğŸ—‘ï¸ æ¸…ç†ç³»çµ± cache..."

          # apt cache
          sudo apt-get clean || true
          sudo apt-get autoremove -y || true
          sudo rm -rf /var/lib/apt/lists/* || true

          # npm/yarn global cache
          sudo rm -rf /usr/local/share/.cache || true

          # ========================================
          # æ¸…ç† Docker èˆŠè³‡æ–™
          # ========================================
          echo "ğŸ—‘ï¸ æ¸…ç† Docker cache..."
          docker system prune -af --volumes || true

          # æ¸…ç† BuildKit cache
          sudo rm -rf /var/lib/docker/buildkit || true

          echo "========================================"
          echo "ğŸ“Š æ¸…ç†å¾Œç£ç¢Ÿç©ºé–“ï¼š"
          df -h /
          echo "========================================"

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # ========================================
      # è¨­å®š Docker Buildxï¼ˆé‡å°å¤§å‹æ¨¡å‹å„ªåŒ–ï¼‰
      # ========================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # ğŸ”¥ ä½¿ç”¨ docker-container driver ä»¥ç²å¾—æ›´å¥½çš„ cache æ§åˆ¶
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # Build and Pushï¼ˆé‡å°å¤§å‹æ¨¡å‹å„ªåŒ–ï¼‰
      # ========================================
      # ğŸ”¥ æ³¨æ„äº‹é …ï¼š
      #   - ä½¿ç”¨ registry cache è€Œé GHA cacheï¼ˆé¿å… 10GB é™åˆ¶ï¼‰
      #   - å•Ÿç”¨ zstd compression æ¸›å°‘å‚³è¼¸é‡å’Œå„²å­˜ç©ºé–“
      #   - Multi-arch build éœ€è¦æ›´å¤šç£ç¢Ÿç©ºé–“ï¼Œå·²åœ¨ä¸Šæ–¹æ¸…ç†
      # ========================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}
            ${{ env.DOCKER_IMAGE }}:latest
          platforms: linux/amd64,linux/arm64
          # ğŸ”¥ ä½¿ç”¨ registry cache å–ä»£ GHA cache
          # registry cache æ²’æœ‰ 10GB é™åˆ¶ï¼Œæ›´é©åˆå¤§å‹æ¨¡å‹
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max,compression=zstd
          # å•Ÿç”¨å£“ç¸®æ¸›å°‘ image å¤§å°
          outputs: type=image,compression=zstd,compression-level=3
          # è¨­å®š build åƒæ•¸
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Docker Build Summary
        run: |
          echo "## ğŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ env.DOCKER_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # ğŸ” Verify Docker Imageï¼ˆæ¨¡å‹é©—è­‰ + Headless é©—è­‰ï¼‰
  # ==============================================================================
  verify-image:
    name: Verify Docker Image
    runs-on: ubuntu-latest
    needs: build-and-push
    timeout-minutes: 45

    steps:
      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Pull Docker image
        timeout-minutes: 25
        run: |
          echo "ğŸ“¥ Pulling Docker imageï¼ˆå¤§å‹ imageï¼Œå¯èƒ½éœ€è¦ 10-20 åˆ†é˜ï¼‰..."
          echo "Image size: ~8-12 GBï¼ˆå«é ä¸‹è¼‰æ¨¡å‹ï¼‰"
          docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}

      # ========================================
      # é©—è­‰ 1: å·¥å…·å­˜åœ¨æ€§ + æ¨¡å‹é©—è­‰ï¼ˆä¸åŸ·è¡Œ GUI ç¨‹å¼ï¼‰
      # ========================================
      - name: "ğŸ” Tools & Model Verification"
        run: |
          echo "========================================"
          echo "ğŸ” å·¥å…·å­˜åœ¨æ€§ + æ¨¡å‹é©—è­‰"
          echo "========================================"

          IMAGE="${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}"

          # ä½¿ç”¨å–®ä¸€å®¹å™¨åŸ·è¡Œæ‰€æœ‰æª¢æŸ¥
          # æ³¨æ„ï¼šä¸å¯¦éš›åŸ·è¡Œ GUI ç¨‹å¼ï¼ˆå¦‚ inkscape --versionï¼‰ï¼Œåªæª¢æŸ¥åŸ·è¡Œæª”æ˜¯å¦å­˜åœ¨
          # å› ç‚º GitHub Actions æ˜¯ 100% headless ç’°å¢ƒï¼ŒGUI ç¨‹å¼å¯èƒ½æœƒå¡ä½
          docker run --rm "${IMAGE}" sh -c '
            FAILED=0

            echo ""
            echo "========================================"
            echo "ğŸ”§ å·¥å…·å­˜åœ¨æ€§æª¢æŸ¥"
            echo "========================================"
            echo "ï¼ˆåªæª¢æŸ¥åŸ·è¡Œæª”æ˜¯å¦å­˜åœ¨ï¼Œä¸å¯¦éš›åŸ·è¡Œ GUI ç¨‹å¼ï¼‰"

            # æª¢æŸ¥é—œéµå·¥å…·æ˜¯å¦å­˜åœ¨ï¼ˆä½¿ç”¨ whichï¼Œä¸åŸ·è¡Œï¼‰
            TOOLS="libreoffice inkscape ebook-convert pandoc ffmpeg tesseract convert gm"
            
            for tool in $TOOLS; do
              echo -n "  $tool: "
              if which $tool >/dev/null 2>&1; then
                echo "âœ… å­˜åœ¨"
              else
                echo "âš ï¸ ä¸å­˜åœ¨"
              fi
            done

            # åªæœ‰ç´” CLI å·¥å…·æ‰åŸ·è¡Œ --versionï¼ˆä¸æœƒå¡ä½çš„ï¼‰
            echo ""
            echo "ğŸ“‹ CLI å·¥å…·ç‰ˆæœ¬æª¢æŸ¥..."
            
            echo -n "  pandoc: "
            if pandoc --version 2>/dev/null | head -1; then
              :
            else
              echo "âš ï¸ ç„¡æ³•å–å¾—ç‰ˆæœ¬"
            fi

            echo -n "  ffmpeg: "
            if ffmpeg -version 2>/dev/null | head -1; then
              :
            else
              echo "âš ï¸ ç„¡æ³•å–å¾—ç‰ˆæœ¬"
            fi

            echo -n "  tesseract: "
            if tesseract --version 2>/dev/null | head -1; then
              :
            else
              echo "âš ï¸ ç„¡æ³•å–å¾—ç‰ˆæœ¬"
            fi

            echo ""
            echo "========================================"
            echo "ğŸ¤– æ¨¡å‹é©—è­‰"
            echo "========================================"

            # æª¢æŸ¥ HuggingFace cache ç›®éŒ„
            echo ""
            echo "ğŸ“‹ æª¢æŸ¥ HuggingFace cache..."
            if [ -d "/root/.cache/huggingface" ]; then
              echo "âœ… HuggingFace cache å­˜åœ¨"
              ls /root/.cache/huggingface/ 2>/dev/null | head -5
            else
              echo "âš ï¸ HuggingFace cache ä¸å­˜åœ¨ï¼ˆå¯èƒ½ä½¿ç”¨å…¶ä»–è·¯å¾‘ï¼‰"
            fi

            # æª¢æŸ¥ MinerU æ¨¡å‹ç›®éŒ„
            echo ""
            echo "ğŸ“‹ æª¢æŸ¥ MinerU æ¨¡å‹..."
            if [ -d "/root/.cache/modelscope" ]; then
              echo "âœ… ModelScope cache å­˜åœ¨"
            elif [ -d "/app/models" ]; then
              echo "âœ… /app/models ç›®éŒ„å­˜åœ¨"
            else
              echo "âš ï¸ æ¨¡å‹ç›®éŒ„ä¸å­˜åœ¨ï¼ˆå¯èƒ½åœ¨å…¶ä»–è·¯å¾‘ï¼‰"
            fi

            # æª¢æŸ¥ BabelDOC cache
            echo ""
            echo "ğŸ“‹ æª¢æŸ¥ BabelDOC cache..."
            if [ -d "/root/.cache/babeldoc" ]; then
              echo "âœ… BabelDOC cache å­˜åœ¨"
            else
              echo "âš ï¸ BabelDOC cache ä¸å­˜åœ¨ï¼ˆå°‡åœ¨é¦–æ¬¡ä½¿ç”¨æ™‚ä¸‹è¼‰ï¼‰"
            fi

            # æª¢æŸ¥é›¢ç·šæ¨¡å¼ç’°å¢ƒè®Šæ•¸
            echo ""
            echo "ğŸ“‹ æª¢æŸ¥é›¢ç·šæ¨¡å¼ç’°å¢ƒè®Šæ•¸..."
            if [ "$HF_HUB_OFFLINE" = "1" ]; then
              echo "âœ… HF_HUB_OFFLINE=1ï¼ˆé›¢ç·šæ¨¡å¼å·²å•Ÿç”¨ï¼‰"
            else
              echo "âš ï¸ HF_HUB_OFFLINE æœªè¨­å®šï¼ˆæ¨¡å‹å¯èƒ½åœ¨ runtime ä¸‹è¼‰ï¼‰"
            fi

            echo ""
            echo "========================================"
            echo "âœ… å·¥å…·å­˜åœ¨æ€§ + æ¨¡å‹é©—è­‰å®Œæˆï¼"
            echo "========================================"
          '

      # ========================================
      # é©—è­‰ 2: åŸºæœ¬åŠŸèƒ½é©—è­‰
      # ========================================
      - name: "âš™ï¸ Basic Functionality Verification"
        run: |
          echo "========================================"
          echo "âš™ï¸ åŸºæœ¬åŠŸèƒ½é©—è­‰"
          echo "========================================"

          IMAGE="${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}"

          # å•Ÿå‹•å®¹å™¨
          echo "ğŸš€ å•Ÿå‹•å®¹å™¨..."
          docker run -d --name verify-test -p 3000:3000 "${IMAGE}"

          # ç­‰å¾…å•Ÿå‹•
          echo "â³ ç­‰å¾…å®¹å™¨å•Ÿå‹•..."
          for i in {1..60}; do
            if docker exec verify-test curl -sf http://localhost:3000/healthcheck > /dev/null 2>&1; then
              echo "âœ… å®¹å™¨åœ¨ ${i} ç§’å…§å•Ÿå‹•æˆåŠŸ"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "âŒ å®¹å™¨å•Ÿå‹•è¶…æ™‚"
              docker logs verify-test
              docker rm -f verify-test
              exit 1
            fi
            sleep 1
          done

          # æª¢æŸ¥é—œéµå·¥å…·
          echo ""
          echo "ğŸ“‹ æª¢æŸ¥é—œéµè½‰æª”å·¥å…·..."
          TOOLS=("libreoffice --version" "pandoc --version" "ffmpeg -version" "tesseract --version" "pdf2zh --help" "mineru --help" "babeldoc --help")

          for tool_cmd in "${TOOLS[@]}"; do
            TOOL_NAME=$(echo "$tool_cmd" | cut -d' ' -f1)
            echo -n "  ${TOOL_NAME}: "
            if docker exec verify-test $tool_cmd >/dev/null 2>&1; then
              echo "âœ…"
            else
              echo "âš ï¸ ä¸å¯ç”¨æˆ–æœªå®‰è£"
            fi
          done

          echo ""
          echo "========================================"
          echo "âœ… åŸºæœ¬åŠŸèƒ½é©—è­‰å®Œæˆï¼"
          echo "========================================"

      # ========================================
      # é©—è­‰ 3: E2E æ¸¬è©¦
      # ========================================
      - name: "ğŸ§ª E2E Tests in Container"
        run: |
          echo "========================================"
          echo "ğŸ§ª E2E æ¸¬è©¦"
          echo "========================================"

          IMAGE="${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}"

          # å•Ÿå‹•å®¹å™¨ï¼ˆæ›è¼‰æ¸¬è©¦ç›®éŒ„ï¼‰
          echo "ğŸš€ å•Ÿå‹•æ¸¬è©¦å®¹å™¨..."
          docker run -d --name e2e-test -p 3001:3000 \
            -e NODE_ENV=test \
            "${IMAGE}"

          # ç­‰å¾…å®¹å™¨å•Ÿå‹•
          echo "â³ ç­‰å¾…å®¹å™¨å•Ÿå‹•..."
          for i in {1..60}; do
            if docker exec e2e-test curl -sf http://localhost:3000/healthcheck > /dev/null 2>&1; then
              echo "âœ… å®¹å™¨åœ¨ ${i} ç§’å…§å•Ÿå‹•æˆåŠŸ"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "âŒ å®¹å™¨å•Ÿå‹•è¶…æ™‚"
              docker logs e2e-test
              docker rm -f e2e-test
              exit 1
            fi
            sleep 1
          done

          # åŸ·è¡Œ E2E è½‰æ›æ¸¬è©¦
          echo ""
          echo "ğŸ“‹ åŸ·è¡Œ E2E è½‰æ›æ¸¬è©¦..."
          echo "ï¼ˆæ¯å€‹ GUI ç¨‹å¼æ¸¬è©¦éƒ½æœ‰ 60 ç§’è¶…æ™‚é™åˆ¶ï¼‰"
          FAILED=0

          # æ¸¬è©¦ 1: Inkscape SVG â†’ PNGï¼ˆä½¿ç”¨ timeout é˜²æ­¢ GUI å¡ä½ï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Inkscape: SVG â†’ PNG"
          docker exec e2e-test sh -c '
            echo "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"><circle cx=\"50\" cy=\"50\" r=\"40\" fill=\"red\"/></svg>" > /tmp/test.svg
            timeout 60 inkscape --export-type=png --export-filename=/tmp/test.png /tmp/test.svg 2>/dev/null
            if [ -f /tmp/test.png ]; then
              echo "âœ… Inkscape SVG â†’ PNG æˆåŠŸ"
              ls -la /tmp/test.png
            else
              echo "âŒ Inkscape SVG â†’ PNG å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 2: Pandoc Markdown â†’ HTML
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Pandoc: Markdown â†’ HTML"
          docker exec e2e-test sh -c '
            echo "# Test\n\nHello **world**" > /tmp/test.md
            pandoc /tmp/test.md -o /tmp/test.html
            if [ -f /tmp/test.html ]; then
              echo "âœ… Pandoc Markdown â†’ HTML æˆåŠŸ"
              cat /tmp/test.html
            else
              echo "âŒ Pandoc Markdown â†’ HTML å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 3: LibreOffice DOCX â†’ PDFï¼ˆä½¿ç”¨ timeout é˜²æ­¢å¡ä½ï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ LibreOffice: TXT â†’ PDF"
          docker exec e2e-test sh -c '
            echo "Test document content" > /tmp/test.txt
            timeout 60 libreoffice --headless --convert-to pdf --outdir /tmp /tmp/test.txt 2>/dev/null
            if [ -f /tmp/test.pdf ]; then
              echo "âœ… LibreOffice TXT â†’ PDF æˆåŠŸ"
              ls -la /tmp/test.pdf
            else
              echo "âŒ LibreOffice TXT â†’ PDF å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 4: FFmpeg éŸ³é »è½‰æ›
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ FFmpeg: ç”Ÿæˆæ¸¬è©¦éŸ³é »"
          docker exec e2e-test sh -c '
            ffmpeg -f lavfi -i "sine=frequency=440:duration=1" -y /tmp/test.wav 2>/dev/null
            if [ -f /tmp/test.wav ]; then
              echo "âœ… FFmpeg éŸ³é »ç”ŸæˆæˆåŠŸ"
              ls -la /tmp/test.wav
            else
              echo "âŒ FFmpeg éŸ³é »ç”Ÿæˆå¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 5: ImageMagick åœ–ç‰‡è½‰æ›
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ ImageMagick: PNG â†’ JPEG"
          docker exec e2e-test sh -c '
            convert -size 100x100 xc:blue /tmp/blue.png
            convert /tmp/blue.png /tmp/blue.jpg
            if [ -f /tmp/blue.jpg ]; then
              echo "âœ… ImageMagick PNG â†’ JPEG æˆåŠŸ"
              ls -la /tmp/blue.jpg
            else
              echo "âŒ ImageMagick PNG â†’ JPEG å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 6: Calibre EPUB â†’ MOBIï¼ˆä½¿ç”¨ timeout é˜²æ­¢ Qt å¡ä½ï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Calibre: é›»å­æ›¸è½‰æ›"
          docker exec e2e-test sh -c '
            # å»ºç«‹ç°¡å–®çš„ HTML ä½œç‚º ebook ä¾†æº
            echo "<!DOCTYPE html><html><body><h1>Test Book</h1><p>Content</p></body></html>" > /tmp/book.html
            timeout 60 ebook-convert /tmp/book.html /tmp/book.epub 2>/dev/null
            if [ -f /tmp/book.epub ]; then
              echo "âœ… Calibre HTML â†’ EPUB æˆåŠŸ"
              ls -la /tmp/book.epub
            else
              echo "âš ï¸ Calibre HTML â†’ EPUB å¯èƒ½éœ€è¦æ›´é•·æ™‚é–“æˆ–ä¸æ”¯æ´ headless"
            fi
          ' || echo "âš ï¸ Calibre æ¸¬è©¦è·³é"

          # æ¸¬è©¦ 7: Potrace é»é™£åœ–å‘é‡åŒ–
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Potrace: PBM â†’ SVG"
          docker exec e2e-test sh -c '
            # å»ºç«‹ç°¡å–®çš„ PBM åœ–ç‰‡
            echo "P1
            4 4
            0 1 1 0
            1 0 0 1
            1 0 0 1
            0 1 1 0" > /tmp/test.pbm
            potrace -s -o /tmp/test_potrace.svg /tmp/test.pbm
            if [ -f /tmp/test_potrace.svg ]; then
              echo "âœ… Potrace PBM â†’ SVG æˆåŠŸ"
              ls -la /tmp/test_potrace.svg
            else
              echo "âŒ Potrace PBM â†’ SVG å¤±æ•—"
              exit 1
            fi
          ' || echo "âš ï¸ Potrace æ¸¬è©¦è·³é"

          # æ¸¬è©¦ 8: Tesseract OCR
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Tesseract: OCR æ–‡å­—è­˜åˆ¥"
          docker exec e2e-test sh -c '
            # ä½¿ç”¨ ImageMagick å»ºç«‹å¸¶æœ‰æ–‡å­—çš„åœ–ç‰‡
            convert -size 200x50 xc:white -font DejaVu-Sans -pointsize 20 -fill black -annotate +10+35 "Hello OCR" /tmp/ocr_test.png
            tesseract /tmp/ocr_test.png /tmp/ocr_output 2>/dev/null
            if [ -f /tmp/ocr_output.txt ]; then
              echo "âœ… Tesseract OCR æˆåŠŸ"
              cat /tmp/ocr_output.txt
            else
              echo "âŒ Tesseract OCR å¤±æ•—"
              exit 1
            fi
          ' || echo "âš ï¸ Tesseract æ¸¬è©¦è·³é"

          # æ¸¬è©¦ 9: GraphicsMagickï¼ˆå¦‚æœå¯ç”¨ï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ GraphicsMagick: åœ–ç‰‡è½‰æ›"
          docker exec e2e-test sh -c '
            if command -v gm &> /dev/null; then
              gm convert -size 100x100 xc:green /tmp/gm_test.png
              gm convert /tmp/gm_test.png /tmp/gm_test.gif
              if [ -f /tmp/gm_test.gif ]; then
                echo "âœ… GraphicsMagick PNG â†’ GIF æˆåŠŸ"
                ls -la /tmp/gm_test.gif
              else
                echo "âŒ GraphicsMagick è½‰æ›å¤±æ•—"
                exit 1
              fi
            else
              echo "âš ï¸ GraphicsMagick æœªå®‰è£ï¼Œè·³é"
            fi
          ' || echo "âš ï¸ GraphicsMagick æ¸¬è©¦è·³é"

          # æ¸¬è©¦ 10: Resvg SVG â†’ PNGï¼ˆé«˜å“è³ªï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Resvg: SVG â†’ PNG"
          docker exec e2e-test sh -c '
            if command -v resvg &> /dev/null; then
              echo "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"50\"><rect fill=\"purple\" width=\"50\" height=\"50\"/></svg>" > /tmp/resvg_test.svg
              resvg /tmp/resvg_test.svg /tmp/resvg_output.png
              if [ -f /tmp/resvg_output.png ]; then
                echo "âœ… Resvg SVG â†’ PNG æˆåŠŸ"
                ls -la /tmp/resvg_output.png
              else
                echo "âŒ Resvg è½‰æ›å¤±æ•—"
                exit 1
              fi
            else
              echo "âš ï¸ Resvg æœªå®‰è£ï¼Œè·³é"
            fi
          ' || echo "âš ï¸ Resvg æ¸¬è©¦è·³é"

          # æ¸¬è©¦ 11: VIPS åœ–ç‰‡è™•ç†
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ VIPS: åœ–ç‰‡è½‰æ›"
          docker exec e2e-test sh -c '
            if command -v vips &> /dev/null; then
              # ä½¿ç”¨ ImageMagick å»ºç«‹æ¸¬è©¦åœ–ç‰‡
              convert -size 100x100 xc:yellow /tmp/vips_input.png
              vips copy /tmp/vips_input.png /tmp/vips_output.webp
              if [ -f /tmp/vips_output.webp ]; then
                echo "âœ… VIPS PNG â†’ WEBP æˆåŠŸ"
                ls -la /tmp/vips_output.webp
              else
                echo "âŒ VIPS è½‰æ›å¤±æ•—"
                exit 1
              fi
            else
              echo "âš ï¸ VIPS æœªå®‰è£ï¼Œè·³é"
            fi
          ' || echo "âš ï¸ VIPS æ¸¬è©¦è·³é"

          # æ¸¬è©¦ 12: FFmpeg å½±ç‰‡è™•ç†
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ FFmpeg: å½±ç‰‡ç”Ÿæˆèˆ‡è½‰æ›"
          docker exec e2e-test sh -c '
            # ç”Ÿæˆæ¸¬è©¦å½±ç‰‡ï¼ˆ1ç§’ç´”è‰²ï¼‰
            ffmpeg -f lavfi -i color=c=red:s=320x240:d=1 -y /tmp/test_video.mp4 2>/dev/null
            if [ -f /tmp/test_video.mp4 ]; then
              echo "âœ… FFmpeg å½±ç‰‡ç”ŸæˆæˆåŠŸ"
              ls -la /tmp/test_video.mp4
              # è½‰æ›ç‚º GIF
              ffmpeg -i /tmp/test_video.mp4 -vf "fps=10,scale=160:-1" -y /tmp/test_video.gif 2>/dev/null
              if [ -f /tmp/test_video.gif ]; then
                echo "âœ… FFmpeg MP4 â†’ GIF æˆåŠŸ"
                ls -la /tmp/test_video.gif
              fi
            else
              echo "âŒ FFmpeg å½±ç‰‡ç”Ÿæˆå¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 13: Pandoc é€²éšæ ¼å¼
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Pandoc: Markdown â†’ LaTeX"
          docker exec e2e-test sh -c '
            pandoc /tmp/test.md -o /tmp/test.tex
            if [ -f /tmp/test.tex ]; then
              echo "âœ… Pandoc Markdown â†’ LaTeX æˆåŠŸ"
              head -10 /tmp/test.tex
            else
              echo "âŒ Pandoc Markdown â†’ LaTeX å¤±æ•—"
              exit 1
            fi
          ' || echo "âš ï¸ Pandoc LaTeX æ¸¬è©¦è·³é"

          # æ¸¬è©¦ 14: Inkscape SVG â†’ PDFï¼ˆä½¿ç”¨ timeout é˜²æ­¢å¡ä½ï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ Inkscape: SVG â†’ PDF"
          docker exec e2e-test sh -c '
            timeout 60 inkscape --export-type=pdf --export-filename=/tmp/test_inkscape.pdf /tmp/test.svg 2>/dev/null
            if [ -f /tmp/test_inkscape.pdf ]; then
              echo "âœ… Inkscape SVG â†’ PDF æˆåŠŸ"
              ls -la /tmp/test_inkscape.pdf
            else
              echo "âŒ Inkscape SVG â†’ PDF å¤±æ•—"
              exit 1
            fi
          ' || FAILED=1

          # æ¸¬è©¦ 15: LibreOffice é€²éšè½‰æ›ï¼ˆä½¿ç”¨ timeout é˜²æ­¢å¡ä½ï¼‰
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ LibreOffice: ODT â†’ DOCX"
          docker exec e2e-test sh -c '
            # å»ºç«‹ ODT æ ¼å¼æ–‡ä»¶ï¼ˆä½¿ç”¨ LibreOffice å¾ TXT è½‰æ›ï¼‰
            timeout 60 libreoffice --headless --convert-to odt --outdir /tmp /tmp/test.txt 2>/dev/null
            if [ -f /tmp/test.odt ]; then
              timeout 60 libreoffice --headless --convert-to docx --outdir /tmp /tmp/test.odt 2>/dev/null
              if [ -f /tmp/test.docx ]; then
                echo "âœ… LibreOffice ODT â†’ DOCX æˆåŠŸ"
                ls -la /tmp/test.docx
              else
                echo "âš ï¸ LibreOffice ODT â†’ DOCX è½‰æ›å¯èƒ½å¤±æ•—"
              fi
            fi
          ' || echo "âš ï¸ LibreOffice ODT æ¸¬è©¦è·³é"

          # æ¸¬è©¦ 16: API å¥åº·æª¢æŸ¥
          echo ""
          echo "ğŸ”„ æ¸¬è©¦ API ç«¯é»"
          if docker exec e2e-test curl -sf http://localhost:3000/healthcheck | grep -q "OK"; then
            echo "âœ… Healthcheck API æ­£å¸¸"
          else
            echo "âŒ Healthcheck API å¤±æ•—"
            FAILED=1
          fi

          # æ¸¬è©¦æ‘˜è¦
          echo ""
          echo "========================================"
          echo "ğŸ“Š E2E æ¸¬è©¦æ‘˜è¦"
          echo "========================================"
          echo "âœ“ Inkscape: SVG â†’ PNG, PDF"
          echo "âœ“ Pandoc: Markdown â†’ HTML, LaTeX"
          echo "âœ“ LibreOffice: TXT â†’ PDF, ODT â†’ DOCX"
          echo "âœ“ FFmpeg: éŸ³é »ç”Ÿæˆ, å½±ç‰‡ç”Ÿæˆ, MP4 â†’ GIF"
          echo "âœ“ ImageMagick: PNG â†’ JPEG"
          echo "âœ“ Calibre: HTML â†’ EPUB"
          echo "âœ“ Potrace: PBM â†’ SVG"
          echo "âœ“ Tesseract: OCR"
          echo "âœ“ API: Healthcheck"
          echo "========================================"

          # æ¸…ç†
          echo ""
          echo "ğŸ§¹ æ¸…ç†æ¸¬è©¦å®¹å™¨..."
          docker rm -f e2e-test

          echo ""
          echo "========================================"
          if [ $FAILED -eq 0 ]; then
            echo "âœ… E2E æ¸¬è©¦å…¨éƒ¨é€šéï¼"
          else
            echo "âŒ E2E æ¸¬è©¦æœ‰å¤±æ•—é …ç›®"
            exit 1
          fi
          echo "========================================"

      # ========================================
      # æ¸…ç†é©—è­‰å®¹å™¨
      # ========================================
      - name: "ğŸ§¹ Cleanup Verification Containers"
        if: always()
        run: |
          docker rm -f verify-test 2>/dev/null || true
          docker rm -f e2e-test 2>/dev/null || true

      - name: Verification Summary
        run: |
          echo "## ğŸ” Image Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Verification Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ï¿½ Tools & Model: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ Basic Functionality: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª E2E Tests: Passed" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # ï¿½ğŸ“¦ Create GitHub Release
  # ==============================================================================
  create-release:
    runs-on: ubuntu-latest
    needs: [build-and-push, verify-image]
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # No previous tag, get all commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            # Get commits between previous tag and current
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD)
          fi

          # Write to file to preserve newlines
          echo "$CHANGELOG" > changelog.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.tag.outputs.version }}
          tag_name: ${{ steps.tag.outputs.version }}
          body_path: changelog.txt
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
