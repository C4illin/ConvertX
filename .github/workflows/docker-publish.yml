name: Docker

# thanks to https://github.com/sredevopsorg/multi-arch-docker-github-workflow
# This workflow builds and publishes to GHCR (GitHub Container Registry)
# For Docker Hub releases, see release.yml

on:
  push:
    branches: ["main"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  # GitHub Container Registry image name
  GHCR_IMAGE: ghcr.io/${{ github.repository }}
  # Docker Hub image name (for merge job)
  DOCKER_IMAGE: convertx/convertx-cn

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # The build job builds the Docker image for each platform specified in the matrix.
  build:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64

    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write

    runs-on: ${{ matrix.platform == 'linux/amd64' && 'ubuntu-24.04' || matrix.platform == 'linux/arm64' && 'ubuntu-24.04-arm' }}

    name: Build Docker image for ${{ matrix.platform }}

    steps:
      - name: Prepare environment for current platform
        # This step sets up the environment for the current platform being built.
        # It replaces the '/' character in the platform name with '-' and sets it as an environment variable.
        # This is useful for naming artifacts and other resources that cannot contain '/'.
        # The environment variable PLATFORMS_PAIR will be used later in the workflow.
        id: prepare
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # æ¸…ç†ç£ç¢Ÿç©ºé–“ï¼ˆè§£æ±º no space left on deviceï¼‰
      # ========================================
      # ðŸ”¥ GitHub Actions Runner åªæœ‰ç´„ 14GB å¯ç”¨ç©ºé–“
      #    å¤§åž‹æ¨¡åž‹ build éœ€è¦æ¸…ç†æ›´å¤šé è£è»Ÿé«”
      # ========================================
      - name: Free disk space (aggressive)
        run: |
          echo "ðŸ§¹ Aggressive disk cleanup for large model builds..."
          echo "========================================"
          echo "ðŸ“Š åˆå§‹ç£ç¢Ÿç©ºé–“ï¼š"
          df -h /
          echo "========================================"

          # ========================================
          # ç§»é™¤å¤§åž‹é è£è»Ÿé«”ï¼ˆç´„å¯é‡‹æ”¾ 30-40GBï¼‰
          # ========================================
          echo "ðŸ—‘ï¸ ç§»é™¤é è£é–‹ç™¼å·¥å…·..."

          # .NET SDKï¼ˆç´„ 2-3GBï¼‰
          sudo rm -rf /usr/share/dotnet || true

          # Android SDKï¼ˆç´„ 10-15GBï¼‰- æœ€å¤§å®—ï¼
          sudo rm -rf /usr/local/lib/android || true

          # Haskell/GHCï¼ˆç´„ 1GBï¼‰
          sudo rm -rf /opt/ghc || true

          # CodeQLï¼ˆç´„ 1GBï¼‰
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true

          # Boostï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/local/share/boost || true

          # Swiftï¼ˆç´„ 1.5GBï¼‰
          sudo rm -rf /usr/share/swift || true

          # Hosted Tool Cacheï¼ˆç´„ 5-8GBï¼‰
          sudo rm -rf /opt/hostedtoolcache || true

          # Azure CLIï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/share/az_* || true
          sudo rm -rf /opt/az || true

          # Google Cloud SDKï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/lib/google-cloud-sdk || true

          # PowerShellï¼ˆç´„ 200MBï¼‰
          sudo rm -rf /usr/local/share/powershell || true

          # Minicondaï¼ˆç´„ 500MBï¼‰
          sudo rm -rf /usr/share/miniconda || true

          # ========================================
          # æ¸…ç†ç³»çµ± cache
          # ========================================
          echo "ðŸ—‘ï¸ æ¸…ç†ç³»çµ± cache..."

          # apt cache
          sudo apt-get clean || true
          sudo apt-get autoremove -y || true
          sudo rm -rf /var/lib/apt/lists/* || true

          # npm/yarn global cache
          sudo rm -rf /usr/local/share/.cache || true

          # ========================================
          # æ¸…ç† Docker èˆŠè³‡æ–™
          # ========================================
          echo "ðŸ—‘ï¸ æ¸…ç† Docker cache..."
          docker system prune -af --volumes || true

          # ========================================
          # æ¸…ç† BuildKit cacheï¼ˆé—œéµï¼è§£æ±º overlayfs çˆ†ç©ºé–“ï¼‰
          # ========================================
          echo "ðŸ—‘ï¸ æ¸…ç† BuildKit cache..."
          # BuildKit çš„ blob å’Œ layer cache å¯èƒ½ä½”ç”¨å¤§é‡ç©ºé–“
          sudo rm -rf /var/lib/docker/buildkit || true

          echo "========================================"
          echo "ðŸ“Š æ¸…ç†å¾Œç£ç¢Ÿç©ºé–“ï¼š"
          df -h /
          echo "========================================"

      - name: downcase REPO
        run: |
          echo "REPO=${GITHUB_REPOSITORY@L}" >> "${GITHUB_ENV}"

      - name: Docker meta default
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.REPO }}

      # ========================================
      # è¨­å®š Docker Buildxï¼ˆé‡å°å¤§åž‹æ¨¡åž‹å„ªåŒ–ï¼‰
      # ========================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ matrix.platform }}
          # ðŸ”¥ ä½¿ç”¨ docker-container driver ä»¥ç²å¾—æ›´å¥½çš„ cache æŽ§åˆ¶
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to GitHub Container Registry
        # here we only login to ghcr.io since the this only pushes internal images
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # Build and Pushï¼ˆé‡å°å¤§åž‹æ¨¡åž‹å„ªåŒ–ï¼‰
      # ========================================
      # ðŸ”¥ æ³¨æ„äº‹é …ï¼š
      #   - ä½¿ç”¨ registry cache è€Œéž GHA cacheï¼ˆé¿å… 10GB é™åˆ¶ï¼‰
      #   - å•Ÿç”¨ compression æ¸›å°‘å‚³è¼¸é‡
      #   - ä½¿ç”¨ inline cache ç¢ºä¿ layer å¯é‡ç”¨
      # ========================================
      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        env:
          DOCKER_BUILDKIT: 1
        with:
          context: .
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          outputs: type=image,name=ghcr.io/${{ env.REPO }},push-by-digest=true,name-canonical=true,oci-mediatypes=true,compression=zstd,compression-level=3
          push: ${{ github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && contains(fromJSON('["COLLABORATOR","MEMBER","OWNER"]'), github.event.pull_request.author_association)) }}
          # ðŸ”¥ ä½¿ç”¨ registry cache å–ä»£ GHA cache
          # registry cache æ²’æœ‰ 10GB é™åˆ¶ï¼Œæ›´é©åˆå¤§åž‹æ¨¡åž‹
          cache-from: type=registry,ref=ghcr.io/${{ env.REPO }}:buildcache-${{ env.PLATFORM_PAIR }}
          cache-to: type=registry,ref=ghcr.io/${{ env.REPO }}:buildcache-${{ env.PLATFORM_PAIR }},mode=max,compression=zstd
          # è¨­å®š build åƒæ•¸
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: digests-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  merge:
    if: ${{ github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository && contains(fromJSON('["COLLABORATOR","MEMBER","OWNER"]'), github.event.pull_request.author_association)) }}
    name: Merge Docker manifests
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write

    needs:
      - build
    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: downcase REPO
        run: |
          echo "REPO=${GITHUB_REPOSITORY@L}" >> "${GITHUB_ENV}"

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ env.REPO }}
            ${{ env.DOCKER_IMAGE }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get execution timestamp with RFC3339 format
        id: timestamp
        run: |
          echo "timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create \
            $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            --annotation='index:org.opencontainers.image.description=${{ github.event.repository.description }}' \
            --annotation='index:org.opencontainers.image.created=${{ steps.timestamp.outputs.timestamp }}' \
            --annotation='index:org.opencontainers.image.url=${{ github.event.repository.url }}' \
            --annotation='index:org.opencontainers.image.source=${{ github.event.repository.url }}' \
            $(printf 'ghcr.io/${{ env.REPO }}@sha256:%s ' *)

      - name: Inspect image
        run: |
          docker buildx imagetools inspect 'ghcr.io/${{ env.REPO }}:${{ steps.meta.outputs.version }}'
