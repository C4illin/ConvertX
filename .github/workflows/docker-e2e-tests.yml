name: Docker E2E Tests

# åœ¨ Docker ç’°å¢ƒä¸­é‹è¡Œå®Œæ•´ E2E æ¸¬è©¦
# åŒ…å«æ‰€æœ‰è½‰æ›å·¥å…·å’Œç¿»è­¯æœå‹™

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "tests/**"
      - "Dockerfile"
      - ".github/workflows/docker-e2e-tests.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "src/**"
      - "tests/**"
      - "Dockerfile"
  workflow_dispatch:
    inputs:
      run_translation_tests:
        description: "Run translation tests (requires API keys)"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: Build test image
  # ============================================
  build-test-image:
    name: Build Test Image
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write

    outputs:
      image: ${{ steps.image.outputs.image }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "ðŸ§¹ Cleaning disk space..."
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true
          docker system prune -af --volumes || true
          echo "ðŸ“Š Available space:"
          df -h /

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: downcase REPO
        run: echo "REPO=${GITHUB_REPOSITORY@L}" >> "${GITHUB_ENV}"

      - name: Build and push test image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO }}:test-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REPO }}:buildcache-linux-amd64
          cache-to: type=inline
          # ðŸ”¥ CACHE_BUST å¼·åˆ¶é‡æ–°åŸ·è¡Œæ¨¡åž‹ä¸‹è¼‰å±¤
          build-args: |
            CACHE_BUST=${{ github.run_id }}${{ github.run_attempt }}

      - name: Set image output
        id: image
        run: echo "image=${{ env.REGISTRY }}/${{ env.REPO }}:test-${{ github.sha }}" >> $GITHUB_OUTPUT

  # ============================================
  # Job 2: Run E2E tests in Docker
  # ============================================
  e2e-tests:
    name: E2E Tests in Docker
    runs-on: ubuntu-24.04
    needs: build-test-image
    timeout-minutes: 30

    services:
      # Run the test image as a service
      convertx:
        image: ${{ needs.build-test-image.outputs.image }}
        credentials:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        ports:
          - 3000:3000
        options: >-
          --health-cmd "curl -f http://localhost:3000/healthcheck || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for service to be healthy
        run: |
          echo "â³ Waiting for ConvertX service..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/healthcheck 2>/dev/null; then
              echo "âœ… Service is healthy!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 5
          done

      - name: Run API health check
        run: |
          echo "ðŸ” Testing API endpoints..."

          # Health check
          curl -f http://localhost:3000/healthcheck
          echo ""

          # Check if main page loads
          curl -f -o /dev/null -w "%{http_code}" http://localhost:3000/
          echo ""

          echo "âœ… API health checks passed!"

  # ============================================
  # Job 3: Run comprehensive E2E tests inside container
  # ============================================
  comprehensive-e2e:
    name: Comprehensive E2E Tests
    runs-on: ubuntu-24.04
    needs: build-test-image
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          docker system prune -af --volumes || true

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull test image
        run: docker pull ${{ needs.build-test-image.outputs.image }}

      - name: Run E2E tests inside Docker container
        run: |
          echo "ðŸ§ª Running comprehensive E2E tests inside Docker..."

          # ç¢ºä¿è¼¸å‡ºç›®éŒ„å­˜åœ¨
          mkdir -p "${{ github.workspace }}/test-results"

          docker run --rm \
            --name convertx-e2e-test \
            -v "${{ github.workspace }}/tests:/app/tests" \
            -v "${{ github.workspace }}/test-results:/app/test-results" \
            -e CI=true \
            -e NODE_ENV=test \
            --entrypoint /bin/bash \
            ${{ needs.build-test-image.outputs.image }} \
            -c "
              echo 'ðŸ“‹ ç³»çµ±è³‡è¨Š System info:'
              uname -a
              
              echo ''
              echo 'ðŸ”§ å¯ç”¨è½‰æ›å·¥å…· Available conversion tools:'
              echo '  inkscape:' \$(inkscape --version 2>/dev/null | head -1 || echo 'æœªæ‰¾åˆ° not found')
              echo '  pandoc:' \$(pandoc --version 2>/dev/null | head -1 || echo 'æœªæ‰¾åˆ° not found')
              echo '  ffmpeg:' \$(ffmpeg -version 2>/dev/null | head -1 || echo 'æœªæ‰¾åˆ° not found')
              echo '  libreoffice:' \$(soffice --version 2>/dev/null || echo 'æœªæ‰¾åˆ° not found')
              echo '  imagemagick:' \$(magick --version 2>/dev/null | head -1 || echo 'æœªæ‰¾åˆ° not found')
              echo '  calibre:' \$(ebook-convert --version 2>/dev/null | head -1 || echo 'æœªæ‰¾åˆ° not found')
              echo '  potrace:' \$(potrace -v 2>/dev/null | head -1 || echo 'æœªæ‰¾åˆ° not found')
              echo '  dasel:' \$(dasel --version 2>/dev/null || echo 'æœªæ‰¾åˆ° not found')
              echo '  resvg:' \$(resvg --version 2>/dev/null || echo 'æœªæ‰¾åˆ° not found')
              echo '  vips:' \$(vips --version 2>/dev/null || echo 'æœªæ‰¾åˆ° not found')
              echo '  pdf2zh:' \$(pdf2zh --version 2>/dev/null || echo 'æœªæ‰¾åˆ° not found')
              echo '  babeldoc:' \$(babeldoc --version 2>/dev/null || echo 'æœªæ‰¾åˆ° not found')
              
              echo ''
              echo 'ðŸ“¦ å®‰è£æ¸¬è©¦ä¾è³´ Installing test dependencies...'
              cd /app
              bun install --frozen-lockfile || bun install
              
              echo ''
              echo 'ðŸ§ª åŸ·è¡Œ E2E æ¸¬è©¦ Running E2E tests...'
              
              # åŸ·è¡Œç¶œåˆæ¸¬è©¦ï¼ˆå…è¨±å¤±æ•—ï¼‰
              bun test tests/e2e/comprehensive.e2e.test.ts --timeout 600000 || echo 'âš ï¸ ç¶œåˆæ¸¬è©¦æœ‰éƒ¨åˆ†å¤±æ•—'
              
              # åŸ·è¡Œæ ¼å¼çŸ©é™£æ¸¬è©¦ï¼ˆå…è¨±å¤±æ•—ï¼‰
              bun test tests/e2e/format-matrix.e2e.test.ts --timeout 300000 || echo 'âš ï¸ æ ¼å¼çŸ©é™£æ¸¬è©¦æœ‰éƒ¨åˆ†å¤±æ•—'
              
              # åŸ·è¡ŒåŸºç¤Žè½‰æ›å™¨æ¸¬è©¦ï¼ˆå…è¨±å¤±æ•—ï¼‰
              bun test tests/e2e/converters.e2e.test.ts --timeout 120000 || echo 'âš ï¸ è½‰æ›å™¨æ¸¬è©¦æœ‰éƒ¨åˆ†å¤±æ•—'
              
              echo ''
              echo 'âœ… E2E æ¸¬è©¦å®Œæˆï¼'
              
              # è¤‡è£½çµæžœåˆ°è¼¸å‡ºç›®éŒ„
              mkdir -p /app/test-results
              cp -r tests/e2e/output/* /app/test-results/ 2>/dev/null || echo 'âš ï¸ ç„¡æ¸¬è©¦è¼¸å‡ºå¯è¤‡è£½'
              ls -la /app/test-results/ 2>/dev/null || echo 'ðŸ“ æ¸¬è©¦çµæžœç›®éŒ„ç‚ºç©º'
            "

          # æª¢æŸ¥è¼¸å‡ºç›®éŒ„å…§å®¹
          echo "ðŸ“ æ¸¬è©¦çµæžœç›®éŒ„å…§å®¹ï¼š"
          ls -la "${{ github.workspace }}/test-results/" || echo "ç›®éŒ„ç‚ºç©ºæˆ–ä¸å­˜åœ¨"

      - name: Create placeholder if no results
        if: always()
        run: |
          mkdir -p test-results
          if [ -z "$(ls -A test-results 2>/dev/null)" ]; then
            echo '{"message": "ç„¡æ¸¬è©¦çµæžœè¼¸å‡º", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > test-results/placeholder.json
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: test-results/
          retention-days: 7
          if-no-files-found: warn

  # ============================================
  # Job 4: Translation tests (ä½¿ç”¨å…è²»ç¿»è­¯æœå‹™)
  # ä½¿ç”¨ Google/Bing å…è²»ç¿»è­¯ï¼Œä¸éœ€è¦ä»˜è²» API é‡‘é‘°
  # ============================================
  translation-tests:
    name: Translation Tests (Free Services)
    runs-on: ubuntu-24.04
    needs: build-test-image
    if: ${{ github.event.inputs.run_translation_tests == 'true' || github.event_name == 'push' }}
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull test image
        run: docker pull ${{ needs.build-test-image.outputs.image }}

      - name: Run translation tests
        run: |
          echo "ðŸŒ åŸ·è¡Œç¿»è­¯æ¸¬è©¦ï¼ˆä½¿ç”¨å…è²»æœå‹™ï¼šGoogle/Bingï¼‰..."

          # ç¢ºä¿è¼¸å‡ºç›®éŒ„å­˜åœ¨
          mkdir -p "${{ github.workspace }}/translation-results"

          docker run --rm \
            --name convertx-translation-test \
            -v "${{ github.workspace }}/tests:/app/tests" \
            -v "${{ github.workspace }}/translation-results:/app/translation-results" \
            -e CI=true \
            -e PDFMATHTRANSLATE_SERVICE=google \
            -e BABELDOC_SERVICE=google \
            --entrypoint /bin/bash \
            ${{ needs.build-test-image.outputs.image }} \
            -c "
              cd /app
              bun install --frozen-lockfile || bun install
              
              echo 'ðŸŒ ä½¿ç”¨å…è²»æœå‹™åŸ·è¡Œç¿»è­¯æ¸¬è©¦...'
              bun test tests/e2e/translation.e2e.test.ts --timeout 600000 || echo 'âš ï¸ ç¿»è­¯æ¸¬è©¦æœ‰éƒ¨åˆ†å¤±æ•—'
              
              mkdir -p /app/translation-results
              cp -r tests/e2e/output/translation/* /app/translation-results/ 2>/dev/null || echo 'âš ï¸ ç„¡ç¿»è­¯è¼¸å‡ºå¯è¤‡è£½'
              ls -la /app/translation-results/ 2>/dev/null || echo 'ðŸ“ ç¿»è­¯çµæžœç›®éŒ„ç‚ºç©º'
            "

          # æª¢æŸ¥è¼¸å‡ºç›®éŒ„å…§å®¹
          echo "ðŸ“ ç¿»è­¯çµæžœç›®éŒ„å…§å®¹ï¼š"
          ls -la "${{ github.workspace }}/translation-results/" || echo "ç›®éŒ„ç‚ºç©ºæˆ–ä¸å­˜åœ¨"

      - name: Create placeholder if no results
        if: always()
        run: |
          mkdir -p translation-results
          if [ -z "$(ls -A translation-results 2>/dev/null)" ]; then
            echo '{"message": "ç„¡ç¿»è­¯çµæžœè¼¸å‡º", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > translation-results/placeholder.json
          fi

      - name: Upload translation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: translation-test-results
          path: translation-results/
          retention-days: 7
          if-no-files-found: warn

  # ============================================
  # Job 5: Cleanup test image
  # ============================================
  cleanup:
    name: Cleanup Test Image
    runs-on: ubuntu-24.04
    needs: [e2e-tests, comprehensive-e2e]
    if: always()
    permissions:
      packages: write

    steps:
      - name: Delete test image
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = `test-${{ github.sha }}`;
            console.log(`ðŸ—‘ï¸ Attempting to delete test image with tag: ${tag}`);

            // Note: This requires ghcr.io API access which may need additional setup
            // For now, images will be cleaned up by retention policies
            console.log('Test images will be cleaned up by retention policies');

  # ============================================
  # Job 6: Test summary
  # ============================================
  summary:
    name: Test Summary
    runs-on: ubuntu-24.04
    needs: [e2e-tests, comprehensive-e2e]
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/
        continue-on-error: true

      - name: Check downloaded results
        run: |
          echo "ðŸ“ å·²ä¸‹è¼‰çš„æ¸¬è©¦çµæžœï¼š"
          ls -la test-results/ 2>/dev/null || echo "ç„¡æ¸¬è©¦çµæžœå¯ä¸‹è¼‰"

      - name: Generate summary
        run: |
          echo "# ðŸ§ª Docker E2E æ¸¬è©¦çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æ¸¬è©¦ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ä»»å‹™ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E æ¸¬è©¦ | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç¶œåˆ E2E æ¸¬è©¦ | ${{ needs.comprehensive-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "test-results/format-matrix/matrix-summary.md" ]; then
            echo "## æ ¼å¼çŸ©é™£æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
            cat test-results/format-matrix/matrix-summary.md >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "test-results/comprehensive/conversion-matrix.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## è½‰æ›çŸ©é™£" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -50 test-results/comprehensive/conversion-matrix.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… æ¸¬è©¦å®Œæˆæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
