# ============================================================
# é ç«¯æœå‹™æ›´æ–°ï¼ˆRemote Service Update via Tailscale SSHï¼‰
# ============================================================
# èªªæ˜ï¼šé€é Tailscale SSH é€£ç·šåˆ°é ç«¯ä¸»æ©Ÿï¼Œæ›´æ–° Docker æœå‹™
# åŠŸèƒ½ï¼šåœæ­¢æœå‹™ â†’ æ‹‰å–æœ€æ–°æ˜ åƒ â†’ åˆªé™¤èˆŠæ˜ åƒ â†’ é‡æ–°å•Ÿå‹•
# ============================================================

name: Update Remote Service

on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      prune_images:
        description: "æ˜¯å¦æ¸…ç† ConvertX-CN èˆŠæ˜ åƒï¼Ÿ"
        required: false
        default: true
        type: boolean

# ============================================================
# ç’°å¢ƒè®Šæ•¸è¨­å®š
# ============================================================
env:
  # é ç«¯ä¸»æ©Ÿå°ˆæ¡ˆç›®éŒ„
  REMOTE_PROJECT_DIR: /home/bioailab/miniconda3/lid/app/convertx-cn
  # å®¹å™¨åç¨±ï¼ˆç”¨æ–¼é¡¯ç¤º logï¼‰
  CONTAINER_NAME: convertx-cn

jobs:
  update-service:
    name: ğŸ”„ æ›´æ–°é ç«¯æœå‹™
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # Step 1: å•Ÿå‹• Tailscaleï¼ˆéäº’å‹•æ¨¡å¼ï¼‰
      # ========================================
      - name: ğŸ”— å•Ÿå‹• Tailscale é€£ç·š
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          args: "--ssh --accept-dns=false --accept-routes=false"

      # ========================================
      # Step 2: é©—è­‰ Tailscale é€£ç·š
      # ========================================
      - name: âœ… é©—è­‰ Tailscale é€£ç·šç‹€æ…‹
        run: |
          echo "========================================"
          echo "ğŸ” æª¢æŸ¥ Tailscale é€£ç·šç‹€æ…‹"
          echo "========================================"

          echo ""
          echo "ğŸ“Š Tailscale ç‹€æ…‹ï¼š"
          tailscale status

          echo ""
          echo "ğŸŒ æœ¬æ©Ÿ Tailscale IPï¼š"
          TAILSCALE_IP=$(tailscale ip -4)
          echo "${TAILSCALE_IP}"

          echo ""
          echo "ğŸ” æª¢æŸ¥ SSH åŠŸèƒ½ç‹€æ…‹ï¼š"
          if tailscale status --json | grep -q '"SSH":true'; then
            echo "âœ… Tailscale SSH åŠŸèƒ½å·²å•Ÿç”¨"
          else
            echo "âš ï¸ æ­£åœ¨æª¢æŸ¥ SSH ç‹€æ…‹..."
            tailscale status --json | head -50
          fi

          echo ""
          echo "â³ ç­‰å¾… Tailscale é€£ç·šç©©å®š..."
          sleep 5

          echo ""
          echo "ğŸ“¡ æ¸¬è©¦èˆ‡é ç«¯ä¸»æ©Ÿçš„é€£é€šæ€§..."
          echo "ç›®æ¨™ä¸»æ©Ÿ: ${{ secrets.SSH_HOST }}"

          if tailscale ping --c 3 "${{ secrets.SSH_HOST }}"; then
            echo ""
            echo "âœ… Tailscale é€£ç·šæ¸¬è©¦æˆåŠŸï¼"
          else
            echo ""
            echo "âš ï¸ Tailscale ping å¤±æ•—ï¼Œä½† SSH å¯èƒ½ä»å¯é‹ä½œï¼Œç¹¼çºŒåŸ·è¡Œ..."
          fi

          echo "========================================"

      # ========================================
      # Step 3: Tailscale SSH é€£ç·šï¼ˆæ‰‹å‹•ç¶²é é©—è­‰ï¼‰
      # èªªæ˜ï¼šé¦–æ¬¡é€£ç·šéœ€è¦é»æ“Šé©—è­‰ URL å®Œæˆæˆæ¬Š
      # ========================================
      - name: ğŸ” æ¸¬è©¦ Tailscale SSH é€£ç·š
        run: |
          echo "========================================"
          echo "ğŸ” æ¸¬è©¦ Tailscale SSH é€£ç·š"
          echo "========================================"
          echo "ä½¿ç”¨è€…: ${{ secrets.SSH_USER }}"
          echo "ä¸»æ©Ÿ: ${{ secrets.SSH_HOST }}"
          echo ""
          echo "âš ï¸  å¦‚æœå‡ºç¾é©—è­‰ URLï¼Œè«‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿä¸¦å®Œæˆé©—è­‰"
          echo "â³ é©—è­‰å®Œæˆå¾Œï¼Œé€£ç·šæœƒè‡ªå‹•ç¹¼çºŒ..."
          echo ""
          echo "========================================"

          timeout 600 tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "echo 'âœ… Tailscale SSH é€£ç·šæˆåŠŸï¼' && echo 'ä¸»æ©Ÿåç¨±:' && hostname && echo 'ç•¶å‰ä½¿ç”¨è€…:' && whoami" \
            || { echo ""; echo "âŒ SSH é€£ç·šå¤±æ•—æˆ–è¶…æ™‚ï¼Œè«‹ç¢ºèªå·²å®Œæˆç¶²é é©—è­‰"; exit 1; }

          echo ""
          echo "========================================"

      # ========================================
      # Step 4: é¡¯ç¤ºæ›´æ–°å‰æœå‹™ç‹€æ…‹
      # ========================================
      - name: ğŸ“‹ æ›´æ–°å‰æœå‹™ç‹€æ…‹
        run: |
          echo "========================================"
          echo "ğŸ“‹ æ›´æ–°å‰æœå‹™ç‹€æ…‹"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          cd /home/bioailab/miniconda3/lid/app/convertx-cn

          echo "ğŸ“¦ ç›®å‰é‹è¡Œçš„å®¹å™¨ï¼ˆdocker compose psï¼‰ï¼š"
          docker compose ps

          echo ""
          echo "ğŸ·ï¸ ç›®å‰ä½¿ç”¨çš„æ˜ åƒç‰ˆæœ¬ï¼š"
          docker compose images

          echo ""
          echo "ğŸ³ ConvertX-CN å®¹å™¨ç‹€æ…‹ï¼ˆdocker psï¼‰ï¼š"
          docker ps --filter "name=convertx" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

          echo ""
          echo "ğŸ’¾ ç£ç¢Ÿç©ºé–“ä½¿ç”¨æƒ…æ³ï¼š"
          df -h / | head -2
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 5: åœæ­¢æœå‹™
      # ========================================
      - name: â¹ï¸ åœæ­¢æœå‹™
        run: |
          echo "========================================"
          echo "â¹ï¸ åœæ­¢æœå‹™"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          cd /home/bioailab/miniconda3/lid/app/convertx-cn

          echo "ğŸ“‹ åœæ­¢ Docker Compose æœå‹™..."
          docker compose down

          echo ""
          echo "âœ… æœå‹™å·²åœæ­¢"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 6: æ‹‰å–æœ€æ–°æ˜ åƒ
      # ========================================
      - name: ğŸ“¥ æ‹‰å–æœ€æ–°æ˜ åƒ
        run: |
          echo "========================================"
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°æ˜ åƒ"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          cd /home/bioailab/miniconda3/lid/app/convertx-cn

          echo "ğŸ“‹ æ‹‰å–æœ€æ–° Docker æ˜ åƒ..."
          docker compose pull

          echo ""
          echo "âœ… æ˜ åƒæ‹‰å–å®Œæˆ"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 7: æ¸…ç† ConvertX-CN èˆŠæ˜ åƒï¼ˆå¯é¸ï¼‰
      # ========================================
      - name: ğŸ§¹ æ¸…ç† ConvertX-CN èˆŠæ˜ åƒ
        if: ${{ github.event.inputs.prune_images == 'true' }}
        run: |
          echo "========================================"
          echo "ğŸ§¹ æ¸…ç† ConvertX-CN èˆŠæ˜ åƒ"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          echo "ğŸ“‹ æ¸…ç†å‰çš„ ConvertX-CN æ˜ åƒï¼š"
          docker images | grep -E "convertx/convertx-cn|REPOSITORY" | head -10

          echo ""
          echo "ğŸ—‘ï¸ ç§»é™¤ ConvertX-CN èˆŠç‰ˆæ˜ åƒï¼ˆä¿ç•™ latestï¼‰..."
          docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" | \
            grep "convertx/convertx-cn" | \
            grep -v ":latest" | \
            awk '{print $2}' | \
            xargs -r docker rmi 2>/dev/null || true

          echo ""
          echo "ğŸ“‹ æ¸…ç†å¾Œçš„ ConvertX-CN æ˜ åƒï¼š"
          docker images | grep -E "convertx/convertx-cn|REPOSITORY" | head -10

          echo ""
          echo "ğŸ’¾ ç£ç¢Ÿç©ºé–“ï¼š"
          df -h / | head -2

          echo ""
          echo "âœ… ConvertX-CN èˆŠæ˜ åƒæ¸…ç†å®Œæˆ"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 8: é‡æ–°å•Ÿå‹•æœå‹™
      # ========================================
      - name: â–¶ï¸ é‡æ–°å•Ÿå‹•æœå‹™
        run: |
          echo "========================================"
          echo "â–¶ï¸ é‡æ–°å•Ÿå‹•æœå‹™"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          cd /home/bioailab/miniconda3/lid/app/convertx-cn

          echo "ğŸ“‹ å•Ÿå‹• Docker Compose æœå‹™..."
          docker compose up -d

          echo ""
          echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
          sleep 10

          echo ""
          echo "ğŸ“¦ æœå‹™ç‹€æ…‹ï¼ˆdocker compose psï¼‰ï¼š"
          docker compose ps

          echo ""
          echo "ğŸ³ ConvertX-CN å®¹å™¨ç‹€æ…‹ï¼ˆdocker psï¼‰ï¼š"
          docker ps --filter "name=convertx" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

          echo ""
          echo "âœ… æœå‹™å·²é‡æ–°å•Ÿå‹•"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 9: é¡¯ç¤ºæœå‹™ Log
      # ========================================
      - name: ğŸ“œ é¡¯ç¤ºæœå‹™ Log
        run: |
          echo "========================================"
          echo "ğŸ“œ æœå‹™å•Ÿå‹• Logï¼ˆå…¨éƒ¨ï¼‰"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          echo "ğŸ“‹ ConvertX-CN å®¹å™¨ Logï¼š"
          docker logs convertx-cn 2>&1 || echo "âš ï¸ ç„¡æ³•å–å¾— logï¼Œå®¹å™¨å¯èƒ½å°šæœªå®Œå…¨å•Ÿå‹•"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 10: å¥åº·æª¢æŸ¥
      # ========================================
      - name: ğŸ¥ å¥åº·æª¢æŸ¥
        run: |
          echo "========================================"
          echo "ğŸ¥ æœå‹™å¥åº·æª¢æŸ¥"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          cd /home/bioailab/miniconda3/lid/app/convertx-cn

          echo "ğŸ“‹ å®¹å™¨é‹è¡Œç‹€æ…‹ï¼ˆdocker compose psï¼‰ï¼š"
          docker compose ps

          echo ""
          echo "ğŸ·ï¸ ç›®å‰ä½¿ç”¨çš„æ˜ åƒç‰ˆæœ¬ï¼š"
          docker compose images

          echo ""
          echo "ğŸ³ ConvertX-CN å®¹å™¨ç‹€æ…‹ï¼ˆdocker psï¼‰ï¼š"
          docker ps --filter "name=convertx" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

          # æª¢æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸é‹è¡Œ
          if docker ps --filter "name=convertx-cn" --format "{{.Names}}" | grep -q "convertx-cn"; then
            echo ""
            echo "âœ… ConvertX-CN æœå‹™é‹è¡Œæ­£å¸¸ï¼"
          else
            echo ""
            echo "âŒ è­¦å‘Šï¼šConvertX-CN å®¹å™¨æœªé‹è¡Œï¼"
            exit 1
          fi
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 11: å®Œæˆæ‘˜è¦
      # ========================================
      - name: ğŸ“‹ æ›´æ–°å®Œæˆæ‘˜è¦
        run: |
          echo "========================================"
          echo "âœ… é ç«¯æœå‹™æ›´æ–°å®Œæˆï¼"
          echo "========================================"
          echo ""
          echo "ğŸ“¦ æ›´æ–°è³‡è¨Šï¼š"
          echo "  - å°ˆæ¡ˆç›®éŒ„: /home/bioailab/miniconda3/lid/app/convertx-cn"
          echo "  - é ç«¯ä¸»æ©Ÿ: ${{ secrets.SSH_HOST }}"
          echo "  - æ¸…ç†èˆŠæ˜ åƒ: ${{ github.event.inputs.prune_images }}"
          echo ""
          echo "ğŸ”§ åŸ·è¡Œçš„æ“ä½œï¼š"
          echo "  1. â¹ï¸ åœæ­¢æœå‹™"
          echo "  2. ğŸ“¥ æ‹‰å–æœ€æ–°æ˜ åƒ"
          if [ "${{ github.event.inputs.prune_images }}" == "true" ]; then
            echo "  3. ğŸ§¹ æ¸…ç† ConvertX-CN èˆŠæ˜ åƒ"
          fi
          echo "  4. â–¶ï¸ é‡æ–°å•Ÿå‹•æœå‹™"
          echo "  5. ğŸ“œ é¡¯ç¤ºæœå‹™ Log"
          echo "  6. ğŸ¥ å¥åº·æª¢æŸ¥"
          echo ""
          echo "========================================"
          echo "ğŸ‰ æ‰€æœ‰æ­¥é©Ÿå·²æˆåŠŸå®Œæˆï¼"
          echo "========================================"
