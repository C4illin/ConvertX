# ============================================================
# Docker Build & Pushï¼ˆRemote Host via Tailscale SSHï¼‰
# ============================================================
# èªªæ˜ï¼šä½¿ç”¨ Tailscale SSH é€£ç·šåˆ°ç§æœ‰ä¸»æ©ŸåŸ·è¡Œ Docker build
# é‡è¦ï¼šæ­¤ workflow å®Œå…¨ä¸ä½¿ç”¨å‚³çµ± SSH keyï¼Œåƒ…ä½¿ç”¨ Tailscale SSH
# ============================================================

name: Docker Build & Push (Remote Host via Tailscale)

on:
  # æ‰‹å‹•è§¸ç™¼ï¼Œæ”¯æ´è¼¸å…¥ image tag
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker Image Tagï¼ˆä¾‹å¦‚ï¼š0.1.10.testï¼‰"
        required: true
        default: "0.1.10.test"
        type: string

# ============================================================
# ç’°å¢ƒè®Šæ•¸è¨­å®š
# ============================================================
env:
  # é ç«¯ä¸»æ©Ÿå·¥ä½œç›®éŒ„
  REMOTE_WORKDIR: /home/bioailab/miniconda3/lid/app/docker_build
  # å°ˆæ¡ˆåç¨±
  PROJECT_NAME: ConvertX-CN
  # Docker Hub æ˜ åƒåº«
  DOCKER_IMAGE_REPO: convertx/convertx-cn

jobs:
  build-and-push:
    name: ğŸš€ é ç«¯ Docker Build & Push
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # Step 1: Checkout repository
      # èªªæ˜ï¼šæª¢å‡ºç¨‹å¼ç¢¼ï¼ˆé›–ç„¶ build åœ¨é ç«¯ï¼Œä½†éœ€è¦ workflow å®Œæ•´æ€§ï¼‰
      # ========================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # Step 2: å•Ÿå‹• Tailscaleï¼ˆéäº’å‹•æ¨¡å¼ï¼‰
      # èªªæ˜ï¼šä½¿ç”¨ Tailscale Auth Key åŠ å…¥ tailnetï¼Œå•Ÿç”¨ SSH
      # é‡è¦ï¼šå¿…é ˆä½¿ç”¨ --ssh åƒæ•¸æ‰èƒ½ä½¿ç”¨ tailscale ssh
      # ========================================
      - name: ğŸ”— å•Ÿå‹• Tailscale é€£ç·šï¼ˆéäº’å‹•æ¨¡å¼ï¼‰
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          args: "--ssh --accept-dns=false --accept-routes=false"
          # ä½¿ç”¨ ephemeral keyï¼Œrunner çµæŸå¾Œè‡ªå‹•é›¢é–‹ tailnet
          # --ssh: å•Ÿç”¨ Tailscale SSH åŠŸèƒ½
          # --accept-dns=false: ä¸ä½¿ç”¨ Tailscale DNS
          # --accept-routes=false: ä¸æ¥å—å…¶ä»–ç¯€é»çš„è·¯ç”±

      # ========================================
      # Step 3: é©—è­‰ Tailscale é€£ç·š
      # èªªæ˜ï¼šç¢ºèª Tailscale å·²æˆåŠŸé€£ç·šä¸¦é¡¯ç¤ºç‹€æ…‹
      # ========================================
      - name: âœ… é©—è­‰ Tailscale é€£ç·šç‹€æ…‹
        run: |
          echo "========================================"
          echo "ğŸ” æª¢æŸ¥ Tailscale é€£ç·šç‹€æ…‹"
          echo "========================================"

          # é¡¯ç¤º Tailscale ç‹€æ…‹
          echo ""
          echo "ğŸ“Š Tailscale ç‹€æ…‹ï¼š"
          tailscale status

          # é¡¯ç¤ºæœ¬æ©Ÿ Tailscale IP
          echo ""
          echo "ğŸŒ æœ¬æ©Ÿ Tailscale IPï¼š"
          TAILSCALE_IP=$(tailscale ip -4)
          echo "${TAILSCALE_IP}"

          # ç¢ºèª SSH åŠŸèƒ½å·²å•Ÿç”¨
          echo ""
          echo "ğŸ” æª¢æŸ¥ SSH åŠŸèƒ½ç‹€æ…‹ï¼š"
          if tailscale status --json | grep -q '"SSH":true'; then
            echo "âœ… Tailscale SSH åŠŸèƒ½å·²å•Ÿç”¨"
          else
            echo "âš ï¸ æ­£åœ¨æª¢æŸ¥ SSH ç‹€æ…‹..."
            tailscale status --json | head -50
          fi

          # ç­‰å¾… Tailscale å®Œå…¨é€£ç·š
          echo ""
          echo "â³ ç­‰å¾… Tailscale é€£ç·šç©©å®š..."
          sleep 5

          # æ¸¬è©¦èˆ‡ç›®æ¨™ä¸»æ©Ÿçš„é€£é€šæ€§
          echo ""
          echo "ğŸ“¡ æ¸¬è©¦èˆ‡é ç«¯ä¸»æ©Ÿçš„é€£é€šæ€§..."
          echo "ç›®æ¨™ä¸»æ©Ÿ: ${{ secrets.SSH_HOST }}"

          if tailscale ping --c 3 "${{ secrets.SSH_HOST }}"; then
            echo ""
            echo "âœ… Tailscale é€£ç·šæ¸¬è©¦æˆåŠŸï¼"
          else
            echo ""
            echo "âš ï¸ Tailscale ping å¤±æ•—ï¼Œä½† SSH å¯èƒ½ä»å¯é‹ä½œï¼Œç¹¼çºŒåŸ·è¡Œ..."
          fi

          echo "========================================"

      # ========================================
      # Step 4: Tailscale SSH é€£ç·šï¼ˆæ‰‹å‹•ç¶²é é©—è­‰ï¼‰
      # èªªæ˜ï¼šé¦–æ¬¡é€£ç·šéœ€è¦é»æ“Šé©—è­‰ URL å®Œæˆæˆæ¬Š
      # ========================================
      - name: ğŸ” æ¸¬è©¦ Tailscale SSH é€£ç·š
        run: |
          echo "========================================"
          echo "ğŸ” æ¸¬è©¦ Tailscale SSH é€£ç·š"
          echo "========================================"
          echo "ä½¿ç”¨è€…: ${{ secrets.SSH_USER }}"
          echo "ä¸»æ©Ÿ: ${{ secrets.SSH_HOST }}"
          echo ""
          echo "âš ï¸  å¦‚æœå‡ºç¾é©—è­‰ URLï¼Œè«‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿä¸¦å®Œæˆé©—è­‰"
          echo "â³ é©—è­‰å®Œæˆå¾Œï¼Œé€£ç·šæœƒè‡ªå‹•ç¹¼çºŒ..."
          echo ""
          echo "========================================"

          # åŸ·è¡Œ SSH é€£ç·šï¼Œè¼¸å‡ºæœƒåŒ…å«é©—è­‰é€£çµ
          # ä½¿ç”¨ timeout é¿å…ç„¡é™ç­‰å¾…ï¼ˆ10 åˆ†é˜ï¼‰
          timeout 600 tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "echo 'âœ… Tailscale SSH é€£ç·šæˆåŠŸï¼' && echo 'ä¸»æ©Ÿåç¨±:' && hostname && echo 'ç•¶å‰ä½¿ç”¨è€…:' && whoami" \
            || { echo ""; echo "âŒ SSH é€£ç·šå¤±æ•—æˆ–è¶…æ™‚ï¼Œè«‹ç¢ºèªå·²å®Œæˆç¶²é é©—è­‰"; exit 1; }

          echo ""
          echo "========================================"

      # ========================================
      # Step 5: Smoke Testï¼ˆç’°å¢ƒé©—è­‰ï¼‰
      # èªªæ˜ï¼šå¿«é€Ÿé©—è­‰é ç«¯ç’°å¢ƒæ˜¯å¦æ­£å¸¸
      # ========================================
      - name: ğŸ§ª Smoke Testï¼ˆç’°å¢ƒé©—è­‰ï¼‰
        run: |
          echo "========================================"
          echo "ğŸ§ª Smoke Test - é©—è­‰é ç«¯ç’°å¢ƒ"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          echo "ğŸ“‹ æ¸¬è©¦é …ç›® 1ï¼šé€²å…¥ç›®æ¨™ç›®éŒ„"
          echo "----------------------------------------"
          WORKDIR="/home/bioailab/miniconda3/lid/app/docker_build"
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"
          echo "âœ… ç›®å‰ç›®éŒ„: $(pwd)"

          echo ""
          echo "ğŸ“‹ æ¸¬è©¦é …ç›® 2ï¼šGit ç‰ˆæœ¬"
          echo "----------------------------------------"
          git --version
          echo "âœ… Git å¯ç”¨"

          echo ""
          echo "ğŸ“‹ æ¸¬è©¦é …ç›® 3ï¼šDocker ç‰ˆæœ¬"
          echo "----------------------------------------"
          docker version --format '{{.Server.Version}}' || docker --version
          echo "âœ… Docker å¯ç”¨"

          echo ""
          echo "ğŸ“‹ æ¸¬è©¦é …ç›® 4ï¼šDocker Buildx ç‰ˆæœ¬"
          echo "----------------------------------------"
          docker buildx version
          echo "âœ… Docker Buildx å¯ç”¨"

          echo ""
          echo "========================================"
          echo "âœ… æ‰€æœ‰ Smoke Test é€šéï¼"
          echo "========================================"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 6: æº–å‚™é ç«¯å·¥ä½œç›®éŒ„
      # èªªæ˜ï¼šç¢ºä¿é ç«¯å·¥ä½œç›®éŒ„å­˜åœ¨
      # ========================================
      - name: ğŸ“ æº–å‚™é ç«¯å·¥ä½œç›®éŒ„
        run: |
          echo "========================================"
          echo "ğŸ“ æº–å‚™é ç«¯å·¥ä½œç›®éŒ„"
          echo "========================================"
          echo "å·¥ä½œç›®éŒ„: ${{ env.REMOTE_WORKDIR }}"
          echo ""

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p ${{ env.REMOTE_WORKDIR }} && echo 'âœ… å·¥ä½œç›®éŒ„å·²å°±ç·’'"

          echo "========================================"

      # ========================================
      # Step 7: Clone æˆ–æ›´æ–°å°ˆæ¡ˆç¨‹å¼ç¢¼
      # èªªæ˜ï¼šåœ¨é ç«¯ä¸»æ©Ÿä¸Š clone æˆ– pull æœ€æ–°ç¨‹å¼ç¢¼
      # ========================================
      - name: ğŸ“¥ Clone æˆ–æ›´æ–°å°ˆæ¡ˆç¨‹å¼ç¢¼
        run: |
          echo "========================================"
          echo "ğŸ“¥ Clone æˆ–æ›´æ–°å°ˆæ¡ˆç¨‹å¼ç¢¼"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          WORKDIR="${{ env.REMOTE_WORKDIR }}"
          PROJECT="${{ env.PROJECT_NAME }}"
          REPO_URL="https://github.com/pi-docket/ConvertX-CN.git"

          echo "ğŸ“‚ é€²å…¥å·¥ä½œç›®éŒ„: ${WORKDIR}"
          cd "${WORKDIR}"

          if [ -d "${PROJECT}" ]; then
            echo "ğŸ“¦ å°ˆæ¡ˆå·²å­˜åœ¨ï¼ŒåŸ·è¡Œ git pull..."
            cd "${PROJECT}"
            git fetch origin
            git reset --hard origin/main
            git pull origin main
            echo "âœ… ç¨‹å¼ç¢¼æ›´æ–°å®Œæˆ"
          else
            echo "ğŸ“¦ å°ˆæ¡ˆä¸å­˜åœ¨ï¼ŒåŸ·è¡Œ git clone..."
            git clone "${REPO_URL}" "${PROJECT}"
            cd "${PROJECT}"
            echo "âœ… å°ˆæ¡ˆ clone å®Œæˆ"
          fi

          echo ""
          echo "ğŸ“‹ ç›®å‰ commitï¼š"
          git log -1 --oneline

          echo ""
          echo "âœ… ç¨‹å¼ç¢¼æº–å‚™å®Œæˆ"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 8: Docker Login
      # èªªæ˜ï¼šåœ¨é ç«¯ä¸»æ©Ÿç™»å…¥ Docker Hub
      # ========================================
      - name: ğŸ” Docker Hub ç™»å…¥
        run: |
          echo "========================================"
          echo "ğŸ” Docker Hub ç™»å…¥"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "echo '${{ secrets.DOCKERHUB_TOKEN }}' | docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin && echo 'âœ… Docker Hub ç™»å…¥æˆåŠŸ'"

          echo "========================================"

      # ========================================
      # Step 9: è¨­å®š Docker Buildxï¼ˆMulti-Arch å¿…è¦ï¼‰
      # èªªæ˜ï¼šå»ºç«‹æ”¯æ´å¤šæ¶æ§‹çš„ buildx builder
      # ========================================
      - name: ğŸ”§ è¨­å®š Docker Buildx
        run: |
          echo "========================================"
          echo "ğŸ”§ è¨­å®š Docker Buildxï¼ˆMulti-Arch æ”¯æ´ï¼‰"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          BUILDER_NAME="multiarch-builder-${{ github.run_id }}"

          echo "ğŸ“‹ æª¢æŸ¥ç¾æœ‰ buildx builders..."
          docker buildx ls

          echo ""
          echo "ğŸ”§ å»ºç«‹æ–°çš„ multi-arch builder: ${BUILDER_NAME}"
          docker buildx create --name "${BUILDER_NAME}" --driver docker-container --use --bootstrap

          echo ""
          echo "âœ… Buildx builder å·²å°±ç·’"
          echo ""
          echo "ğŸ“‹ ç›®å‰ builder ç‹€æ…‹ï¼š"
          docker buildx inspect --bootstrap

          echo ""
          echo "ğŸ—ï¸ æ”¯æ´çš„å¹³å°ï¼š"
          docker buildx inspect | grep -i platforms || true
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 10: Multi-Arch Docker Build
      # èªªæ˜ï¼šä½¿ç”¨ buildx åŒæ™‚å»ºæ§‹ amd64 å’Œ arm64
      # ========================================
      - name: ğŸ”¨ Multi-Arch Docker Build
        run: |
          echo "========================================"
          echo "ğŸ”¨ é–‹å§‹ Multi-Arch Docker Build"
          echo "========================================"
          echo "æ˜ åƒåç¨±: ${{ env.DOCKER_IMAGE_REPO }}:${{ github.event.inputs.image_tag }}"
          echo "åŒæ™‚æ¨™è¨˜: ${{ env.DOCKER_IMAGE_REPO }}:latest"
          echo "ç›®æ¨™æ¶æ§‹: linux/amd64, linux/arm64"
          echo ""

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          WORKDIR="${{ env.REMOTE_WORKDIR }}"
          PROJECT="${{ env.PROJECT_NAME }}"
          IMAGE="${{ env.DOCKER_IMAGE_REPO }}:${{ github.event.inputs.image_tag }}"
          IMAGE_LATEST="${{ env.DOCKER_IMAGE_REPO }}:latest"
          BUILDER_NAME="multiarch-builder-${{ github.run_id }}"

          echo "ğŸ“‚ é€²å…¥å°ˆæ¡ˆç›®éŒ„..."
          cd "${WORKDIR}/${PROJECT}"
          pwd

          echo ""
          echo "ğŸ”¨ åŸ·è¡Œ Multi-Arch Docker buildx..."
          echo "æ˜ åƒæ¨™ç±¤: ${IMAGE}"
          echo "ç›®æ¨™å¹³å°: linux/amd64, linux/arm64"
          echo ""

          # ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ builder
          docker buildx use "${BUILDER_NAME}"

          # Multi-arch buildï¼ˆåªå»ºæ§‹ï¼Œä¸æ¨é€ï¼Œè¼‰å…¥åˆ°æœ¬åœ°ï¼‰
          # ä½¿ç”¨ --progress=plain é¡¯ç¤ºå®Œæ•´ log
          # åŒæ™‚æ¨™è¨˜ç‰ˆæœ¬è™Ÿå’Œ latest
          if ! docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "${IMAGE}" \
            -t "${IMAGE_LATEST}" \
            --progress=plain \
            . 2>&1; then
            
            echo ""
            echo "========================================"
            echo "âŒ Docker Build å¤±æ•—ï¼"
            echo "========================================"
            echo ""
            echo "ğŸ”§ å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆï¼š"
            echo ""
            echo "1ï¸âƒ£ apt-get å®‰è£å¤±æ•—ï¼ˆarm64 QEMU å•é¡Œï¼‰"
            echo "   â†’ å»ºè­°ï¼šæ‹†åˆ† apt-get install ç‚ºå¤šæ®µ RUN"
            echo "   â†’ æˆ–ï¼šå° arm64 è·³éä¸ç©©å®šå¥—ä»¶"
            echo ""
            echo "2ï¸âƒ£ ç¶²è·¯å•é¡Œ"
            echo "   â†’ å»ºè­°ï¼šåŠ å…¥ apt-get update --fix-missing"
            echo ""
            echo "3ï¸âƒ£ è¨˜æ†¶é«”ä¸è¶³"
            echo "   â†’ å»ºè­°ï¼šå¢åŠ  Docker è¨˜æ†¶é«”é™åˆ¶"
            echo ""
            exit 1
          fi

          echo ""
          echo "âœ… Multi-Arch Docker Build å®Œæˆï¼"
          echo ""
          echo "ğŸ—ï¸ å·²å»ºæ§‹çš„æ¶æ§‹ï¼š"
          echo "   - linux/amd64"
          echo "   - linux/arm64"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 11: Docker Push åˆ° Docker Hub
      # èªªæ˜ï¼šæ¨é€å»ºæ§‹å¥½çš„æ˜ åƒåˆ° Docker Hub
      # ========================================
      - name: ğŸ“¤ Docker Push åˆ° Docker Hub
        run: |
          echo "========================================"
          echo "ğŸ“¤ æ¨é€æ˜ åƒåˆ° Docker Hub"
          echo "========================================"
          echo "æ˜ åƒ: ${{ env.DOCKER_IMAGE_REPO }}:${{ github.event.inputs.image_tag }}"
          echo ""

          # æª¢æŸ¥ Docker Hub ç™»éŒ„ç‹€æ…‹ï¼Œæœªç™»éŒ„å‰‡é‡æ–°ç™»éŒ„
          echo "ğŸ” æª¢æŸ¥ Docker Hub ç™»éŒ„ç‹€æ…‹..."
          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          if docker info 2>/dev/null | grep -q "Username:"; then
            echo "âœ… Docker Hub å·²ç™»éŒ„"
          else
            echo "âš ï¸ Docker Hub æœªç™»éŒ„ï¼Œæ­£åœ¨é‡æ–°ç™»éŒ„..."
            echo '${{ secrets.DOCKERHUB_TOKEN }}' | docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin
            echo "âœ… Docker Hub é‡æ–°ç™»éŒ„æˆåŠŸ"
          fi
          EOF

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          WORKDIR="${{ env.REMOTE_WORKDIR }}"
          PROJECT="${{ env.PROJECT_NAME }}"
          IMAGE="${{ env.DOCKER_IMAGE_REPO }}:${{ github.event.inputs.image_tag }}"
          IMAGE_LATEST="${{ env.DOCKER_IMAGE_REPO }}:latest"
          BUILDER_NAME="multiarch-builder-${{ github.run_id }}"

          echo "ğŸ“‚ é€²å…¥å°ˆæ¡ˆç›®éŒ„..."
          cd "${WORKDIR}/${PROJECT}"

          echo ""
          echo "ğŸ“¤ åŸ·è¡Œ Docker Push..."
          echo "æ˜ åƒæ¨™ç±¤: ${IMAGE}"
          echo "åŒæ™‚æ¨™è¨˜: ${IMAGE_LATEST}"
          echo ""

          # ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ builder
          docker buildx use "${BUILDER_NAME}"

          # ä½¿ç”¨ buildx build --push ä¾†æ¨é€ multi-arch æ˜ åƒ
          # åŒæ™‚æ¨é€ç‰ˆæœ¬è™Ÿå’Œ latest
          if ! docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "${IMAGE}" \
            -t "${IMAGE_LATEST}" \
            --push \
            --progress=plain \
            . 2>&1; then
            
            echo ""
            echo "========================================"
            echo "âŒ Docker Push å¤±æ•—ï¼"
            echo "========================================"
            echo ""
            echo "ğŸ”§ å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. Docker Hub ç™»å…¥å·²éæœŸ"
            echo "  2. ç¶²è·¯é€£ç·šå•é¡Œ"
            echo "  3. Docker Hub é…é¡é™åˆ¶"
            echo ""
            exit 1
          fi

          echo ""
          echo "âœ… Docker Push å®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ æ˜ åƒå·²æ¨é€è‡³ Docker Hubï¼š"
          echo "   ${IMAGE}"
          echo "   ${IMAGE_LATEST}"
          echo ""
          echo "ğŸ—ï¸ æ”¯æ´çš„æ¶æ§‹ï¼š"
          echo "   - linux/amd64"
          echo "   - linux/arm64"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 13: é©—è­‰ Docker Hub æ˜ åƒ
      # èªªæ˜ï¼šç¢ºèªæ˜ åƒå·²æˆåŠŸæ¨é€ä¸¦æª¢æŸ¥æ¶æ§‹
      # ========================================
      - name: âœ… é©—è­‰ Docker Hub æ˜ åƒ
        run: |
          echo "========================================"
          echo "âœ… é©—è­‰ Docker Hub æ˜ åƒ"
          echo "========================================"
          echo "æ˜ åƒ: ${{ env.DOCKER_IMAGE_REPO }}:${{ github.event.inputs.image_tag }}"
          echo ""

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          IMAGE="${{ env.DOCKER_IMAGE_REPO }}:${{ github.event.inputs.image_tag }}"

          echo "ğŸ“‹ æª¢æŸ¥æ˜ åƒ manifestï¼ˆé¡¯ç¤ºæ”¯æ´çš„æ¶æ§‹ï¼‰..."
          echo ""

          docker buildx imagetools inspect "${IMAGE}"

          echo ""
          echo "âœ… æ˜ åƒé©—è­‰å®Œæˆ"
          REMOTE_EOF

          echo "========================================"

      # ========================================
      # Step 14: æ¸…ç†æœ¬æ¬¡ Build è³‡æº
      # èªªæ˜ï¼šåªæ¸…ç†æœ¬æ¬¡ build ç”¢ç”Ÿçš„ builder å’Œ cache
      # ========================================
      - name: ğŸ§¹ æ¸…ç†æœ¬æ¬¡ Build è³‡æº
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ§¹ æ¸…ç†æœ¬æ¬¡ Build è³‡æº"
          echo "========================================"
          echo "Builder åç¨±: multiarch-builder-${{ github.run_id }}"
          echo ""

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'REMOTE_EOF'
          set -e

          BUILDER_NAME="multiarch-builder-${{ github.run_id }}"

          echo "ğŸ—‘ï¸ ç§»é™¤æœ¬æ¬¡ä½¿ç”¨çš„ buildx builder..."
          if docker buildx rm "${BUILDER_NAME}" 2>/dev/null; then
            echo "âœ… Builder ${BUILDER_NAME} å·²ç§»é™¤"
          else
            echo "âš ï¸ Builder å¯èƒ½å·²è¢«ç§»é™¤æˆ–ä¸å­˜åœ¨"
          fi

          echo ""
          echo "ğŸ—‘ï¸ æ¸…ç†æœ¬æ¬¡ build ç”¢ç”Ÿçš„ cache..."
          # åªæ¸…ç† buildx çš„ dangling cacheï¼Œä¸å½±éŸ¿å…¶ä»– image
          docker buildx prune -f --filter "until=1h" 2>/dev/null || true
          echo "âœ… Build cache å·²æ¸…ç†"

          echo ""
          echo "ğŸ“‹ ç›®å‰å‰©é¤˜çš„ buildersï¼š"
          docker buildx ls

          echo ""
          echo "ğŸ“¦ ç›®å‰å‰©é¤˜çš„ convertx ç›¸é—œæ˜ åƒï¼š"
          docker images | grep convertx || echo "ï¼ˆç„¡æœ¬åœ° convertx ç›¸é—œæ˜ åƒï¼Œå› ä½¿ç”¨ --push ç›´æ¥æ¨é€ï¼‰"
          REMOTE_EOF

          echo ""
          echo "âœ… æ¸…ç†å®Œæˆï¼ˆåƒ…æ¸…ç†æœ¬æ¬¡ build çš„è³‡æºï¼‰"
          echo "========================================"

      # ========================================
      # Step 15: Docker Logout
      # èªªæ˜ï¼šç™»å‡º Docker Hub
      # ========================================
      - name: ğŸ”’ Docker Hub ç™»å‡º
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ”’ Docker Hub ç™»å‡º"
          echo "========================================"

          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "docker logout && echo 'âœ… å·²ç™»å‡º Docker Hub'" || true

          echo "========================================"

      # ========================================
      # Step 16: é¡¯ç¤ºå®Œæˆæ‘˜è¦
      # èªªæ˜ï¼šé¡¯ç¤ºæœ¬æ¬¡ build çš„æ‘˜è¦è³‡è¨Š
      # ========================================
      - name: ğŸ“‹ Build å®Œæˆæ‘˜è¦
        run: |
          echo "========================================"
          echo "âœ… Multi-Arch Docker Build & Push å®Œæˆï¼"
          echo "========================================"
          echo ""
          echo "ğŸ“¦ æ˜ åƒè³‡è¨Šï¼š"
          echo "  - ç‰ˆæœ¬æ¨™ç±¤: ${{ env.DOCKER_IMAGE_REPO }}:${{ github.event.inputs.image_tag }}"
          echo "  - Latest æ¨™ç±¤: ${{ env.DOCKER_IMAGE_REPO }}:latest"
          echo "  - Docker Hub: https://hub.docker.com/r/${{ env.DOCKER_IMAGE_REPO }}/tags"
          echo ""
          echo "ğŸ—ï¸ æ”¯æ´çš„æ¶æ§‹ï¼š"
          echo "  - linux/amd64"
          echo "  - linux/arm64"
          echo ""
          echo "ğŸ”§ Build è¨­å®šï¼š"
          echo "  - é ç«¯ä¸»æ©Ÿ: ${{ secrets.SSH_HOST }}"
          echo "  - å·¥ä½œç›®éŒ„: ${{ env.REMOTE_WORKDIR }}"
          echo "  - å°ˆæ¡ˆåç¨±: ${{ env.PROJECT_NAME }}"
          echo ""
          echo "ğŸ“ ä½¿ç”¨æ–¹å¼ï¼š"
          echo "  docker pull ${{ env.DOCKER_IMAGE_REPO }}:${{ github.event.inputs.image_tag }}"
          echo "  docker pull ${{ env.DOCKER_IMAGE_REPO }}:latest"
          echo ""
          echo "========================================"
          echo "ğŸ‰ æ‰€æœ‰æ­¥é©Ÿå·²æˆåŠŸå®Œæˆï¼"
          echo "========================================"
