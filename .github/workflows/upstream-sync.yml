# ==============================================================================
# Upstream Sync Build + Smoke Test
# åŠŸèƒ½ï¼š
#   1. dev åˆ†æ”¯æœ‰ push æ™‚è‡ªå‹•è§¸ç™¼
#   2. å»ºæ§‹ Docker imageï¼ˆåƒ… amd64 ç”¨æ–¼æ¸¬è©¦ï¼‰
#   3. åŸ·è¡Œ smoke testï¼ˆ10 åˆ†é˜å…§å®Œæˆï¼‰
#   4. æ¸¬è©¦é€šéå¾Œæ¨é€ multi-arch image
# ==============================================================================

name: Upstream Sync Build

on:
  push:
    branches:
      - dev

env:
  DOCKER_IMAGE: convertx/convertx-cn
  TEST_IMAGE: convertx-cn-test
  # Smoke test è¶…æ™‚æ™‚é–“ï¼ˆç§’ï¼‰
  SMOKE_TEST_TIMEOUT: 600

concurrency:
  group: upstream-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Job 1: å¿«é€Ÿå»ºæ§‹æ¸¬è©¦ç”¨ imageï¼ˆåƒ… amd64ï¼‰
  # ==========================================================================
  build-test-image:
    name: Build Test Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.date.outputs.date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # æ¸…ç†ç£ç¢Ÿç©ºé–“ï¼ˆè§£æ±º no space left on deviceï¼‰
      # ========================================
      - name: Free disk space
        run: |
          echo "ğŸ§¹ Cleaning up disk space..."
          echo "Before cleanup:"
          df -h

          # ç§»é™¤ä¸éœ€è¦çš„é è£è»Ÿé«”
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift

          # æ¸…ç† apt cache
          sudo apt-get clean
          sudo apt-get autoremove -y

          # æ¸…ç† Docker èˆŠè³‡æ–™
          docker system prune -af --volumes || true

          echo ""
          echo "After cleanup:"
          df -h

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image (amd64 only)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.TEST_IMAGE }}:test
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image
        run: |
          docker save ${{ env.TEST_IMAGE }}:test -o /tmp/test-image.tar

      - name: Upload test image
        uses: actions/upload-artifact@v4
        with:
          name: test-image
          path: /tmp/test-image.tar
          retention-days: 1

  # ==========================================================================
  # Job 2: Smoke Testï¼ˆå¿…é ˆåœ¨ 10 åˆ†é˜å…§å®Œæˆï¼‰
  # ==========================================================================
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: build-test-image
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download test image
        uses: actions/download-artifact@v4
        with:
          name: test-image
          path: /tmp

      - name: Load Docker image
        run: |
          docker load -i /tmp/test-image.tar

      - name: Create test files
        run: |
          mkdir -p /tmp/smoke-test

          # å»ºç«‹æ¥µå°çš„æ¸¬è©¦æª”æ¡ˆ (<1KB)
          echo "Hello, ConvertX Smoke Test!" > /tmp/smoke-test/test.txt
          echo "é€™æ˜¯ä¸­æ–‡æ¸¬è©¦æª”æ¡ˆ" >> /tmp/smoke-test/test.txt

      # ========================================
      # Test 1: Container å•Ÿå‹•æ¸¬è©¦
      # ========================================
      - name: "Test 1: Container startup"
        id: test_startup
        run: |
          echo "ğŸš€ Testing container startup..."

          # å•Ÿå‹• containerï¼ˆèƒŒæ™¯åŸ·è¡Œï¼‰
          docker run -d \
            --name convertx-test \
            -p 3000:3000 \
            -v /tmp/smoke-test:/data \
            -e DATA_DIR=/data \
            ${{ env.TEST_IMAGE }}:test

          # ç­‰å¾…å•Ÿå‹•ï¼ˆæœ€å¤š 60 ç§’ï¼‰
          echo "â³ Waiting for container to start..."
          for i in {1..60}; do
            if docker exec convertx-test curl -sf http://localhost:3000/healthcheck > /dev/null 2>&1; then
              echo "âœ… Container started successfully in ${i}s"
              echo "startup_time=${i}" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 1
          done

          echo "âŒ Container failed to start within 60s"
          docker logs convertx-test
          exit 1

      # ========================================
      # Test 2: é—œéµå·¥å…·å­˜åœ¨æ€§æª¢æŸ¥
      # ========================================
      - name: "Test 2: Tool availability check"
        id: test_tools
        run: |
          echo "ğŸ”§ Checking critical tools..."

          FAILED=0

          # LibreOffice
          echo -n "  libreoffice: "
          if docker exec convertx-test libreoffice --version 2>/dev/null; then
            echo "âœ…"
          else
            echo "âŒ FAILED"
            FAILED=1
          fi

          # Pandoc
          echo -n "  pandoc: "
          if docker exec convertx-test pandoc --version 2>/dev/null | head -1; then
            echo "âœ…"
          else
            echo "âŒ FAILED"
            FAILED=1
          fi

          # FFmpeg
          echo -n "  ffmpeg: "
          if docker exec convertx-test ffmpeg -version 2>/dev/null | head -1; then
            echo "âœ…"
          else
            echo "âŒ FAILED"
            FAILED=1
          fi

          # Tesseract
          echo -n "  tesseract: "
          if docker exec convertx-test tesseract --version 2>/dev/null | head -1; then
            echo "âœ…"
          else
            echo "âŒ FAILED"
            FAILED=1
          fi

          # é¡å¤–æª¢æŸ¥æ›´å¤šå·¥å…·
          echo ""
          echo "ğŸ”§ Checking additional tools..."

          # ImageMagick
          echo -n "  imagemagick: "
          if docker exec convertx-test magick -version 2>/dev/null | head -1; then
            echo "âœ…"
          else
            echo "âš ï¸ Warning (optional)"
          fi

          # Inkscape
          echo -n "  inkscape: "
          if docker exec convertx-test inkscape --version 2>/dev/null; then
            echo "âœ…"
          else
            echo "âš ï¸ Warning (optional)"
          fi

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "âŒ Critical tool check failed!"
            exit 1
          fi

          echo ""
          echo "âœ… All critical tools available"

      # ========================================
      # Test 3: Headless ç’°å¢ƒé©—è­‰
      # ========================================
      - name: "Test 3: Headless environment verification"
        run: |
          echo "ğŸ–¥ï¸ Verifying headless environment..."

          # æª¢æŸ¥ DISPLAY ç’°å¢ƒè®Šæ•¸
          echo ""
          echo "ğŸ“‹ æª¢æŸ¥ DISPLAY ç’°å¢ƒè®Šæ•¸..."
          DISPLAY_VAR=$(docker exec convertx-test printenv DISPLAY 2>/dev/null || echo "")
          if [ -z "$DISPLAY_VAR" ]; then
            echo "âœ… DISPLAY æœªè¨­å®šï¼ˆheadless æ¨¡å¼æ­£ç¢ºï¼‰"
          else
            echo "âš ï¸ DISPLAY å·²è¨­å®š: ${DISPLAY_VAR}"
          fi

          # æª¢æŸ¥ Xvfb
          echo ""
          echo "ğŸ“‹ æª¢æŸ¥ Xvfb..."
          if docker exec convertx-test which Xvfb 2>/dev/null; then
            echo "âš ï¸ Xvfb å­˜åœ¨ï¼ˆä½†æ‡‰ä¸éœ€è¦ï¼‰"
          else
            echo "âœ… Xvfb ä¸å­˜åœ¨ï¼ˆheadless æ¨¡å¼æ­£ç¢ºï¼‰"
          fi

          # é©—è­‰ LibreOffice headless
          echo ""
          echo "ğŸ“‹ é©—è­‰ LibreOffice headless..."
          if docker exec convertx-test libreoffice --headless --version 2>/dev/null | head -1; then
            echo "âœ… LibreOffice headless æ¨¡å¼å¯ç”¨"
          else
            echo "âŒ LibreOffice headless æ¨¡å¼å¤±æ•—"
            exit 1
          fi

          echo ""
          echo "âœ… Headless environment verification passed"

      # ========================================
      # Test 4: æ¨¡å‹ä¸‹è¼‰é©—è­‰
      # ========================================
      - name: "Test 4: Model download verification"
        run: |
          echo "ğŸ¤– Verifying model downloads..."

          # æª¢æŸ¥ HuggingFace cache
          echo ""
          echo "ğŸ“‹ æª¢æŸ¥ HuggingFace cache..."
          HF_CACHE=$(docker exec convertx-test ls -la /root/.cache/huggingface/ 2>/dev/null || echo "NOT_FOUND")
          if [ "$HF_CACHE" != "NOT_FOUND" ]; then
            echo "âœ… HuggingFace cache å­˜åœ¨"
          else
            echo "âš ï¸ HuggingFace cache ä¸å­˜åœ¨ï¼ˆæ¨¡å‹å¯èƒ½åœ¨å…¶ä»–ä½ç½®ï¼‰"
          fi

          # æª¢æŸ¥ ONNX æ¨¡å‹
          echo ""
          echo "ğŸ“‹ æª¢æŸ¥ ONNX æ¨¡å‹..."
          ONNX_COUNT=$(docker exec convertx-test find /root -name "*.onnx" -type f 2>/dev/null | wc -l || echo "0")
          if [ "$ONNX_COUNT" -gt 0 ]; then
            echo "âœ… æ‰¾åˆ° ${ONNX_COUNT} å€‹ ONNX æ¨¡å‹"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° ONNX æ¨¡å‹ï¼ˆå¯èƒ½å‹•æ…‹ä¸‹è¼‰ï¼‰"
          fi

          # æª¢æŸ¥é›¢ç·šæ¨¡å¼ç’°å¢ƒè®Šæ•¸
          echo ""
          echo "ğŸ“‹ æª¢æŸ¥é›¢ç·šæ¨¡å¼ç’°å¢ƒè®Šæ•¸..."
          HF_OFFLINE=$(docker exec convertx-test printenv HF_HUB_OFFLINE 2>/dev/null || echo "")
          if [ "$HF_OFFLINE" = "1" ]; then
            echo "âœ… HF_HUB_OFFLINE=1ï¼ˆé›¢ç·šæ¨¡å¼å·²å•Ÿç”¨ï¼‰"
          else
            echo "âš ï¸ HF_HUB_OFFLINE æœªè¨­å®š"
          fi

          echo ""
          echo "âœ… Model verification completed"

      # ========================================
      # Test 5: æœ€å°è½‰æ›æ¸¬è©¦ (txt â†’ pdf)
      # ========================================
      - name: "Test 5: Minimal conversion test"
        id: test_conversion
        run: |
          echo "ğŸ“„ Testing minimal conversion (txt â†’ pdf)..."

          # ä½¿ç”¨ API é€²è¡Œè½‰æ›æ¸¬è©¦
          # å…ˆä¸Šå‚³æª”æ¡ˆ
          echo "  Uploading test file..."
          UPLOAD_RESPONSE=$(curl -sf -X POST \
            -F "file=@/tmp/smoke-test/test.txt" \
            http://localhost:3000/upload 2>&1) || {
            echo "âŒ Upload failed"
            echo "Response: $UPLOAD_RESPONSE"
            exit 1
          }

          echo "  Upload response: $UPLOAD_RESPONSE"

          # æª¢æŸ¥ healthcheck ç¢ºèªæœå‹™æ­£å¸¸
          echo "  Checking service health..."
          HEALTH=$(curl -sf http://localhost:3000/healthcheck)
          echo "  Health: $HEALTH"

          # ä½¿ç”¨ LibreOffice ç›´æ¥æ¸¬è©¦è½‰æ›èƒ½åŠ›
          echo "  Testing LibreOffice conversion capability..."
          docker exec convertx-test sh -c "
            cd /tmp && \
            echo 'Test document for smoke test' > test.txt && \
            libreoffice --headless --convert-to pdf test.txt && \
            ls -la test.pdf
          " && echo "âœ… Conversion test passed" || {
            echo "âŒ Conversion test failed"
            exit 1
          }

      # ========================================
      # Test 6: API ç«¯é»æª¢æŸ¥
      # ========================================
      - name: "Test 6: API endpoints check"
        run: |
          echo "ğŸŒ Checking API endpoints..."

          # Healthcheck
          echo -n "  /healthcheck: "
          if curl -sf http://localhost:3000/healthcheck > /dev/null; then
            echo "âœ…"
          else
            echo "âŒ"
            exit 1
          fi

          # Root page
          echo -n "  / (root): "
          if curl -sf http://localhost:3000/ > /dev/null; then
            echo "âœ…"
          else
            echo "âŒ"
            exit 1
          fi

          # Converters list
          echo -n "  /converters: "
          if curl -sf http://localhost:3000/converters > /dev/null; then
            echo "âœ…"
          else
            echo "âš ï¸ (may require auth)"
          fi

          echo ""
          echo "âœ… API endpoints check passed"

      - name: Cleanup test container
        if: always()
        run: |
          docker stop convertx-test || true
          docker rm convertx-test || true

      - name: Smoke test summary
        if: always()
        run: |
          echo "## ğŸ§ª Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ¸¬è©¦é …ç›® | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Container å•Ÿå‹• | âœ… é€šé (${startup_time:-N/A}s) |" >> $GITHUB_STEP_SUMMARY
          echo "| å·¥å…·æª¢æŸ¥ (libreoffice, pandoc, ffmpeg, tesseract) | âœ… é€šé |" >> $GITHUB_STEP_SUMMARY
          echo "| Headless ç’°å¢ƒé©—è­‰ | âœ… é€šé |" >> $GITHUB_STEP_SUMMARY
          echo "| æ¨¡å‹ä¸‹è¼‰é©—è­‰ | âœ… é€šé |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ€å°è½‰æ›æ¸¬è©¦ | âœ… é€šé |" >> $GITHUB_STEP_SUMMARY
          echo "| API ç«¯é»æª¢æŸ¥ | âœ… é€šé |" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Job 3: æ¸¬è©¦é€šéå¾Œï¼Œå»ºæ§‹ä¸¦æ¨é€ multi-arch image
  # ==========================================================================
  build-and-push:
    name: Build & Push Multi-arch Image
    runs-on: ubuntu-latest
    needs: [build-test-image, smoke-test]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # æ¸…ç†ç£ç¢Ÿç©ºé–“ï¼ˆmulti-arch build éœ€è¦æ›´å¤šç©ºé–“ï¼‰
      # ========================================
      - name: Free disk space
        run: |
          echo "ğŸ§¹ Cleaning up disk space for multi-arch build..."
          echo "Before cleanup:"
          df -h

          # ç§»é™¤ä¸éœ€è¦çš„é è£è»Ÿé«”
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf /opt/hostedtoolcache

          # æ¸…ç† apt cache
          sudo apt-get clean
          sudo apt-get autoremove -y

          # æ¸…ç† Docker èˆŠè³‡æ–™
          docker system prune -af --volumes || true

          echo ""
          echo "After cleanup:"
          df -h

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:upstream-${{ steps.date.outputs.date }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "## ğŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_IMAGE }}:upstream-${{ steps.date.outputs.date }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Smoke Test å·²é€šé" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ¸¬è©¦é …ç›® | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Container å•Ÿå‹• | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| å·¥å…·å­˜åœ¨æ€§æª¢æŸ¥ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Headless ç’°å¢ƒé©—è­‰ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| æ¨¡å‹ä¸‹è¼‰é©—è­‰ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ€å°è½‰æ›æ¸¬è©¦ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| API ç«¯é»æª¢æŸ¥ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ é€™æ˜¯ upstream åŒæ­¥ç‰ˆæœ¬ã€‚è«‹ä½¿ç”¨ version tags å–å¾—ç©©å®šç‰ˆæœ¬ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **ä¸æœƒæ›´æ–° \`latest\` tag**" >> $GITHUB_STEP_SUMMARY
