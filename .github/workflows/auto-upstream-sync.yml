# ==============================================================================
# è‡ªå‹•åŒæ­¥ Upstream Repository
# åŠŸèƒ½ï¼š
#   1. å®šæ™‚æª¢æŸ¥ upstream æ›´æ–°
#   2. è‡ªå‹• merge åˆ° dev åˆ†æ”¯
#   3. ç”¢ç”Ÿè®Šæ›´æ‘˜è¦ï¼ˆChange Summaryï¼‰
#   4. è§¸ç™¼å¾ŒçºŒçš„ build + smoke test
# ==============================================================================

name: Auto Upstream Sync

on:
  # æ¯ 6 å°æ™‚æª¢æŸ¥ä¸€æ¬¡ upstream
  schedule:
    - cron: "0 */6 * * *"
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_sync:
        description: "å¼·åˆ¶åŒæ­¥ï¼ˆå³ä½¿ç„¡æ–° commitï¼‰"
        type: boolean
        default: false

env:
  UPSTREAM_REPO: https://github.com/C4illin/ConvertX.git
  TARGET_BRANCH: dev
  UPSTREAM_BRANCH: main

permissions:
  contents: write
  issues: write

jobs:
  check-and-sync:
    name: Check & Sync Upstream
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      new_commits: ${{ steps.check.outputs.new_commits }}
      commit_count: ${{ steps.check.outputs.commit_count }}
      sync_date: ${{ steps.date.outputs.date }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream ${{ env.UPSTREAM_REPO }} || true
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Check for upstream updates
        id: check
        run: |
          # å–å¾—æœ¬åœ° dev åˆ†æ”¯çš„æœ€å¾Œä¸€æ¬¡ upstream merge commit
          # æˆ‘å€‘ç”¨ upstream/main èˆ‡ç›®å‰ HEAD æ¯”è¼ƒ

          LOCAL_HEAD=$(git rev-parse HEAD)
          UPSTREAM_HEAD=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})

          echo "Local HEAD: $LOCAL_HEAD"
          echo "Upstream HEAD: $UPSTREAM_HEAD"

          # æª¢æŸ¥ upstream æ˜¯å¦æœ‰æ–°çš„ commits
          MERGE_BASE=$(git merge-base HEAD upstream/${{ env.UPSTREAM_BRANCH }})
          echo "Merge base: $MERGE_BASE"

          if [ "$MERGE_BASE" = "$UPSTREAM_HEAD" ]; then
            echo "âœ… Already up to date with upstream"
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "commit_count=0" >> $GITHUB_OUTPUT
          else
            # è¨ˆç®—æ–°çš„ commits æ•¸é‡
            NEW_COMMITS=$(git rev-list --count $MERGE_BASE..$UPSTREAM_HEAD)
            echo "ğŸ”„ Found $NEW_COMMITS new commits from upstream"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "commit_count=$NEW_COMMITS" >> $GITHUB_OUTPUT
            
            # å–å¾—æ–° commits çš„åˆ—è¡¨
            COMMITS_LIST=$(git log --oneline $MERGE_BASE..$UPSTREAM_HEAD)
            echo "new_commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog before merge
        id: changelog
        if: steps.check.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          MERGE_BASE=$(git merge-base HEAD upstream/${{ env.UPSTREAM_BRANCH }})

          echo "## ğŸ“‹ Upstream è®Šæ›´æ‘˜è¦" > changelog.md
          echo "" >> changelog.md
          echo "**åŒæ­¥æ™‚é–“:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> changelog.md
          echo "**Upstream åˆ†æ”¯:** ${{ env.UPSTREAM_BRANCH }}" >> changelog.md
          echo "**æ–° Commits æ•¸é‡:** ${{ steps.check.outputs.commit_count }}" >> changelog.md
          echo "" >> changelog.md

          echo "### ğŸ“ Commit åˆ—è¡¨" >> changelog.md
          echo "" >> changelog.md
          echo "\`\`\`" >> changelog.md
          git log --oneline --no-merges $MERGE_BASE..upstream/${{ env.UPSTREAM_BRANCH }} >> changelog.md
          echo "\`\`\`" >> changelog.md
          echo "" >> changelog.md

          echo "### ğŸ“Š è®Šæ›´çµ±è¨ˆ" >> changelog.md
          echo "" >> changelog.md
          echo "\`\`\`" >> changelog.md
          git diff --stat $MERGE_BASE..upstream/${{ env.UPSTREAM_BRANCH }} >> changelog.md
          echo "\`\`\`" >> changelog.md
          echo "" >> changelog.md

          echo "### ğŸ” è®Šæ›´çš„æª”æ¡ˆ" >> changelog.md
          echo "" >> changelog.md
          git diff --name-status $MERGE_BASE..upstream/${{ env.UPSTREAM_BRANCH }} | while read line; do
            STATUS=$(echo "$line" | awk '{print $1}')
            FILE=$(echo "$line" | awk '{print $2}')
            case $STATUS in
              A) echo "- âœ… **æ–°å¢** \`$FILE\`" >> changelog.md ;;
              M) echo "- âœï¸ **ä¿®æ”¹** \`$FILE\`" >> changelog.md ;;
              D) echo "- âŒ **åˆªé™¤** \`$FILE\`" >> changelog.md ;;
              R*) echo "- ğŸ”„ **é‡æ–°å‘½å** \`$FILE\`" >> changelog.md ;;
              *) echo "- ğŸ“„ \`$FILE\` ($STATUS)" >> changelog.md ;;
            esac
          done

          cat changelog.md

          # è¼¸å‡ºçµ¦å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          CHANGELOG_CONTENT=$(cat changelog.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Merge upstream changes
        id: merge
        if: steps.check.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          echo "ğŸ”„ Merging upstream/${{ env.UPSTREAM_BRANCH }} into ${{ env.TARGET_BRANCH }}..."

          # å˜—è©¦è‡ªå‹• merge
          if git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit -m "ğŸ”„ Auto-merge upstream changes ($(date +'%Y-%m-%d'))"; then
            echo "âœ… Merge successful!"
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Merge conflict detected!"
            echo "merge_success=false" >> $GITHUB_OUTPUT
            
            # å–æ¶ˆ merge
            git merge --abort
            
            # å»ºç«‹ conflict issue
            exit 1
          fi

      - name: Push changes
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          git push origin ${{ env.TARGET_BRANCH }}
          echo "âœ… Changes pushed to ${{ env.TARGET_BRANCH }}"

      - name: Commit changelog
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          # æ›´æ–° upstream-changelog.md
          if [ -f upstream-changelog.md ]; then
            # åœ¨æª”æ¡ˆé–‹é ­æ’å…¥æ–°çš„ changelog
            echo "" >> changelog.md
            echo "---" >> changelog.md
            echo "" >> changelog.md
            cat upstream-changelog.md >> changelog.md
          fi

          mv changelog.md upstream-changelog.md
          git add upstream-changelog.md
          git commit -m "ğŸ“‹ Update upstream changelog (${{ steps.date.outputs.date }})" || true
          git push origin ${{ env.TARGET_BRANCH }} || true

      - name: Create GitHub Issue for sync summary
        if: steps.merge.outputs.merge_success == 'true' && steps.check.outputs.commit_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const date = '${{ steps.date.outputs.date }}';
            const commitCount = '${{ steps.check.outputs.commit_count }}';

            const body = `## ğŸ”„ Upstream è‡ªå‹•åŒæ­¥å®Œæˆ

            **åŒæ­¥æ—¥æœŸ:** ${date}
            **æ–° Commits:** ${commitCount} å€‹
            **ç›®æ¨™åˆ†æ”¯:** \`dev\`

            ### ğŸ“ è®Šæ›´æ‘˜è¦

            \`\`\`
            ${{ steps.check.outputs.new_commits }}
            \`\`\`

            ### â³ å¾ŒçºŒå‹•ä½œ

            - [ ] Smoke test åŸ·è¡Œä¸­...
            - [ ] Docker image å»ºæ§‹ä¸­ (\`upstream-${date}\`)

            ---
            *æ­¤ Issue ç”± GitHub Actions è‡ªå‹•å»ºç«‹*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ Upstream Sync: ${date} (${commitCount} commits)`,
              body: body,
              labels: ['upstream-sync', 'automated']
            });

      - name: Create Issue for merge conflict
        if: failure() && steps.merge.outputs.merge_success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const date = '${{ steps.date.outputs.date }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ Upstream Sync è¡çª: ${date}`,
              body: `## âš ï¸ Upstream åŒæ­¥ç™¼ç”Ÿè¡çª
              
              éœ€è¦æ‰‹å‹•è§£æ±º merge conflictã€‚
              
              ### è™•ç†æ­¥é©Ÿ
              
              \`\`\`bash
              git fetch upstream main
              git checkout dev
              git merge upstream/main
              # è§£æ±ºè¡çªå¾Œ
              git add .
              git commit
              git push origin dev
              \`\`\`
              
              ---
              *æ­¤ Issue ç”± GitHub Actions è‡ªå‹•å»ºç«‹*
              `,
              labels: ['upstream-sync', 'merge-conflict', 'needs-attention']
            });

      - name: Summary
        if: always()
        run: |
          echo "## ğŸ”„ Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æª¢æŸ¥æ™‚é–“ | $(date +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ‰æ–°æ›´æ–° | ${{ steps.check.outputs.has_updates }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ–° Commits | ${{ steps.check.outputs.commit_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Merge æˆåŠŸ | ${{ steps.merge.outputs.merge_success || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.has_updates }}" == "true" ]; then
            echo "### ğŸ“ New Commits" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.check.outputs.new_commits }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
