# ğŸ”„ Upstream è‡ªå‹•åŒæ­¥æ©Ÿåˆ¶

æœ¬å°ˆæ¡ˆå¯¦ä½œäº†å®Œæ•´çš„ upstream è‡ªå‹•åŒæ­¥ã€è®Šæ›´è¿½è¹¤èˆ‡ smoke test æ©Ÿåˆ¶ã€‚

## ğŸ“‹ ç›®éŒ„

- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [å·¥ä½œæµç¨‹åœ–](#å·¥ä½œæµç¨‹åœ–)
- [Workflow èªªæ˜](#workflow-èªªæ˜)
- [Smoke Test å…§å®¹](#smoke-test-å…§å®¹)
- [è¨­å®šèªªæ˜](#è¨­å®šèªªæ˜)
- [æ‰‹å‹•æ“ä½œ](#æ‰‹å‹•æ“ä½œ)

---

## åŠŸèƒ½æ¦‚è¿°

### 1ï¸âƒ£ è‡ªå‹•åŒæ­¥ Upstream

| åŠŸèƒ½       | èªªæ˜                         |
| ---------- | ---------------------------- |
| è§¸ç™¼æ–¹å¼   | æ¯ 6 å°æ™‚è‡ªå‹•æª¢æŸ¥ / æ‰‹å‹•è§¸ç™¼ |
| åŒæ­¥ç›®æ¨™   | `dev` åˆ†æ”¯                   |
| Merge ç­–ç•¥ | è‡ªå‹• mergeï¼ˆç„¡è¡çªæ™‚ï¼‰       |
| è¡çªè™•ç†   | è‡ªå‹•å»ºç«‹ GitHub Issue é€šçŸ¥   |

### 2ï¸âƒ£ è®Šæ›´æ‘˜è¦

åŒæ­¥å®Œæˆå¾Œè‡ªå‹•ç”¢ç”Ÿï¼š

- âœ… GitHub Issueï¼ˆè©³ç´°è®Šæ›´è¨˜éŒ„ï¼‰
- âœ… `upstream-changelog.md`ï¼ˆç´¯ç©è®Šæ›´æ­·å²ï¼‰
- âœ… GitHub Actions Summaryï¼ˆå¿«é€ŸæŸ¥çœ‹ï¼‰

### 3ï¸âƒ£ Smoke Test

| æ¸¬è©¦é …ç›®       | å…§å®¹                                   | æ™‚é–“é™åˆ¶      |
| -------------- | -------------------------------------- | ------------- |
| Container å•Ÿå‹• | é©—è­‰ image å¯æ­£å¸¸å•Ÿå‹•                  | 60s           |
| å·¥å…·æª¢æŸ¥       | libreoffice, pandoc, ffmpeg, tesseract | 30s           |
| æœ€å°è½‰æ›       | txt â†’ pdf                              | 60s           |
| API ç«¯é»       | healthcheck, root                      | 10s           |
| **ç¸½è¨ˆ**       |                                        | **< 10 åˆ†é˜** |

---

## å·¥ä½œæµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Upstream è‡ªå‹•åŒæ­¥æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Upstream   â”‚
    â”‚  (C4illin/   â”‚
    â”‚  ConvertX)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ æ¯ 6 å°æ™‚æª¢æŸ¥
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ç„¡æ›´æ–°      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æª¢æŸ¥æ˜¯å¦æœ‰   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   çµæŸ       â”‚
    â”‚  æ–° commits  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ æœ‰æ›´æ–°
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     è¡çª        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è‡ªå‹• Merge  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ å»ºç«‹ Issue   â”‚
    â”‚  åˆ° dev åˆ†æ”¯  â”‚                â”‚ éœ€æ‰‹å‹•è™•ç†    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ æˆåŠŸ
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ç”¢ç”Ÿè®Šæ›´æ‘˜è¦  â”‚
    â”‚  â€¢ Issue     â”‚
    â”‚  â€¢ Changelog â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Push åˆ° dev â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ è§¸ç™¼ upstream-sync.yml
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Build æ¸¬è©¦  â”‚
    â”‚  Image (amd64)â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  Smoke Test                       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ Container  â”‚ â”‚   å·¥å…·     â”‚ â”‚   è½‰æ›     â”‚   â”‚
    â”‚  â”‚   å•Ÿå‹•     â”‚ â”‚   æª¢æŸ¥     â”‚ â”‚   æ¸¬è©¦     â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚        â”‚              â”‚              â”‚           â”‚
    â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
    â”‚                       â”‚                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                           â”‚
              â–¼                           â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  âœ… é€šé   â”‚              â”‚  âŒ å¤±æ•—   â”‚
       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚                           â”‚
             â–¼                           â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Build ä¸¦   â”‚              â”‚ Workflow   â”‚
       â”‚ Push åˆ°    â”‚              â”‚ å¤±æ•—       â”‚
       â”‚ Docker Hub â”‚              â”‚ (ä¸ç™¼å¸ƒ)    â”‚
       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ upstream-YYYYMMDD tag  â”‚
       â”‚ âŒ ä¸æ›´æ–° latest        â”‚
       â”‚ âŒ ä¸æ‰“ semver tag      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Workflow èªªæ˜

### `auto-upstream-sync.yml`

**ç”¨é€”ï¼š** è‡ªå‹•æª¢æ¸¬ä¸¦åŒæ­¥ upstream æ›´æ–°

**è§¸ç™¼æ¢ä»¶ï¼š**

- â° æ¯ 6 å°æ™‚è‡ªå‹•åŸ·è¡Œ
- ğŸ–±ï¸ æ‰‹å‹•è§¸ç™¼

**ä¸»è¦æ­¥é©Ÿï¼š**

1. Fetch upstream æœ€æ–°ç¨‹å¼ç¢¼
2. æª¢æŸ¥æ˜¯å¦æœ‰æ–° commits
3. è‡ªå‹• merge åˆ° `dev` åˆ†æ”¯
4. ç”¢ç”Ÿè®Šæ›´æ‘˜è¦ï¼ˆIssue + Changelogï¼‰
5. Push åˆ° `dev`

### `upstream-sync.yml`

**ç”¨é€”ï¼š** ç•¶ `dev` åˆ†æ”¯æœ‰ push æ™‚ï¼ŒåŸ·è¡Œ build + smoke test

**è§¸ç™¼æ¢ä»¶ï¼š**

- ğŸ“¦ `dev` åˆ†æ”¯æœ‰ push

**ä¸»è¦æ­¥é©Ÿï¼š**

1. Build æ¸¬è©¦ç”¨ imageï¼ˆåƒ… amd64ï¼ŒåŠ é€Ÿæ¸¬è©¦ï¼‰
2. åŸ·è¡Œ Smoke Testï¼ˆ10 åˆ†é˜å…§ï¼‰
3. æ¸¬è©¦é€šéå¾Œ build multi-arch image
4. Push åˆ° Docker Hubï¼ˆtag: `upstream-YYYYMMDD`ï¼‰

---

## Smoke Test å…§å®¹

### Test 1: Container å•Ÿå‹•æ¸¬è©¦

```bash
# å•Ÿå‹• container ä¸¦ç­‰å¾… healthcheck å›æ‡‰
docker run -d --name convertx-test $IMAGE
curl http://localhost:3000/healthcheck
```

### Test 2: é—œéµå·¥å…·æª¢æŸ¥

```bash
# å¿…é ˆé€šéï¼ˆä»»ä¸€å¤±æ•—å‰‡æ•´é«”å¤±æ•—ï¼‰
libreoffice --version
pandoc --version
ffmpeg -version
tesseract --version
```

### Test 3: æœ€å°è½‰æ›æ¸¬è©¦

```bash
# txt â†’ pdf è½‰æ›æ¸¬è©¦
echo "test" > test.txt
libreoffice --headless --convert-to pdf test.txt
```

### Test 4: API ç«¯é»æª¢æŸ¥

```bash
# ç¢ºèªæœå‹™æ­£å¸¸é‹ä½œ
curl http://localhost:3000/healthcheck
curl http://localhost:3000/
```

---

## è¨­å®šèªªæ˜

### å¿…è¦çš„ GitHub Secrets

åœ¨ Repository Settings â†’ Secrets and variables â†’ Actions ä¸­è¨­å®šï¼š

| Secret åç¨±          | èªªæ˜                    |
| -------------------- | ----------------------- |
| `DOCKERHUB_USERNAME` | Docker Hub å¸³è™Ÿ         |
| `DOCKERHUB_TOKEN`    | Docker Hub Access Token |

### åˆ†æ”¯ä¿è­·è¦å‰‡

å»ºè­°è¨­å®šï¼š

**`main` åˆ†æ”¯ï¼š**

- âœ… Require pull request before merging
- âœ… Require status checks to pass
- âŒ Allow force pushes

**`dev` åˆ†æ”¯ï¼š**

- âœ… Allow direct pushes (for automation)

---

## æ‰‹å‹•æ“ä½œ

### æ‰‹å‹•è§¸ç™¼åŒæ­¥

1. å‰å¾€ Actions â†’ Auto Upstream Sync
2. é»é¸ "Run workflow"
3. å¯é¸æ“‡ã€Œå¼·åˆ¶åŒæ­¥ã€

### æ‰‹å‹•è™•ç† Merge è¡çª

ç•¶è‡ªå‹•åŒæ­¥ç™¼ç”Ÿè¡çªæ™‚ï¼š

```bash
# 1. åˆ‡æ›åˆ° dev åˆ†æ”¯
git checkout dev

# 2. æ·»åŠ  upstream remoteï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰
git remote add upstream https://github.com/C4illin/ConvertX.git

# 3. Fetch upstream
git fetch upstream main

# 4. Merge upstream
git merge upstream/main

# 5. è§£æ±ºè¡çª
# ... ç·¨è¼¯è¡çªçš„æª”æ¡ˆ ...

# 6. æäº¤ä¸¦ push
git add .
git commit -m "Resolve merge conflicts with upstream"
git push origin dev
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **ä¸æœƒè‡ªå‹•æ›´æ–° `latest` tag** - éœ€è¦æ‰‹å‹•ç™¼å¸ƒæ­£å¼ç‰ˆæœ¬
2. **ä¸æœƒè‡ªå‹•æ‰“ semver tag** - éœ€è¦æ‰‹å‹•å»ºç«‹ release
3. **`main` åˆ†æ”¯ä¸æœƒè¢«è‡ªå‹•ä¿®æ”¹** - åªæœ‰ `dev` æœƒè‡ªå‹•åŒæ­¥
4. **Smoke test å¤±æ•—æ™‚ä¸æœƒç™¼å¸ƒ image** - ç¢ºä¿å“è³ª

---

## ğŸ“Š Docker Image Tag è¦å‰‡

| Tag æ ¼å¼            | èªªæ˜                               | è‡ªå‹•/æ‰‹å‹• |
| ------------------- | ---------------------------------- | --------- |
| `upstream-YYYYMMDD` | Upstream åŒæ­¥ç‰ˆï¼ˆç¶“é smoke testï¼‰ | è‡ªå‹•      |
| `vX.Y.Z`            | æ­£å¼ç‰ˆæœ¬                           | æ‰‹å‹•      |
| `latest`            | æœ€æ–°ç©©å®šç‰ˆ                         | æ‰‹å‹•      |
