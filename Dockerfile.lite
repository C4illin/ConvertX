# ==============================================================================
# ConvertX-CN Lite ç‰ˆ Docker Image
# ç‰ˆæœ¬ï¼šv0.1.15-lite
# ==============================================================================
#
# ğŸ“¦ Image èªªæ˜ï¼š
#   - ConvertX-CN è¼•é‡ç‰ˆï¼Œé©åˆä¸€èˆ¬ä½¿ç”¨è€…èˆ‡å¿«é€Ÿéƒ¨ç½²
#   - é«”ç©é¡¯è‘—å°æ–¼ä¸€èˆ¬ç‰ˆï¼ˆç›®æ¨™ < 1.5 GB vs 8-12 GBï¼‰
#   - ä¿ç•™æ—¥å¸¸æœ€å¸¸ç”¨çš„è½‰æª”åŠŸèƒ½ï¼Œç§»é™¤ AI/OCR/ç¿»è­¯ç­‰é€²éšåŠŸèƒ½
#   - âš ï¸ ç„¡ AI æ¨¡å‹ã€ç„¡ OCRã€ç„¡ PDF ç¿»è­¯åŠŸèƒ½
#
# ğŸ¯ é©ç”¨å ´æ™¯ï¼š
#   - å€‹äºº/å°å‹åœ˜éšŠçš„åŸºæœ¬è½‰æª”éœ€æ±‚
#   - è³‡æºå—é™çš„ç’°å¢ƒï¼ˆå¦‚ VPSã€NASã€æ¨¹è“æ´¾ï¼‰
#   - ä¸éœ€è¦ OCR/AI/ç¿»è­¯åŠŸèƒ½çš„ä½¿ç”¨è€…
#
# âœ… Lite ç‰ˆåŒ…å«åŠŸèƒ½ï¼ˆæ—¥å¸¸æœ€å¸¸ç”¨ï¼‰ï¼š
#   - LibreOfficeï¼ˆæ–‡ä»¶è½‰æª”ï¼šDOC/DOCX/XLS/PPT â†’ PDFï¼‰
#   - GraphicsMagickï¼ˆåœ–ç‰‡è½‰æª”ï¼šPNG/JPG/GIF/WEBPï¼‰
#   - FFmpegï¼ˆå½±éŸ³è½‰æª”ï¼šMP4/MP3/AVI/MKVï¼‰
#   - Pandocï¼ˆæ–‡ä»¶æ ¼å¼ï¼šMarkdown/HTML/DOCXï¼‰
#   - Ghostscript + qpdfï¼ˆPDF è™•ç†ï¼‰
#   - PDF æ•¸ä½ç°½ç« ï¼ˆPFX/PKCS#12ï¼‰
#   - ç²¾ç°¡ç‰ˆ UIï¼ˆåƒ…è‹±æ–‡ã€ç°¡é«”ä¸­æ–‡ã€ç¹é«”ä¸­æ–‡ï¼‰
#
# âŒ Lite ç‰ˆä¸åŒ…å«ï¼š
#   - PDFMathTranslate / BabelDOCï¼ˆPDF ç¿»è­¯ï¼‰
#   - MinerUï¼ˆPDF è½‰ Markdownï¼‰
#   - OCR / Tesseract
#   - AI æ¨¡å‹ / VLM / YOLO
#   - Calibreï¼ˆé›»å­æ›¸è½‰æ›ï¼‰
#   - ImageMagick / Inkscape / VIPS
#   - CAD / 3D / assimp
#   - TexLiveï¼ˆLaTeXï¼‰
#
# ğŸ“Š Image å¤§å°ï¼šç›®æ¨™ < 1.5 GB
#
# ==============================================================================

FROM debian:bookworm-slim AS base
LABEL org.opencontainers.image.source="https://github.com/pi-docket/ConvertX-CN"
LABEL org.opencontainers.image.description="ConvertX-CN Lite - è¼•é‡ç‰ˆæª”æ¡ˆè½‰æ›æœå‹™"
LABEL org.opencontainers.image.version="lite"
WORKDIR /app

# é…ç½® APT é‡è©¦æ©Ÿåˆ¶ï¼ˆè§£æ±º Multi-Arch Build æ™‚çš„ç¶²è·¯ä¸ç©©å®šå•é¡Œï¼‰
RUN echo 'Acquire::Retries "5";' > /etc/apt/apt.conf.d/80-retries \
    && echo 'Acquire::http::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
    && echo 'Acquire::https::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
    && echo 'Acquire::ftp::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
    && echo 'DPkg::Lock::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries

# install bun
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    unzip \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# if architecture is arm64, use the arm64 version of bun
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ]; then \
    curl -fsSL -o bun-linux-aarch64.zip https://github.com/oven-sh/bun/releases/download/bun-v1.3.6/bun-linux-aarch64.zip; \
    else \
    curl -fsSL -o bun-linux-x64-baseline.zip https://github.com/oven-sh/bun/releases/download/bun-v1.3.6/bun-linux-x64-baseline.zip; \
    fi

RUN unzip -j bun-linux-*.zip -d /usr/local/bin && \
    rm bun-linux-*.zip && \
    chmod +x /usr/local/bin/bun

# install dependencies into temp directory
# this will cache them and speed up future builds
FROM base AS install
RUN mkdir -p /temp/dev
COPY package.json bun.lock /temp/dev/
RUN cd /temp/dev && bun install --frozen-lockfile

# install with --production (exclude devDependencies)
RUN mkdir -p /temp/prod
COPY package.json bun.lock /temp/prod/
RUN cd /temp/prod && bun install --frozen-lockfile --production

FROM base AS prerelease
WORKDIR /app
COPY --from=install /temp/dev/node_modules node_modules
COPY . .

# ENV NODE_ENV=production
RUN bun run build

# ==============================================================================
# Release Stage - Lite ç‰ˆæœ¬
# ==============================================================================
FROM base AS release

# ==============================================================================
# ä¾è³´å®‰è£ï¼ˆLite ç‰ˆ - æ¥µç°¡å®‰è£ï¼‰
# ==============================================================================
#
# âœ… ä¿ç•™å·¥å…·ï¼ˆæ—¥å¸¸æœ€å¸¸ç”¨ï¼‰ï¼š
#   - LibreOfficeï¼ˆæ–‡ä»¶è½‰æª” - æœ€é‡è¦ï¼‰
#   - GraphicsMagickï¼ˆåœ–ç‰‡è½‰æª” - è¼•é‡æ›¿ä»£ ImageMagickï¼‰
#   - FFmpegï¼ˆå½±éŸ³è½‰æª”ï¼‰
#   - Pandocï¼ˆMarkdown/HTML/DOCX è½‰æ›ï¼‰
#   - Ghostscript + qpdfï¼ˆPDF è™•ç†ï¼‰
#   - poppler-utilsï¼ˆPDF å·¥å…·ï¼‰
#   - potraceï¼ˆé»é™£åœ–è½‰å‘é‡ï¼‰
#
# âŒ ç§»é™¤å·¥å…·ï¼ˆæ¸›å°‘é«”ç©ï¼‰ï¼š
#   - Tesseract / OCRï¼ˆç´„ +200MBï¼‰
#   - Calibreï¼ˆç´„ +500MBï¼‰
#   - TexLiveï¼ˆç´„ +1GBï¼‰
#   - ImageMagickï¼ˆç”¨ GraphicsMagick æ›¿ä»£ï¼‰
#   - Inkscapeï¼ˆç´„ +300MBï¼‰
#   - VIPSï¼ˆç´„ +100MBï¼‰
#   - Python AI å¥—ä»¶
#   - assimp / CAD å·¥å…·
#
# ==============================================================================

# é…ç½® APT é‡è©¦æ©Ÿåˆ¶
RUN echo 'Acquire::Retries "5";' > /etc/apt/apt.conf.d/80-retries \
    && echo 'Acquire::http::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
    && echo 'Acquire::https::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
    && echo 'Acquire::ftp::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
    && echo 'APT::Get::Assume-Yes "true";' >> /etc/apt/apt.conf.d/80-retries \
    && echo 'DPkg::Lock::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries

# éšæ®µ 1ï¼šåŸºç¤ç³»çµ±å·¥å…·
RUN echo "" && \
    echo "========================================" && \
    echo "ğŸ“¦ éšæ®µ 1/7ï¼šå®‰è£åŸºç¤ç³»çµ±å·¥å…·" && \
    echo "========================================" && \
    apt-get update --fix-missing && apt-get install -y --no-install-recommends \
    locales \
    ca-certificates \
    curl \
    openssl \
    && rm -rf /var/lib/apt/lists/* && \
    echo "âœ… éšæ®µ 1/7 å®Œæˆï¼šåŸºç¤ç³»çµ±å·¥å…·å·²å®‰è£"

# éšæ®µ 2ï¼šæ ¸å¿ƒè½‰æ›å·¥å…·
RUN echo "" && \
    echo "========================================" && \
    echo "ğŸ“¦ éšæ®µ 2/6ï¼šå®‰è£æ ¸å¿ƒè½‰æ›å·¥å…·" && \
    echo "========================================" && \
    apt-get update --fix-missing && apt-get install -y --no-install-recommends \
    ghostscript \
    graphicsmagick \
    poppler-utils \
    potrace \
    qpdf \
    && rm -rf /var/lib/apt/lists/* && \
    echo "âœ… éšæ®µ 2/6 å®Œæˆï¼šæ ¸å¿ƒè½‰æ›å·¥å…·å·²å®‰è£"

# éšæ®µ 2.1ï¼šå®‰è£ daselï¼ˆå¾ GitHub ä¸‹è¼‰äºŒé€²ä½æª”æ¡ˆï¼‰
RUN echo "" && \
    echo "   ğŸ”§ éšæ®µ 2.1ï¼šå®‰è£ dasel..." && \
    ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ]; then \
    DASEL_ARCH="linux_arm64"; \
    else \
    DASEL_ARCH="linux_amd64"; \
    fi && \
    curl -sSLf "https://github.com/TomWright/dasel/releases/download/v2.8.1/dasel_${DASEL_ARCH}" -o /usr/local/bin/dasel && \
    chmod +x /usr/local/bin/dasel && \
    echo "   âœ… dasel å®‰è£å®Œæˆ"

# éšæ®µ 2.2ï¼šå®‰è£ resvgï¼ˆå¾ GitHub ä¸‹è¼‰äºŒé€²ä½æª”æ¡ˆï¼‰
RUN echo "" && \
    echo "   ğŸ”§ éšæ®µ 2.2ï¼šå®‰è£ resvg..." && \
    ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ]; then \
    echo "   âš ï¸ resvg æ²’æœ‰ ARM64 é ç·¨è­¯ç‰ˆæœ¬ï¼Œè·³éå®‰è£"; \
    else \
    curl -sSLf "https://github.com/linebender/resvg/releases/download/v0.44.0/resvg-linux-x86_64.tar.gz" -o /tmp/resvg.tar.gz && \
    tar -xzf /tmp/resvg.tar.gz -C /tmp/ && \
    mv /tmp/resvg /usr/local/bin/resvg && \
    chmod +x /usr/local/bin/resvg && \
    rm -rf /tmp/resvg.tar.gz && \
    echo "   âœ… resvg å®‰è£å®Œæˆ"; \
    fi

# éšæ®µ 3ï¼šå½±éŸ³è™•ç†å·¥å…·ï¼ˆFFmpeg ç²¾ç°¡ç‰ˆï¼‰
RUN echo "" && \
    echo "========================================" && \
    echo "ğŸ“¦ éšæ®µ 3/7ï¼šå®‰è£å½±éŸ³è™•ç†å·¥å…·ï¼ˆç²¾ç°¡ç‰ˆï¼‰" && \
    echo "========================================" && \
    apt-get update --fix-missing && apt-get install -y --no-install-recommends \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/* && \
    echo "âœ… éšæ®µ 3/7 å®Œæˆï¼šFFmpeg å·²å®‰è£"

# éšæ®µ 4ï¼šHeadless æ”¯æ´ï¼ˆLibreOffice éœ€è¦ï¼‰
# æ³¨æ„ï¼šLite ç‰ˆç§»é™¤ Inkscape å’Œ VIPS ä»¥æ¸›å°‘é«”ç©
# GraphicsMagick å·²åœ¨éšæ®µ 2 å®‰è£
RUN echo "" && \
    echo "========================================" && \
    echo "ğŸ“¦ éšæ®µ 4/6ï¼šå®‰è£ Headless æ”¯æ´" && \
    echo "========================================" && \
    apt-get update --fix-missing && apt-get install -y --no-install-recommends \
    xauth \
    xvfb \
    && rm -rf /var/lib/apt/lists/* && \
    echo "âœ… éšæ®µ 4/6 å®Œæˆï¼šHeadless æ”¯æ´å·²å®‰è£"

# éšæ®µ 5ï¼šæ–‡ä»¶è™•ç†å·¥å…·ï¼ˆPandocï¼‰
RUN echo "" && \
    echo "========================================" && \
    echo "ğŸ“¦ éšæ®µ 5/6ï¼šå®‰è£æ–‡ä»¶è™•ç†å·¥å…·" && \
    echo "========================================" && \
    apt-get update --fix-missing && apt-get install -y --no-install-recommends \
    libemail-outlook-message-perl \
    pandoc \
    && rm -rf /var/lib/apt/lists/* && \
    echo "âœ… éšæ®µ 5/6 å®Œæˆï¼šPandoc å·²å®‰è£"

# éšæ®µ 6ï¼šLibreOfficeï¼ˆæ ¸å¿ƒæ–‡ä»¶è½‰æª”å¼•æ“ + åŸºæœ¬å­—å‹ï¼‰
# ä½¿ç”¨å®Œæ•´ libreoffice ä»¥ç¢ºä¿æ‰€æœ‰è½‰æª”åŠŸèƒ½æ­£å¸¸
RUN echo "" && \
    echo "========================================" && \
    echo "ğŸ“¦ éšæ®µ 6/6ï¼šå®‰è£ LibreOffice + å­—å‹" && \
    echo "========================================" && \
    apt-get update --fix-missing && apt-get install -y --no-install-recommends \
    libreoffice \
    fonts-noto-cjk \
    fonts-liberation \
    && rm -rf /var/lib/apt/lists/* && \
    echo "âœ… éšæ®µ 6/6 å®Œæˆï¼šLibreOffice + å­—å‹å·²å®‰è£"

# ==============================================================================
# âœ… APT å¥—ä»¶å®‰è£å®Œæˆ
# ==============================================================================

# ==============================================================================
# ğŸ” PDF Packager é è¨­ç°½ç« æ†‘è­‰ + Python
# ==============================================================================
ENV PATH="/root/.local/bin:${PATH}"
ENV PIP_NO_CACHE_DIR=1
ENV PDF_SIGN_P12_PATH="/app/certs/default.p12"
ENV PDF_SIGN_P12_PASSWORD=""
ENV PDF_SIGN_REASON="ConvertX-CN Lite PDF Packager"
ENV PDF_SIGN_LOCATION="Taiwan"
ENV PDF_SIGN_CONTACT="convertx-cn@localhost"

# éšæ®µ 7ï¼šå®‰è£ Python å’Œç·¨è­¯ä¾è³´
RUN echo "" && \
    echo "========================================" && \
    echo "ğŸ” éšæ®µ 7/8ï¼šå®‰è£ Python + ç·¨è­¯å·¥å…·" && \
    echo "========================================" && \
    apt-get update --fix-missing && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-dev \
    gcc \
    libffi-dev \
    && rm -rf /var/lib/apt/lists/* && \
    echo "âœ… éšæ®µ 7/8 å®Œæˆï¼šPython + ç·¨è­¯å·¥å…·å·²å®‰è£"

# éšæ®µ 8ï¼šå®‰è£ endesive ä¸¦ç”¢ç”Ÿç°½ç« æ†‘è­‰
RUN echo "" && \
    echo "========================================" && \
    echo "ğŸ” éšæ®µ 8/8ï¼šå®‰è£ endesive + ç”¢ç”Ÿæ†‘è­‰" && \
    echo "========================================" && \
    pip3 install --no-cache-dir --break-system-packages endesive && \
    mkdir -p /app/certs && \
    openssl req -x509 -newkey rsa:2048 \
    -keyout /tmp/key.pem -out /tmp/cert.pem \
    -days 3650 -nodes \
    -subj "/CN=PDF Packager Default/O=ConvertX-CN Lite/C=TW" && \
    openssl pkcs12 -export \
    -inkey /tmp/key.pem -in /tmp/cert.pem \
    -out /app/certs/default.p12 \
    -passout pass: && \
    rm -f /tmp/key.pem /tmp/cert.pem && \
    chmod 644 /app/certs/default.p12 && \
    echo "âœ… éšæ®µ 8/8 å®Œæˆï¼šendesive + ç°½ç« æ†‘è­‰å·²å®‰è£"

# æ¸…ç†ç·¨è­¯å·¥å…·ä»¥æ¸›å°é«”ç©
RUN apt-get update && \
    apt-get purge -y --auto-remove gcc python3-dev libffi-dev && \
    rm -rf /var/lib/apt/lists/* && \
    echo "âœ… ç·¨è­¯å·¥å…·å·²æ¸…ç†"

# ==============================================================================
# æœ€çµ‚æ¸…ç† + Locale è¨­å®š + è‡ªè¨‚å­—å‹ï¼ˆåˆä½µä»¥æ¸›å°‘ layerï¼‰
# ==============================================================================
RUN rm -rf /usr/share/doc/* \
    && rm -rf /usr/share/man/* \
    && rm -rf /usr/share/info/* \
    && sed -i 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen \
    && sed -i 's/# zh_TW.UTF-8 UTF-8/zh_TW.UTF-8 UTF-8/' /etc/locale.gen \
    && sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen \
    && locale-gen

# å®‰è£è‡ªè¨‚å­—å‹ï¼ˆæ¨™æ¥·é«”ç­‰å°ç£å¸¸ç”¨å­—å‹ï¼‰
RUN mkdir -p /usr/share/fonts/truetype/custom
COPY fonts/ /usr/share/fonts/truetype/custom/
RUN fc-cache -fv

# ==============================================================================
# Install VTracer binaryï¼ˆå‘é‡è¿½è¹¤å·¥å…·ï¼‰
# ==============================================================================
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ]; then \
    VTRACER_ASSET="vtracer-aarch64-unknown-linux-musl.tar.gz"; \
    else \
    VTRACER_ASSET="vtracer-x86_64-unknown-linux-musl.tar.gz"; \
    fi && \
    curl -L -o /tmp/vtracer.tar.gz "https://github.com/visioncortex/vtracer/releases/download/0.6.4/${VTRACER_ASSET}" && \
    tar -xzf /tmp/vtracer.tar.gz -C /tmp/ && \
    mv /tmp/vtracer /usr/local/bin/vtracer && \
    chmod +x /usr/local/bin/vtracer && \
    rm /tmp/vtracer.tar.gz

COPY --from=install /temp/prod/node_modules node_modules
COPY --from=prerelease /app/public/ /app/public/
COPY --from=prerelease /app/dist /app/dist

RUN mkdir data

EXPOSE 3000/tcp

# ==============================================================================
# ğŸ”§ ç’°å¢ƒè®Šæ•¸ç¸½è¦½ï¼ˆLite ç‰ˆï¼‰
# ==============================================================================

# ------------------------------------------------------------------------------
# 1ï¸âƒ£ ç³»çµ± Localeï¼ˆæ”¯æ´ä¸­æ–‡é¿å…äº‚ç¢¼ï¼‰
# ------------------------------------------------------------------------------
ENV LANG=zh_TW.UTF-8
ENV LC_ALL=zh_TW.UTF-8

# ------------------------------------------------------------------------------
# 2ï¸âƒ£ Headless ç’°å¢ƒè¨­å®š
# ------------------------------------------------------------------------------
ENV QT_QPA_PLATFORM="offscreen"
ENV DISPLAY=":99"

# ------------------------------------------------------------------------------
# 3ï¸âƒ£ æ‡‰ç”¨ç¨‹å¼è¨­å®š
# ------------------------------------------------------------------------------
ENV PANDOC_PDF_ENGINE=pdflatex
ENV NODE_ENV=production

# ------------------------------------------------------------------------------
# 4ï¸âƒ£ Lite ç‰ˆæ¨™è­˜
# ------------------------------------------------------------------------------
ENV CONVERTX_EDITION="lite"

ENTRYPOINT [ "bun", "run", "dist/src/index.js" ]
