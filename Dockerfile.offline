# ==============================================================================
# ConvertX-CN å®˜æ–¹ Docker Image
# ç‰ˆæœ¬ï¼šv0.1.16 - å®Œå…¨é›¢ç·šåŒ–ç‰ˆæœ¬
# ==============================================================================
#
# ğŸ“¦ Image èªªæ˜ï¼š
#   - é€™æ˜¯ ConvertX-CN å®˜æ–¹ Docker Hub Image çš„ç”Ÿç”¢ Dockerfile
#   - âš ï¸ æ‰€æœ‰æ¨¡å‹ã€å­—å‹ã€tokenizer å·²åœ¨ build éšæ®µå®Œæ•´é ä¸‹è¼‰
#   - âš ï¸ Runtime å®Œå…¨é›¢ç·šé‹è¡Œï¼ˆåƒ…ç¿»è­¯æœå‹™å…è¨±é€£ç¶²ï¼‰
#
# ğŸ”’ Offline-first è¨­è¨ˆåŸå‰‡ï¼ˆç¡¬æ€§è¦å‰‡ï¼‰ï¼š
#   1. Runtimeï¼ˆdocker run å¾Œï¼‰ï¼š
#      âŒ ç¦æ­¢ä»»ä½•æ¨¡å‹ã€å­—å‹ã€tokenizerã€metadata ä¸‹è¼‰
#      âŒ MinerU / BabelDOC / PDFMathTranslate ä¸å¾—å˜—è©¦é€£ç¶²
#      âœ… åªæœ‰ç¿»è­¯æœå‹™ï¼ˆGoogle / DeepL / Azure / OpenAIï¼‰å…è¨±é€£ç¶²
#   2. Build timeï¼ˆdocker build æ™‚ï¼‰ï¼š
#      âœ… å…è¨±é€£ç¶²ä¸‹è¼‰æ‰€æœ‰è³‡æº
#      âœ… æ‰€æœ‰ã€Œå¯èƒ½æœƒåœ¨ runtime ä¸‹è¼‰çš„æ±è¥¿ã€å¿…é ˆæå‰å›ºå®šå­˜æ”¾
#
# ğŸ¤– é ä¸‹è¼‰æ¨¡å‹æ¸…å–®ï¼š
#   - PDFMathTranslate: DocLayout-YOLO ONNXï¼ˆä½ˆå±€åˆ†æï¼‰
#   - BabelDOC: DocLayout-YOLO + å­—å‹è³‡æº + tiktoken
#   - MinerU: PDF-Extract-Kit-1.0ï¼ˆPipeline æ¨¡å‹ï¼‰
#     åŒ…å«ï¼šDocLayout-YOLO, YOLOv8 MFD, UniMERNet, PaddleOCR, LayoutReader, SLANet
#
# ğŸŒ å…§å»ºèªè¨€æ”¯æ´ï¼š
#   - OCR: è‹±æ–‡ã€ç¹é«”ä¸­æ–‡ã€ç°¡é«”ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ“æ–‡ã€å¾·æ–‡ã€æ³•æ–‡
#   - Locale: en_US, zh_TW, zh_CN, ja_JP, ko_KR, de_DE, fr_FR
#   - å­—å‹: Noto CJK, Liberation, æ¨™æ¥·é«”, Source Han Serif
#   - LaTeX: CJKã€å¾·æ–‡ã€æ³•æ–‡ã€é˜¿æ‹‰ä¼¯èªã€å¸Œä¼¯ä¾†èª
#
# ğŸ“Š Image å¤§å°ï¼šç´„ 10-14 GBï¼ˆå«å®Œæ•´æ¨¡å‹ï¼‰
#
# ==============================================================================
# ğŸ—ï¸ Multi-Stage Build çµæ§‹ï¼š
#   Stage 1 [base]: Bun runtime åŸºç¤
#   Stage 2 [install]: Node ä¾è³´å®‰è£
#   Stage 3 [prerelease]: æ‡‰ç”¨ç¨‹å¼å»ºæ§‹
#   Stage 4 [system-tools]: APT ç³»çµ±å·¥å…·
#   Stage 5 [python-base]: Python åŸºç¤ç’°å¢ƒ
#   Stage 6 [python-tools]: Python CLI å·¥å…·
#   Stage 7 [models-download]: æ¨¡å‹ä¸‹è¼‰ï¼ˆç¨ç«‹ stageï¼‰
#   Stage 8 [final]: æœ€çµ‚ Imageï¼ˆåˆä½µæ‰€æœ‰å±¤ï¼‰
# ==============================================================================

# ===================================
# Stage 1: Base - Bun Runtime
# ===================================
FROM debian:bookworm-slim AS base
LABEL org.opencontainers.image.source="https://github.com/pi-docket/ConvertX-CN"
LABEL org.opencontainers.image.description="ConvertX-CN - å®Œå…¨é›¢ç·šåŒ–æª”æ¡ˆè½‰æ›æœå‹™"
LABEL org.opencontainers.image.version="v0.1.16-offline"
WORKDIR /app

# è¨­å®šéäº’å‹•æ¨¡å¼
ENV DEBIAN_FRONTEND=noninteractive

# é…ç½® APT é‡è©¦æ©Ÿåˆ¶
RUN echo 'Acquire::Retries "5";' > /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::http::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::https::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::ftp::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'DPkg::Lock::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries

# å®‰è£åŸºç¤å·¥å…·
RUN apt-get update && apt-get install -y --no-install-recommends \
  curl \
  unzip \
  ca-certificates \
  && rm -rf /var/lib/apt/lists/*

# å®‰è£ Bunï¼ˆæ ¹æ“šæ¶æ§‹é¸æ“‡ç‰ˆæœ¬ï¼‰
RUN ARCH=$(uname -m) && \
  if [ "$ARCH" = "aarch64" ]; then \
  curl -fsSL --retry 3 --retry-delay 5 --retry-all-errors \
  -o bun-linux-aarch64.zip \
  https://github.com/oven-sh/bun/releases/download/bun-v1.3.6/bun-linux-aarch64.zip; \
  else \
  curl -fsSL --retry 3 --retry-delay 5 --retry-all-errors \
  -o bun-linux-x64-baseline.zip \
  https://github.com/oven-sh/bun/releases/download/bun-v1.3.6/bun-linux-x64-baseline.zip; \
  fi && \
  unzip -j bun-linux-*.zip -d /usr/local/bin && \
  rm bun-linux-*.zip && \
  chmod +x /usr/local/bin/bun

# ===================================
# Stage 2: Install - Node Dependencies
# ===================================
FROM base AS install

# é–‹ç™¼ä¾è³´
RUN mkdir -p /temp/dev
COPY package.json bun.lock /temp/dev/
RUN cd /temp/dev && bun install --frozen-lockfile

# ç”Ÿç”¢ä¾è³´
RUN mkdir -p /temp/prod
COPY package.json bun.lock /temp/prod/
RUN cd /temp/prod && bun install --frozen-lockfile --production

# ===================================
# Stage 3: Prerelease - Build App
# ===================================
FROM base AS prerelease
WORKDIR /app
COPY --from=install /temp/dev/node_modules node_modules
COPY . .
RUN bun run build

# ===================================
# Stage 4: System Tools
# ===================================
FROM base AS system-tools

# é…ç½® APT
RUN echo 'Acquire::Retries "5";' > /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::http::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::https::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::ftp::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'APT::Get::Assume-Yes "true";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'DPkg::Lock::Timeout "120";' >> /etc/apt/apt.conf.d/80-retries

# éšæ®µ 4.1ï¼šåŸºç¤ç³»çµ±å·¥å…· + Locale
RUN echo "ğŸ“¦ [Stage 4.1] å®‰è£åŸºç¤ç³»çµ±å·¥å…·..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  locales \
  ca-certificates \
  curl \
  openssl \
  git \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.2ï¼šæ ¸å¿ƒè½‰æ›å·¥å…·ï¼ˆè¼•é‡ï¼‰
RUN echo "ğŸ“¦ [Stage 4.2] å®‰è£æ ¸å¿ƒè½‰æ›å·¥å…·..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  assimp-utils \
  dcraw \
  dvisvgm \
  ghostscript \
  graphicsmagick \
  mupdf-tools \
  poppler-utils \
  potrace \
  qpdf \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.3ï¼šå®‰è£ daselï¼ˆå¾ GitHub äºŒé€²ä½ï¼‰
RUN echo "ğŸ“¦ [Stage 4.3] å®‰è£ dasel..." && \
  ARCH=$(uname -m) && \
  if [ "$ARCH" = "aarch64" ]; then DASEL_ARCH="linux_arm64"; \
  else DASEL_ARCH="linux_amd64"; fi && \
  curl -sSLf --retry 3 --retry-delay 5 --retry-all-errors \
  "https://github.com/TomWright/dasel/releases/download/v2.8.1/dasel_${DASEL_ARCH}" \
  -o /usr/local/bin/dasel && \
  chmod +x /usr/local/bin/dasel

# éšæ®µ 4.4ï¼šå®‰è£ resvgï¼ˆåƒ… x86_64ï¼‰
RUN echo "ğŸ“¦ [Stage 4.4] å®‰è£ resvg..." && \
  ARCH=$(uname -m) && \
  if [ "$ARCH" = "aarch64" ]; then \
  echo "âš ï¸ resvg ç„¡ ARM64 ç‰ˆæœ¬ï¼Œè·³é"; \
  else \
  curl -sSLf --retry 3 --retry-delay 5 --retry-all-errors \
  "https://github.com/linebender/resvg/releases/download/v0.44.0/resvg-linux-x86_64.tar.gz" \
  -o /tmp/resvg.tar.gz && \
  tar -xzf /tmp/resvg.tar.gz -C /tmp/ && \
  mv /tmp/resvg /usr/local/bin/resvg && \
  chmod +x /usr/local/bin/resvg && \
  rm -rf /tmp/resvg.tar.gz; \
  fi

# éšæ®µ 4.5ï¼šç·¨è­¯å®‰è£ deark
RUN echo "ğŸ“¦ [Stage 4.5] ç·¨è­¯ deark..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  build-essential \
  && cd /tmp && \
  git clone --depth 1 https://github.com/jsummers/deark.git && \
  cd deark && make -j$(nproc) && \
  cp deark /usr/local/bin/deark && \
  chmod +x /usr/local/bin/deark && \
  cd / && rm -rf /tmp/deark && \
  apt-get remove -y build-essential && \
  apt-get autoremove -y && \
  rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.6ï¼šå½±éŸ³è™•ç†å·¥å…·
RUN echo "ğŸ“¦ [Stage 4.6] å®‰è£ FFmpeg..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  ffmpeg \
  libavcodec-extra \
  libva2 \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.7ï¼šåœ–åƒè™•ç†å·¥å…·ï¼ˆå« ImageMagickï¼‰
# âš ï¸ ä¿®å¾©ï¼šç¢ºä¿ ImageMagick å·²å®‰è£
RUN echo "ğŸ“¦ [Stage 4.7] å®‰è£åœ–åƒè™•ç†å·¥å…·ï¼ˆå« ImageMagickï¼‰..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  imagemagick \
  inkscape \
  libheif-examples \
  libjxl-tools \
  libvips-tools \
  xauth \
  xvfb \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.8ï¼šæ–‡ä»¶è™•ç†å·¥å…·
RUN echo "ğŸ“¦ [Stage 4.8] å®‰è£ Calibre + Pandoc..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  calibre \
  libemail-outlook-message-perl \
  pandoc \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.9ï¼šLibreOffice
RUN echo "ğŸ“¦ [Stage 4.9] å®‰è£ LibreOfficeï¼ˆéœ€æ•¸åˆ†é˜ï¼‰..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  libreoffice \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.10ï¼šTexLive åŸºç¤
RUN echo "ğŸ“¦ [Stage 4.10] å®‰è£ TexLive åŸºç¤..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  texlive-base \
  texlive-latex-base \
  texlive-latex-recommended \
  texlive-fonts-recommended \
  texlive-xetex \
  latexmk \
  lmodern \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.11ï¼šTexLive èªè¨€åŒ…
RUN echo "ğŸ“¦ [Stage 4.11] å®‰è£ TexLive èªè¨€åŒ…..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  texlive-lang-cjk \
  texlive-lang-german \
  texlive-lang-french \
  texlive-lang-arabic \
  texlive-lang-other \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.12ï¼šOCR æ”¯æ´
RUN echo "ğŸ“¦ [Stage 4.12] å®‰è£ Tesseract OCR..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  tesseract-ocr \
  tesseract-ocr-eng \
  tesseract-ocr-chi-tra \
  tesseract-ocr-chi-sim \
  tesseract-ocr-jpn \
  tesseract-ocr-kor \
  tesseract-ocr-deu \
  tesseract-ocr-fra \
  ocrmypdf \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 4.13ï¼šå­—å‹
RUN echo "ğŸ“¦ [Stage 4.13] å®‰è£ç³»çµ±å­—å‹..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  fonts-noto-cjk \
  fonts-noto-core \
  fonts-noto-color-emoji \
  fonts-liberation \
  && rm -rf /var/lib/apt/lists/*

# ===================================
# Stage 5: Python Base
# ===================================
FROM system-tools AS python-base

# éšæ®µ 5.1ï¼šPython åŸºç¤ + uv
RUN echo "ğŸ“¦ [Stage 5.1] å®‰è£ Python åŸºç¤..." && \
  apt-get update --fix-missing && apt-get install -y --no-install-recommends \
  python3 \
  python3-pip \
  python3-venv \
  python3-numpy \
  python3-tinycss2 \
  python3-opencv \
  python3-img2pdf \
  && rm -rf /var/lib/apt/lists/*

# éšæ®µ 5.2ï¼šå®‰è£ uvï¼ˆPython å¥—ä»¶ç®¡ç†å™¨ï¼‰
# âš ï¸ é‡è¦ï¼šä½¿ç”¨ uv ä½œç‚ºä¸»è¦å®‰è£æ–¹å¼ï¼Œç¢ºä¿ä¸€è‡´æ€§
RUN echo "ğŸ“¦ [Stage 5.2] å®‰è£ uv..." && \
  pip3 install --no-cache-dir --break-system-packages uv && \
  uv --version

# è¨­å®š PATH
ENV PATH="/root/.local/bin:/usr/local/bin:${PATH}"

# ===================================
# Stage 6: Python Tools
# ===================================
FROM python-base AS python-tools

# éšæ®µ 6.1ï¼šå®‰è£ huggingface_hub + endesiveï¼ˆPDF ç°½ç« ï¼‰
RUN echo "ğŸ“¦ [Stage 6.1] å®‰è£ huggingface_hub + endesive..." && \
  apt-get update && apt-get install -y --no-install-recommends \
  build-essential \
  swig \
  libpcsclite-dev \
    && uv pip install --system --break-system-packages --no-cache huggingface_hub endesive && \
    uv pip install --system --break-system-packages --no-cache "markitdown[all]"
RUN echo "ğŸ“¦ [Stage 6.3] å®‰è£ pdf2zh..." && \
    uv pip install --system --break-system-packages --no-cache pdf2zh
RUN echo "ğŸ“¦ [Stage 6.4] å®‰è£ babeldoc..." && \
    uv pip install --system --break-system-packages --no-cache babeldoc || echo "âš ï¸ babeldoc å®‰è£å¯èƒ½æœ‰è­¦å‘Š"

# éšæ®µ 6.5ï¼šå®‰è£ MinerUï¼ˆâš ï¸ é—œéµä¿®å¾©ï¼‰
# âš ï¸ åªä½¿ç”¨ system-level å®‰è£ï¼ˆuv pip install --systemï¼‰
# âš ï¸ ç¦æ­¢ä½¿ç”¨ pipxï¼ˆæœƒå°è‡´ binary ä¸åœ¨ PATHï¼‰
RUN echo "ğŸ“¦ [Stage 6.5] å®‰è£ MinerUï¼ˆsystem-level onlyï¼‰..." && \
    ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ]; then \
        echo "âš ï¸ ARM64ï¼šMinerU ä¸æ”¯æ´ï¼Œè·³é"; \
    else \
        echo "ğŸ”§ ä½¿ç”¨ uv pip install --systemï¼ˆå®˜æ–¹æ¨è–¦ï¼‰..." && \
        uv pip install --system --break-system-packages --no-cache -U "mineru[all]" && \
        echo "âœ… é©—è­‰ MinerU å®‰è£..." && \
        which mineru && \
        mineru --version || echo "(ç‰ˆæœ¬è³‡è¨Šå¯èƒ½ä¸å¯ç”¨)"; \
    fi

# ===================================
# Stage 7: Models Downloadï¼ˆç¨ç«‹ Stageï¼‰
# ===================================
FROM python-tools AS models-download

# æ¨¡å‹ç›®éŒ„å®šç¾©
ENV MINERU_MODELS_DIR="/opt/mineru/models"
ENV BABELDOC_CACHE_DIR="/opt/babeldoc/cache"
ENV HF_HOME="/tmp/hf_download_cache"

# éšæ®µ 7.1ï¼šå‰µå»ºç›®éŒ„çµæ§‹
RUN mkdir -p "${MINERU_MODELS_DIR}" && \
  mkdir -p "${BABELDOC_CACHE_DIR}/models" && \
  mkdir -p "${BABELDOC_CACHE_DIR}/fonts" && \
  mkdir -p "${BABELDOC_CACHE_DIR}/cmap" && \
  mkdir -p "${BABELDOC_CACHE_DIR}/tiktoken"

# éšæ®µ 7.2ï¼šä¸‹è¼‰ MinerU Pipeline æ¨¡å‹
# âš ï¸ é—œéµä¿®å¾©ï¼šä½¿ç”¨é¡¯å¼ä¸‹è¼‰ï¼Œå­˜æ”¾åˆ°å›ºå®šç›®éŒ„
RUN <<EOF
echo "ğŸ“¥ [Stage 7.2] ä¸‹è¼‰ MinerU Pipeline æ¨¡å‹..."
ARCH=$(uname -m)
if [ "$ARCH" = "aarch64" ]; then
    echo "âš ï¸ ARM64ï¼šè·³é MinerU æ¨¡å‹ä¸‹è¼‰"
else
    python3 <<PYTHON
from huggingface_hub import snapshot_download
import os

models_dir = os.environ.get('MINERU_MODELS_DIR', '/opt/mineru/models')
print(f'ä¸‹è¼‰ PDF-Extract-Kit-1.0 åˆ° {models_dir}...')

snapshot_download(
    repo_id='opendatalab/PDF-Extract-Kit-1.0',
    local_dir=f'{models_dir}/PDF-Extract-Kit-1.0',
    local_dir_use_symlinks=False,
    resume_download=True
)
print('âœ… PDF-Extract-Kit-1.0 ä¸‹è¼‰å®Œæˆ')
PYTHON
    echo "ğŸ“‹ MinerU æ¨¡å‹ç›®éŒ„å…§å®¹ï¼š"
    ls -la "${MINERU_MODELS_DIR}/" || true
    du -sh "${MINERU_MODELS_DIR}/PDF-Extract-Kit-1.0" || true
fi
EOF

# éšæ®µ 7.3ï¼šç”¢ç”Ÿ MinerU é…ç½®æª”ï¼ˆæŒ‡å‘å›ºå®šç›®éŒ„ï¼‰
RUN <<EOF
echo "ğŸ“ [Stage 7.3] ç”¢ç”Ÿ mineru.json..."
ARCH=$(uname -m)
if [ "$ARCH" = "aarch64" ]; then
    echo "âš ï¸ ARM64ï¼šè·³é mineru.json"
else
    python3 <<PYTHON
import json

config = {
    'models-dir': {
        'pipeline': '/opt/mineru/models/PDF-Extract-Kit-1.0',
        'vlm': ''
    },
    'model-source': 'local',
    'latex-delimiter-config': {
        'display': {'left': '@@', 'right': '@@'},
        'inline': {'left': '@', 'right': '@'}
    }
}

with open('/opt/mineru/mineru.json', 'w') as f:
    json.dump(config, f, indent=2)

with open('/root/mineru.json', 'w') as f:
    json.dump(config, f, indent=2)

print('âœ… mineru.json å·²ç”¢ç”Ÿ')
print(json.dumps(config, indent=2))
PYTHON
fi
EOF

# éšæ®µ 7.4ï¼šBabelDOC warmup + è³‡æºä¸‹è¼‰
# âš ï¸ é—œéµä¿®å¾©ï¼šå®Œæ•´ warmupï¼Œç¢ºä¿æ‰€æœ‰è³‡æºå·²ä¸‹è¼‰
RUN echo "ğŸ“¥ [Stage 7.4] BabelDOC warmup..." && \
  export BABELDOC_CACHE_PATH="${BABELDOC_CACHE_DIR}" && \
  if command -v babeldoc >/dev/null 2>&1; then \
  echo "åŸ·è¡Œ babeldoc --warmup..." && \
  babeldoc --warmup 2>&1 || echo "âš ï¸ warmup å¯èƒ½æœ‰è­¦å‘Š" && \
  echo "é©—è­‰ BabelDOC è³‡æº..." && \
  ls -la "${BABELDOC_CACHE_DIR}/" && \
  du -sh "${BABELDOC_CACHE_DIR}/" || true; \
  else \
  echo "âš ï¸ babeldoc ä¸å¯ç”¨ï¼Œè·³é warmup"; \
  fi

# éšæ®µ 7.5ï¼šä¸‹è¼‰ tiktoken ç·¨ç¢¼ï¼ˆBabelDOC ä¾è³´ï¼‰
RUN <<EOF
echo "ğŸ“¥ [Stage 7.5] ä¸‹è¼‰ tiktoken ç·¨ç¢¼..."
python3 <<PYTHON
try:
    import tiktoken
    for enc_name in ['cl100k_base', 'p50k_base', 'r50k_base']:
        try:
            enc = tiktoken.get_encoding(enc_name)
            print(f'âœ… tiktoken {enc_name} å·²ä¸‹è¼‰')
        except Exception as e:
            print(f'âš ï¸ tiktoken {enc_name} ä¸‹è¼‰å¤±æ•—: {e}')
except ImportError:
    print('âš ï¸ tiktoken æœªå®‰è£ï¼Œè·³é')
PYTHON
EOF

# éšæ®µ 7.6ï¼šæ¸…ç†ä¸‹è¼‰ cacheï¼ˆä¿ç•™å¯¦éš›æ¨¡å‹ï¼‰
RUN echo "ğŸ§¹ [Stage 7.6] æ¸…ç†ä¸‹è¼‰ cache..." && \
  rm -rf /tmp/hf_download_cache && \
  rm -rf /root/.cache/huggingface && \
  rm -rf /root/.cache/pip && \
  rm -rf /root/.cache/uv && \
  find /usr -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
  echo "âœ… Cache æ¸…ç†å®Œæˆ"

# ===================================
# Stage 8: Final Image
# ===================================
FROM python-tools AS release
WORKDIR /app

# å¾ models-download stage è¤‡è£½æ¨¡å‹
COPY --from=models-download /opt/mineru /opt/mineru
COPY --from=models-download /opt/babeldoc /opt/babeldoc
COPY --from=models-download /root/mineru.json /root/mineru.json

# è¤‡è£½æ‡‰ç”¨ç¨‹å¼
COPY --from=install /temp/prod/node_modules node_modules
COPY --from=prerelease /app/public/ /app/public/
COPY --from=prerelease /app/dist /app/dist

# ==============================================================================
# å®‰è£è‡ªè¨‚å­—å‹
# ==============================================================================
RUN mkdir -p /usr/share/fonts/truetype/custom
COPY fonts/ /usr/share/fonts/truetype/custom/

# è¤‡è£½é ä¸‹è¼‰çš„ ONNX æ¨¡å‹
RUN mkdir -p /root/.cache/babeldoc/models
COPY models/ /root/.cache/babeldoc/models/

# è¤‡è£½å­—å‹åˆ° BabelDOC ç›®éŒ„
RUN mkdir -p /root/.cache/babeldoc/fonts && \
  cp /usr/share/fonts/truetype/custom/GoNotoKurrent-Regular.ttf /root/.cache/babeldoc/fonts/ 2>/dev/null || true && \
  cp /usr/share/fonts/truetype/custom/SourceHanSerifCN-Regular.ttf /root/.cache/babeldoc/fonts/ 2>/dev/null || true && \
  cp /usr/share/fonts/truetype/custom/SourceHanSerifTW-Regular.ttf /root/.cache/babeldoc/fonts/ 2>/dev/null || true && \
  cp /usr/share/fonts/truetype/custom/SourceHanSerifJP-Regular.ttf /root/.cache/babeldoc/fonts/ 2>/dev/null || true && \
  cp /usr/share/fonts/truetype/custom/SourceHanSerifKR-Regular.ttf /root/.cache/babeldoc/fonts/ 2>/dev/null || true

# åŒæ­¥ BabelDOC cache å¾å›ºå®šç›®éŒ„
RUN if [ -d /opt/babeldoc/cache ]; then \
  cp -r /opt/babeldoc/cache/* /root/.cache/babeldoc/ 2>/dev/null || true; \
  fi

# æ›´æ–°å­—å‹ cache
RUN fc-cache -fv

# ==============================================================================
# PDF ç°½ç« æ†‘è­‰
# ==============================================================================
RUN mkdir -p /app/certs && \
  openssl req -x509 -newkey rsa:2048 \
  -keyout /tmp/key.pem -out /tmp/cert.pem \
  -days 3650 -nodes \
  -subj "/CN=PDF Packager Default/O=ConvertX-CN/C=TW" && \
  openssl pkcs12 -export \
  -inkey /tmp/key.pem -in /tmp/cert.pem \
  -out /app/certs/default.p12 \
  -passout pass: && \
  rm -f /tmp/key.pem /tmp/cert.pem && \
  chmod 644 /app/certs/default.p12

# ==============================================================================
# VTracer
# ==============================================================================
RUN ARCH=$(uname -m) && \
  if [ "$ARCH" = "aarch64" ]; then \
  VTRACER_ASSET="vtracer-aarch64-unknown-linux-musl.tar.gz"; \
  else \
  VTRACER_ASSET="vtracer-x86_64-unknown-linux-musl.tar.gz"; \
  fi && \
  curl -L --retry 3 --retry-delay 5 --retry-all-errors \
  -o /tmp/vtracer.tar.gz \
  "https://github.com/visioncortex/vtracer/releases/download/0.6.4/${VTRACER_ASSET}" && \
  tar -xzf /tmp/vtracer.tar.gz -C /tmp/ && \
  mv /tmp/vtracer /usr/local/bin/vtracer && \
  chmod +x /usr/local/bin/vtracer && \
  rm /tmp/vtracer.tar.gz

# ==============================================================================
# Locale è¨­å®š
# ==============================================================================
RUN sed -i 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen && \
  sed -i 's/# zh_TW.UTF-8 UTF-8/zh_TW.UTF-8 UTF-8/' /etc/locale.gen && \
  sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen && \
  sed -i 's/# ja_JP.UTF-8 UTF-8/ja_JP.UTF-8 UTF-8/' /etc/locale.gen && \
  sed -i 's/# ko_KR.UTF-8 UTF-8/ko_KR.UTF-8 UTF-8/' /etc/locale.gen && \
  sed -i 's/# de_DE.UTF-8 UTF-8/de_DE.UTF-8 UTF-8/' /etc/locale.gen && \
  sed -i 's/# fr_FR.UTF-8 UTF-8/fr_FR.UTF-8 UTF-8/' /etc/locale.gen && \
  locale-gen

# ==============================================================================
# æœ€çµ‚æ¸…ç†
# ==============================================================================
RUN rm -rf /usr/share/doc/texlive* \
  && rm -rf /usr/share/texlive/texmf-dist/doc \
  && rm -rf /usr/share/doc/* \
  && rm -rf /usr/share/man/* \
  && rm -rf /usr/share/info/* \
  && rm -rf /tmp/* \
  && rm -rf /var/tmp/*

# è¤‡è£½é©—è­‰è…³æœ¬
COPY scripts/verify-models.sh /app/scripts/verify-models.sh
RUN chmod +x /app/scripts/verify-models.sh

# å‰µå»ºè³‡æ–™ç›®éŒ„
RUN mkdir -p data

# ==============================================================================
# ğŸ”’ Runtime é›¢ç·šé©—è­‰ï¼ˆé—œéµæ­¥é©Ÿï¼‰
# ==============================================================================
# âš ï¸ æ­¤æ­¥é©Ÿæ¨¡æ“¬æ–·ç¶²ç’°å¢ƒï¼Œé©—è­‰æ‰€æœ‰å·¥å…·å¯é›¢ç·šåŸ·è¡Œ
# ==============================================================================
RUN echo "======================================" && \
  echo "ğŸ”’ Runtime é›¢ç·šé©—è­‰" && \
  echo "======================================" && \
  ARCH=$(uname -m) && \
  VALIDATION_PASSED=true && \
  \
  # é©—è­‰ MinerU
  echo "ğŸ” é©—è­‰ MinerU..." && \
  if [ "$ARCH" != "aarch64" ]; then \
  if command -v mineru >/dev/null 2>&1; then \
  echo "  âœ… mineru å¯åŸ·è¡Œ: $(which mineru)"; \
  else \
  echo "  âŒ mineru ä¸å¯åŸ·è¡Œ" && VALIDATION_PASSED=false; \
  fi && \
  if [ -d "/opt/mineru/models/PDF-Extract-Kit-1.0" ]; then \
  echo "  âœ… MinerU æ¨¡å‹ç›®éŒ„å­˜åœ¨"; \
  else \
  echo "  âŒ MinerU æ¨¡å‹ç›®éŒ„ä¸å­˜åœ¨" && VALIDATION_PASSED=false; \
  fi && \
  if [ -f "/root/mineru.json" ]; then \
  echo "  âœ… mineru.json å­˜åœ¨"; \
  else \
  echo "  âŒ mineru.json ä¸å­˜åœ¨" && VALIDATION_PASSED=false; \
  fi; \
  else \
  echo "  âš ï¸ ARM64ï¼šè·³é MinerU é©—è­‰"; \
  fi && \
  \
  # é©—è­‰ BabelDOC
  echo "ğŸ” é©—è­‰ BabelDOC..." && \
  if command -v babeldoc >/dev/null 2>&1; then \
  babeldoc --help >/dev/null 2>&1 && echo "  âœ… babeldoc --help æˆåŠŸ" || echo "  âš ï¸ babeldoc --help æœ‰è­¦å‘Š"; \
  else \
  echo "  âš ï¸ babeldoc ä¸å¯ç”¨"; \
  fi && \
  \
  # é©—è­‰ pdf2zh
  echo "ğŸ” é©—è­‰ pdf2zh..." && \
  if command -v pdf2zh >/dev/null 2>&1; then \
  pdf2zh --help >/dev/null 2>&1 && echo "  âœ… pdf2zh --help æˆåŠŸ" || echo "  âš ï¸ pdf2zh --help æœ‰è­¦å‘Š"; \
  else \
  echo "  âš ï¸ pdf2zh ä¸å¯ç”¨"; \
  fi && \
  \
  # é©—è­‰ ImageMagick
  echo "ğŸ” é©—è­‰ ImageMagick..." && \
  if command -v convert >/dev/null 2>&1; then \
  echo "  âœ… ImageMagick å·²å®‰è£: $(convert --version | head -1)"; \
  else \
  echo "  âŒ ImageMagick æœªå®‰è£" && VALIDATION_PASSED=false; \
  fi && \
  \
  # é©—è­‰æ¨¡å‹æª”æ¡ˆ
  echo "ğŸ” é©—è­‰ ONNX æ¨¡å‹..." && \
  if [ -f "/root/.cache/babeldoc/models/doclayout_yolo_docstructbench_imgsz1024.onnx" ]; then \
  echo "  âœ… DocLayout-YOLO ONNX å­˜åœ¨"; \
  else \
  echo "  âš ï¸ DocLayout-YOLO ONNX ä¸å­˜åœ¨ï¼ˆå°‡ä½¿ç”¨ COPY è¤‡è£½ï¼‰"; \
  fi && \
  \
  # é©—è­‰å­—å‹
  echo "ğŸ” é©—è­‰å­—å‹..." && \
  FONTS_COUNT=$(ls /usr/share/fonts/truetype/custom/*.ttf 2>/dev/null | wc -l) && \
  echo "  âœ… è‡ªè¨‚å­—å‹æ•¸é‡: ${FONTS_COUNT}" && \
  \
  echo "======================================" && \
  if [ "$VALIDATION_PASSED" = "true" ]; then \
  echo "âœ… é›¢ç·šé©—è­‰é€šéï¼"; \
  else \
  echo "âŒ é›¢ç·šé©—è­‰å¤±æ•—ï¼" && exit 1; \
  fi && \
  echo "======================================"

# ==============================================================================
# ğŸ” Runtime ç’°å¢ƒè®Šæ•¸ï¼ˆå¼·åˆ¶é›¢ç·šæ¨¡å¼ï¼‰
# ==============================================================================

# 1ï¸âƒ£ ç³»çµ± Locale
ENV LANG=zh_TW.UTF-8
ENV LC_ALL=zh_TW.UTF-8

# 2ï¸âƒ£ Headless ç’°å¢ƒ
ENV QT_QPA_PLATFORM="offscreen"
ENV DISPLAY=":99"
ENV QTWEBENGINE_CHROMIUM_FLAGS="--no-sandbox"
ENV CALIBRE_USE_SYSTEM_THEME="0"

# 3ï¸âƒ£ ç¿»è­¯æœå‹™è¨­å®šï¼ˆé€™æ˜¯å”¯ä¸€å…è¨±é€£ç¶²çš„æœå‹™ï¼‰
ENV PDFMATHTRANSLATE_SERVICE="google"
ENV BABELDOC_SERVICE="google"

# 4ï¸âƒ£ ğŸ”’ å¼·åˆ¶é›¢ç·šæ¨¡å¼ï¼ˆç¦æ­¢æ¨¡å‹/è³‡æºä¸‹è¼‰ï¼‰
# HuggingFace å®Œå…¨é›¢ç·š
ENV HF_HOME="/nonexistent"
ENV HF_HUB_OFFLINE="1"
ENV TRANSFORMERS_OFFLINE="1"
ENV HF_DATASETS_OFFLINE="1"
ENV TRANSFORMERS_CACHE="/nonexistent"

# MinerU å¼·åˆ¶æœ¬åœ°æ¨¡å‹
ENV MINERU_MODEL_SOURCE="local"
ENV MINERU_CONFIG="/root/mineru.json"

# BabelDOC é›¢ç·šæ¨¡å¼
ENV BABELDOC_OFFLINE="1"
ENV BABELDOC_CACHE_PATH="/root/.cache/babeldoc"

# ç¦æ­¢ pip å®‰è£
ENV PIP_NO_INDEX="1"
ENV PIP_NO_CACHE_DIR="1"

# 5ï¸âƒ£ PDF ç°½ç« è¨­å®š
ENV PDF_SIGN_P12_PATH="/app/certs/default.p12"
ENV PDF_SIGN_P12_PASSWORD=""
ENV PDF_SIGN_REASON="ConvertX-CN PDF Packager"
ENV PDF_SIGN_LOCATION="Taiwan"
ENV PDF_SIGN_CONTACT="convertx-cn@localhost"

# 6ï¸âƒ£ æ‡‰ç”¨ç¨‹å¼è¨­å®š
ENV PANDOC_PDF_ENGINE=pdflatex
ENV NODE_ENV=production

# ==============================================================================
# æš´éœ²ç«¯å£ & å•Ÿå‹•
# ==============================================================================
EXPOSE 3000/tcp

ENTRYPOINT [ "bun", "run", "dist/src/index.js" ]
